Command > CRTCMOD SRCSTMF('src/noxdb2.c') MODULE(NOXDB2/noxdb2) OPTIMIZE(10) ENUM(*INT) TERASPACE(*YES) STGMDL(*INHERIT) SYSIFCOPT(*IFSIO) DBGVIEW(*ALL) TGTRLS(V7R1M0) OPTION(*EVENTF) OUTPUT(*PRINT) INCDIR('/QIBM/include' 'include' 'ext/include') <
 5770WDS V7R2M0  140418   IBM ILE C compiler      noxdb2.c                           DKSRV206    11-01-22 18:00:09 Page           1
                                                 * * * * *   P R O L O G   * * * * *
  Module  . . . . . . . . . . . . :   NOXDB2
    Library . . . . . . . . . . . :      NOXDB2
  Source stream file  . . . . . . :   src/noxdb2.c
  Text description  . . . . . . . :
  Output options:
    Output file . . . . . . . . . :   *PRINT
    Title . . . . . . . . . . . . :   *BLANK
    Subtitle  . . . . . . . . . . :   *BLANK
  Compiler options  . . . . . . . :   *NOFULL  *SHOWSRC  *NOSHOWSYS  *NOSHOWUSR  *NOSHOWINC  *NOEXPMAC
                                      *NOSECLVL  *SHOWSKP  *DIGRAPH  *NOAGR  *NOSTRUCREF  *NOXREF  *NOXREFREF
                                      *EVENTF  *LOGMSG  *NOSTDLOGMSG  *NOSYSINCPATH  *STDINC  *NOINCDIRFIRST  *GEN  *NOPPONLY
  Checkout options  . . . . . . . :   *NOCOND  *NOEFFECT  *NOGENERAL  *NOPARM  *NOPORT  *NOREACH  *NOTRUNC  *NOUNUSED
                                      *NOGOTO  *NOINIT  *NOCONST  *NOENUM  *NOPPCHECK  *NOPPTRACE  *NOEXTERN
  Optimization  . . . . . . . . . :   10
  Inline options:
    Inliner . . . . . . . . . . . :   *OFF
    Mode  . . . . . . . . . . . . :   *AUTO
    Threshold . . . . . . . . . . :   250
    Limit . . . . . . . . . . . . :   2000
    Report  . . . . . . . . . . . :   *NO
  Module creation options . . . . :   *NOKEEPILDTA
  Debugging view  . . . . . . . . :   *ALL
  Debug encryption key  . . . . . :   *NONE
  Define names  . . . . . . . . . :   *NONE
  Language level  . . . . . . . . :   *EXTENDED
  Alias . . . . . . . . . . . . . :   *ANSI
  System interface options  . . . :   *IFSIO  *NOASYNCSIGNAL
  Locale object type  . . . . . . :   *LOCALE
  Message flagging level  . . . . :   0
  Compiler messages:
    Message limit . . . . . . . . :   *NOMAX
    Message limit severity  . . . :   30
  Replace module object . . . . . :   *YES
  Authority . . . . . . . . . . . :   *LIBCRTAUT
  Target release  . . . . . . . . :   V7R1M0
  Performance collection  . . . . :   *PEP
  Performance options . . . . . . :   *SETFPCA  *NOSTRDONLY
  Profiling data  . . . . . . . . :   *NOCOL
  Teraspace options . . . . . . . :   *YES  *NOTSIFC
  Storage model . . . . . . . . . :   *INHERIT
  Data model  . . . . . . . . . . :   *P128
  Preprocessor generation options :   *NONE
  Include directory . . . . . . . :   /QIBM/include
                                      include
                                      ext/include
 5770WDS V7R2M0  140418   IBM ILE C compiler      noxdb2.c                           DKSRV206    11-01-22 18:00:09 Page           2
  Pack structure  . . . . . . . . :   *NATURAL
  Enum size . . . . . . . . . . . :   *INT
  Dependency information  . . . . :   *NONE
  Default char type . . . . . . . :   *UNSIGNED
  Compiler services option  . . . :   *BLANK
  Licensed internal code options  :   *BLANK
  Target CCSID  . . . . . . . . . :   *SOURCE
  Decimal float round mode  . . . :   *HALFEVEN
  Last change . . . . . . . . . . :   11-01-22 17:58:03
  Source description  . . . . . . :
  Compiler  . . . . . . . . . . . :   IBM ILE C compiler
                                          * * * * *   E N D   O F   P R O L O G   * * * * *
 5770WDS V7R2M0  140418   IBM ILE C compiler      noxdb2.c                           DKSRV206    11-01-22 18:00:09 Page           3
                                                 * * * * *   S O U R C E   * * * * *
  LINE  STMT                                                                                                       SEQNBR INCNO
              *...+....1....+....2....+....3....+....4....+....5....+....6....+....7....+....8....+....9........
     1       |// CMD:CRTCMOD                                                                                    |      1
     2       |/* -------------------------------------------------------------                                  |      2
     3       | * Company . . . : System & Method A/S                                                            |      3
     4       | * Design  . . . : Niels Liisberg                                                                 |      4
     5       | * Function  . . : NOX - main service program API exports                                         |      5
     6       | *                                                                                                |      6
     7       | * By     Date     Task    Description                                                            |      7
     8       | * ------ -------- ------- -------------------------------------                                  |      8
     9       | * NL     02.06.03 0000000 New program                                                            |      9
    10       | * NL     27.02.08 0000510 Allow also no namespace for *:tag                                      |     10
    11       | * NL     27.02.08 0000510 nox_NodeCopy                                                           |     11
    12       | * NL     13.05.08 0000577 nox_NodeAdd / WriteNote                                                |     12
    13       | * NL     13.05.08 0000577 Support for refference location                                        |     13
    14       | * NL     01.06.18 0001000 noxdb2 version 2 implementation                                        |     14
    15       | *                                                                                                |     15
    16       | *                                                                                                |     16
    17       | * Note differences from noxDB version 1                                                          |     17
    18       | * 1: The obect graph is all UTF-8                                                                |     18
    19       | * 2: Output is by default witout BOM codes                                                       |     19
    20       | * 3: Input and output values are default 1M in size                                              |     20
    21       | * ------------------------------------------------------------- */                               |     21
    22       |#include <stdio.h>                                                                                |     22
    23       |#include <string.h>                                                                               |     23
    24       |#include <stdlib.h>                                                                               |     24
    25       |#include <stdarg.h>                                                                               |     25
    26       |#include <ctype.h>                                                                                |     26
    27       |#include <leod.h>                                                                                 |     27
    28       |#include <decimal.h>                                                                              |     28
    29       |#include <wchar.h>                                                                                |     29
    30       |#include <errno.h>                                                                                |     30
    31       |                                                                                                  |     31
    32       |#include <sys/stat.h>                                                                             |     32
    33       |#include "ostypes.h"                                                                              |     33
    34       |#include "varchar.h"                                                                              |     34
    35       |#include "xlate.h"                                                                                |     35
    36       |#include "parms.h"                                                                                |     36
    37       |// #include "rtvsysval.h"                                                                         |     37
    38       |#include "strUtil.h"                                                                              |     38
    39       |#include "memUtil.h"                                                                              |     39
    40       |#include "streamer.h"                                                                             |     40
    41       |#include "noxdb2.h"                                                                               |     41
    42       |#include "e2aa2e.h"                                                                               |     42
    43       |                                                                                                  |     43
 5770WDS V7R2M0  140418   IBM ILE C compiler      noxdb2.c                           DKSRV206    11-01-22 18:00:09 Page           4
    44       |// Global thread vars                                                                             |     44
    45       |__thread UCHAR jxMessage[512];                                                                    |     45
    46       |__thread BOOL  jxError = false;                                                                   |     46
    47       |                                                                                                  |     47
    48       |//  BOOL  skipBlanks = TRUE;                                                                      |     48
    49       |__thread BOOL  doTrim;                                                                            |     49
    50       |__thread PNOXCOM pJxCom;                                                                          |     50
    51       |__thread BOOL   debugger = false;                                                                 |     51
    52       |__thread UCHAR  nox_DecPoint = '.';                                                               |     52
    53       |                                                                                                  |     53
    54       |// iconv_t xlateEto1208;                                                                          |     54
    55       |// iconv_t xlate1208toE;                                                                          |     55
    56       |static INT64 LVARCHARNULL =0;                                                                     |     56
    57       |static PLVARCHAR PLVARCHARNULL = (PLVARCHAR) &LVARCHARNULL;                                       |     57
    58       |                                                                                                  |     58
    59       |#pragma convert(1252)                                                                             |     59
    60       |static const PUCHAR delimiters = DELIMITERS;                                                      |     60
    61       |#pragma convert(0)                                                                                |     61
    62       |                                                                                                  |     62
    63       |                                                                                                  |     63
    64       |// ---------------------------------------------------------------------------                    |     64
    65       |void nox_SetMessage (PUCHAR Ctlstr , ... )                                                        |     65
    66       |{                                                                                                 |     66
    67       | va_list arg_ptr;                                                                                 |     67
    68     1 | if (*jxMessage > ' ') return; // Already made                                                    |     68
    69       |                                                                                                  |     69
    70       | // Build a temp string with the formated data  */                                                |     70
    71     3 | va_start(arg_ptr, Ctlstr);                                                                       |     71
    72     4 | vsprintf(jxMessage, Ctlstr, arg_ptr);                                                            |     72
    73     5 | va_end(arg_ptr);                                                                                 |     73
    74       |}                                                                                                 |     74
    75       |// ---------------------------------------------------------------------------                    |     75
    76       |void  freeNodeValue(PNOXNODE pNode)                                                               |     76
    77       |{                                                                                                 |     77
    78     1 | if (pNode->type != POINTER_VALUE) {                                                              |     78
    79     2 |  memFree(&pNode->Value );                                                                        |     79
    80       | }                                                                                                |     80
    81       |}                                                                                                 |     81
    82       |/* ------------------------------------------------------------- */                               |     82
    83       |PNOXNODE nox_traceNode (PUCHAR text, PNOXNODE pNode)                                              |     83
    84       |{                                                                                                 |     84
    85       | static int i;                                                                                    |     85
    86       | UCHAR filename [128];                                                                            |     86
    87       |                                                                                                  |     87
    88     1 | if (debugger ==0)  return pNode;                                                                 |     88
    89       |                                                                                                  |     89
 5770WDS V7R2M0  140418   IBM ILE C compiler      noxdb2.c                           DKSRV206    11-01-22 18:00:09 Page           5
    90     3 | if (debugger == 1) {                                                                             |     90
    91     4 |  sprintf(filename, "/tmp/jsonxml-%05.5d.json" , i ++);                                           |     91
    92     5 |  nox_WriteJsonStmf (pNode, filename , 1208, OFF, NULL);                                          |     92
    93     6 | } else if (debugger == 2) {                                                                      |     93
    94       |  UCHAR temp [65536];                                                                             |     94
    95     7 |  int l = nox_AsJsonTextMem (pNode , temp , sizeof(temp));                                        |     95
    96       |  // TODO!! 2 ebcdic                                                                              |     96
    97     8 |  temp [l] = 0;                                                                                   |     97
    98     9 |  puts (text);                                                                                    |     98
    99    10 |  puts (temp);                                                                                    |     99
   100    11 |  puts ("\n");                                                                                    |    100
   101       | }                                                                                                |    101
   102    12 | return pNode;                                                                                    |    102
   103       |}                                                                                                 |    103
   104       |                                                                                                  |    104
   105       |/* --------------------------------------------------------------------------- */                 |    105
   106       |void nox_SetDecPoint(PUCHAR p)                                                                    |    106
   107       |{                                                                                                 |    107
   108     1 | nox_DecPoint = *p;                                                                               |    108
   109       |}                                                                                                 |    109
   110       |/* --------------------------------------------------------------------------- */                 |    110
   111       |FIXEDDEC nox_Num (PUCHAR in)                                                                      |    111
   112       |{                                                                                                 |    112
   113     1 | FIXEDDEC        Res   = 0D;                                                                      |    113
   114     2 | decimal(17,16)  Temp  = 0D;                                                                      |    114
   115     3 | decimal(17)     Decs  = 1D;                                                                      |    115
   116     4 | BOOL  DecFound = FALSE;                                                                          |    116
   117     5 | UCHAR c = '0';                                                                                   |    117
   118     6 | int   FirstDigit = -1;                                                                           |    118
   119     7 | int   LastDigit = -1;                                                                            |    119
   120       | int   i;                                                                                         |    120
   121     8 | int   Dec=0;                                                                                     |    121
   122     9 | int   Prec=0;                                                                                    |    122
   123    10 | int   l = strlen (in);                                                                           |    123
   124       |                                                                                                  |    124
   125    11 | for (i=0; i < l ; i++) {                                                                         |    125
   126    12 |  c = in[i];                                                                                      |    126
   127    13 |  if (c >= '0' && c <= '9' ) {                                                                    |    127
   128    14 |   if (FirstDigit == -1) FirstDigit = i;                                                          |    128
   129    16 |   LastDigit = i;                                                                                 |    129
   130    17 |   if (DecFound) {                                                                                |    130
   131    18 |    if (++Prec <= 15) {                                                                           |    131
   132    19 |     Decs  *= 10D;                                                                                |    132
   133    20 |     Temp = (c - '0');                                                                            |    133
   134    21 |     Temp /= Decs;                                                                                |    134
   135    22 |     Res += Temp;                                                                                 |    135
 5770WDS V7R2M0  140418   IBM ILE C compiler      noxdb2.c                           DKSRV206    11-01-22 18:00:09 Page           6
   136       |    }                                                                                             |    136
   137       |   } else {                                                                                       |    137
   138    23 |    if (Dec < 15) {                                                                               |    138
   139    24 |     Res = Res * 10D + (c - '0');                                                                 |    139
   140    25 |     if (Res > 0D) Dec++;                                                                         |    140
   141       |    }                                                                                             |    141
   142       |   }                                                                                              |    142
   143    27 |  } else if (c == nox_DecPoint) {                                                                 |    143
   144    28 |   DecFound = TRUE;                                                                               |    144
   145       |  }                                                                                               |    145
   146       | }                                                                                                |    146
   147       | if ((FirstDigit > 0 && in[FirstDigit-1] == '-')                                                  |    147
   148    29 | ||  (LastDigit  > 0 && in[LastDigit+1]  == '-' && (LastDigit + 1) < l )) {                       |    148
   149    30 |  Res = - Res;                                                                                    |    149
   150       | }                                                                                                |    150
   151    31 | return (Res );                                                                                   |    151
   152       |}                                                                                                 |    152
   153       |/* --------------------------------------------------------------------------- */                 |    153
   154       |#pragma convert(1252)                                                                             |    154
   155       |FIXEDDEC nox_aNum (PUCHAR in)                                                                     |    155
   156       |{                                                                                                 |    156
   157     1 | FIXEDDEC        Res   = 0D;                                                                      |    157
   158     2 | decimal(17,16)  Temp  = 0D;                                                                      |    158
   159     3 | decimal(17)     Decs  = 1D;                                                                      |    159
   160     4 | BOOL  DecFound = FALSE;                                                                          |    160
   161     5 | UCHAR c = '0';                                                                                   |    161
   162     6 | int   FirstDigit = -1;                                                                           |    162
   163     7 | int   LastDigit = -1;                                                                            |    163
   164       | int   i;                                                                                         |    164
   165     8 | int   Dec=0;                                                                                     |    165
   166     9 | int   Prec=0;                                                                                    |    166
   167    10 | int   l = strlen (in);                                                                           |    167
   168       |                                                                                                  |    168
   169    11 | for (i=0; i < l ; i++) {                                                                         |    169
   170    12 |  c = in[i];                                                                                      |    170
   171    13 |  if (c >= '0' && c <= '9' ) {                                                                    |    171
   172    14 |   if (FirstDigit == -1) FirstDigit = i;                                                          |    172
   173    16 |   LastDigit = i;                                                                                 |    173
   174    17 |   if (DecFound) {                                                                                |    174
   175    18 |    if (++Prec <= 15) {                                                                           |    175
   176    19 |     Decs  *= 10D;                                                                                |    176
   177    20 |     Temp = (c - '0');                                                                            |    177
   178    21 |     Temp /= Decs;                                                                                |    178
   179    22 |     Res += Temp;                                                                                 |    179
   180       |    }                                                                                             |    180
   181       |   } else {                                                                                       |    181
 5770WDS V7R2M0  140418   IBM ILE C compiler      noxdb2.c                           DKSRV206    11-01-22 18:00:09 Page           7
   182    23 |    if (Dec < 15) {                                                                               |    182
   183    24 |     Res = Res * 10D + (c - '0');                                                                 |    183
   184    25 |     if (Res > 0D) Dec++;                                                                         |    184
   185       |    }                                                                                             |    185
   186       |   }                                                                                              |    186
   187    27 |  } else if (c == nox_DecPoint) {                                                                 |    187
   188    28 |   DecFound = TRUE;                                                                               |    188
   189       |  }                                                                                               |    189
   190       | }                                                                                                |    190
   191       | if ((FirstDigit > 0 && in[FirstDigit-1] == '-')                                                  |    191
   192    29 | ||  (LastDigit  > 0 && in[LastDigit+1]  == '-' && (LastDigit + 1) < l )) {                       |    192
   193    30 |  Res = - Res;                                                                                    |    193
   194       | }                                                                                                |    194
   195    31 | return (Res );                                                                                   |    195
   196       |}                                                                                                 |    196
   197       |#pragma convert (0)                                                                               |    197
   198       |/* --------------------------------------------------------------------------- */                 |    198
   199       |#pragma convert(1252)                                                                             |    199
   200       |static void nox_XmlDecode (PUCHAR out, PUCHAR in , ULONG inlen)                                   |    200
   201       |{                                                                                                 |    201
   202     1 | PUCHAR p = out;                                                                                  |    202
   203     2 | PUCHAR pEnd = in  + inlen;                                                                       |    203
   204       | UCHAR  c;                                                                                        |    204
   205       |                                                                                                  |    205
   206     3 | while (in < pEnd)  {                                                                             |    206
   207     4 |  c = *(in);                                                                                      |    207
   208     5 |  if (c == AMP) {                                                                                 |    208
   209     6 |   PUCHAR kwd = in+1;                                                                             |    209
   210     7 |   if       (amemiBeginsWith(kwd ,"lt;"))  { *(p++) = LT  ; in += 4; }                            |    210
   211    10 |   else if  (amemiBeginsWith(kwd ,"gt;"))  { *(p++) = GT  ; in += 4; }                            |    211
   212    13 |   else if  (amemiBeginsWith(kwd ,"amp;")) { *(p++) = AMP ; in += 5; }                            |    212
   213    16 |   else if  (amemiBeginsWith(kwd ,"apos;")){ *(p++) = APOS; in += 6; }                            |    213
   214    19 |   else if  (amemiBeginsWith(kwd ,"quot;")){ *(p++) = QUOT; in += 6; }                            |    214
   215    22 |   else if  (in[1] == HASH) {                                                                     |    215
   216    23 |    int n = 0;                                                                                    |    216
   217    24 |    in += 2; // Skip the '&#'                                                                     |    217
   218    25 |    if (*in == 'x' || *in == 'X') {   // Hexadecimal representation                               |    218
   219    26 |     in ++;                                                                                       |    219
   220    27 |     while (*in != ';') {                                                                         |    220
   221    28 |      n = 16 * n + (hex(*in));                                                                    |    221
   222    29 |      in ++;                                                                                      |    222
   223       |     }                                                                                            |    223
   224       |    } else { // Decimal representation                                                            |    224
   225    30 |     while (*in >= '0') {                                                                         |    225
   226    31 |      n = 10 * n + ((*in) - '0');                                                                 |    226
   227    32 |      in ++;                                                                                      |    227
 5770WDS V7R2M0  140418   IBM ILE C compiler      noxdb2.c                           DKSRV206    11-01-22 18:00:09 Page           8
   228       |     }                                                                                            |    228
   229       |    }                                                                                             |    229
   230    33 |    *(p++) = n;                                                                                   |    230
   231    34 |    in ++;                                                                                        |    231
   232       |   } else {                                                                                       |    232
   233    35 |    *(p++) = c;                                                                                   |    233
   234    36 |    in++;                                                                                         |    234
   235       |   }                                                                                              |    235
   236       |  } else {                                                                                        |    236
   237    37 |   *(p++) = c;                                                                                    |    237
   238    38 |   in++;                                                                                          |    238
   239       |  }                                                                                               |    239
   240       | }                                                                                                |    240
   241       |}                                                                                                 |    241
   242       |#pragma convert(0)                                                                                |    242
   243       |                                                                                                  |    243
   244       |// ---------------------------------------------------------------------------                    |    244
   245       |static void freeAttrList (PNOXATTR pAttr)                                                         |    245
   246       |{                                                                                                 |    246
   247       | PNOXATTR pAttrTemp, pAttrNext;                                                                   |    247
   248       |                                                                                                  |    248
   249     1 | for (pAttrTemp = pAttr; pAttrTemp ; pAttrTemp = pAttrNext){                                      |    249
   250     2 |  pAttrNext = pAttrTemp->pAttrSibling;                                                            |    250
   251     3 |  memFree(&pAttrTemp->Value);                                                                     |    251
   252     4 |  memFree(&pAttrTemp->Name);                                                                      |    252
   253     5 |  memFree(&pAttrTemp);                                                                            |    253
   254       | }                                                                                                |    254
   255       |}                                                                                                 |    255
   256       |// ---------------------------------------------------------------------------                    |    256
   257       |// Delete the node, with out the relations                                                        |    257
   258       |// Used in bulk cleanup                                                                           |    258
   259       |// ---------------------------------------------------------------------------                    |    259
   260       |void nox_NodeFreeNodeOnly(PNOXNODE pNode)                                                         |    260
   261       |{                                                                                                 |    261
   262       | if (pNode == NULL                                                                                |    262
   263     1 | ||  pNode->signature != NODESIG) {                                                               |    263
   264     2 |  return;                                                                                         |    264
   265       | }                                                                                                |    265
   266     3 | pNode->signature = 0; // never delete me again - even if unatended...                            |    266
   267     4 | freeNodeValue(pNode);                                                                            |    267
   268     5 | memFree(&(pNode->Name));                                                                         |    268
   269     6 | memFree(&(pNode->Comment));                                                                      |    269
   270     7 | freeAttrList (pNode->pAttrList);                                                                 |    270
   271     8 | memFree (&pNode);                                                                                |    271
   272       |}                                                                                                 |    272
   273       |// ---------------------------------------------------------------------------                    |    273
 5770WDS V7R2M0  140418   IBM ILE C compiler      noxdb2.c                           DKSRV206    11-01-22 18:00:09 Page           9
   274       |static void nox_NodeFree(PNOXNODE pNode)                                                          |    274
   275       |{                                                                                                 |    275
   276     1 | nox_NodeFreeNodeOnly(pNode);                                                                     |    276
   277       |}                                                                                                 |    277
   278       |// ---------------------------------------------------------------------------                    |    278
   279       |void nox_NodeRename(PNOXNODE pNode, PUCHAR name)                                                  |    279
   280       |{                                                                                                 |    280
   281     1 | if (pNode == NULL) return;                                                                       |    281
   282       |                                                                                                  |    282
   283     3 | memFree(&pNode->Name);                                                                           |    283
   284     4 | pNode->Name = memStrDup(name);                                                                   |    284
   285       |}                                                                                                 |    285
   286       |// ---------------------------------------------------------------------------                    |    286
   287       |void nox_NodeRenameVC(PNOXNODE pNode, PLVARCHAR name)                                             |    287
   288       |{                                                                                                 |    288
   289     1 | nox_NodeRename(pNode, plvc2str(name));                                                           |    289
   290       |}                                                                                                 |    290
   291       |                                                                                                  |    291
   292       |// ---------------------------------------------------------------------------                    |    292
   293       |PUCHAR nodevalue  (PNOXNODE p)                                                                    |    293
   294       |{                                                                                                 |    294
   295     1 | if (p == NULL || p->Value == NULL) return "";                                                    |    295
   296     3 | return p->Value;                                                                                 |    296
   297       |}                                                                                                 |    297
   298       |// ---------------------------------------------------------------------------                    |    298
   299       |int doubleCmp (double x, double y)                                                                |    299
   300       |{                                                                                                 |    300
   301     1 | if (x < y) return -1;                                                                            |    301
   302     3 | if (x > y) return  1;                                                                            |    302
   303     5 | return 0;                                                                                        |    303
   304       |}                                                                                                 |    304
   305       |// ---------------------------------------------------------------------------                    |    305
   306       |double num2float(PUCHAR s)                                                                        |    306
   307       |{                                                                                                 |    307
   308     1 | return nox_aNum(s);                                                                              |    308
   309       |}                                                                                                 |    309
   310       |// ---------------------------------------------------------------------------                    |    310
   311       |#pragma convert(1252)                                                                             |    311
   312       |BOOL isNumberNodeStrict (PNOXNODE node)                                                           |    312
   313       |{                                                                                                 |    313
   314       | UCHAR c;                                                                                         |    314
   315       | PUCHAR p;                                                                                        |    315
   316       |                                                                                                  |    316
   317       | if (node == NULL                                                                                 |    317
   318       | ||  node->isLiteral == false                                                                     |    318
   319     1 | ||  node->Value == NULL) {                                                                       |    319
 5770WDS V7R2M0  140418   IBM ILE C compiler      noxdb2.c                           DKSRV206    11-01-22 18:00:09 Page          10
   320     2 |  return false;                                                                                   |    320
   321       | }                                                                                                |    321
   322     3 | c = *node->Value;                                                                                |    322
   323     4 | return ((c >= '0' && c <= '9') || c == '-');                                                     |    323
   324       |}                                                                                                 |    324
   325       |#pragma convert(0)                                                                                |    325
   326       |// ---------------------------------------------------------------------------                    |    326
   327       |#pragma convert(1252)                                                                             |    327
   328       |BOOL isNumberNodeLoose  (PNOXNODE node)                                                           |    328
   329       |{                                                                                                 |    329
   330       | UCHAR c;                                                                                         |    330
   331       | PUCHAR p;                                                                                        |    331
   332       |                                                                                                  |    332
   333       | if (node == NULL                                                                                 |    333
   334     1 | ||  node->Value == NULL) {                                                                       |    334
   335     2 |  return false;                                                                                   |    335
   336       | }                                                                                                |    336
   337     3 | p = node->Value;                                                                                 |    337
   338     4 | for (;*p == ' ' ; p++); // Skip leading blanks                                                   |    338
   339     6 | c = *p;                                                                                          |    339
   340     7 | return ((c >= '0' && c <= '9') || c == '-');                                                     |    340
   341       |}                                                                                                 |    341
   342       |#pragma convert(0)                                                                                |    342
   343       |// ---------------------------------------------------------------------------                    |    343
   344       |LGL nox_IsLiteral (PNOXNODE node)                                                                 |    344
   345       |{                                                                                                 |    345
   346       | BOOL isString = (                                                                                |    346
   347       |   node                                                                                           |    347
   348       |   &&  node->isLiteral == false                                                                   |    348
   349       |   &&  node->Value                                                                                |    349
   350     1 | );                                                                                               |    350
   351     2 | return isString ?  OFF:ON ;                                                                      |    351
   352       |}                                                                                                 |    352
   353       |// ---------------------------------------------------------------------------                    |    353
   354       |// use simple bouble-sort to sort an array by keyvalues                                           |    354
   355       |// ---------------------------------------------------------------------------                    |    355
   356       |#pragma convert(1252)                                                                             |    356
   357       |PNOXNODE nox_ArraySort(PNOXNODE pNode, PUCHAR fields, BOOL useLocale)                             |    357
   358       |{                                                                                                 |    358
   359       | PNOXNODE pNodeNext, pNode1, pNode2, pCompNode1, pCompNode2 ;                                     |    359
   360       | BOOL    bubles;                                                                                  |    360
   361       | UCHAR   keys [256][256];                                                                         |    361
   362       | BOOL    descending [256];                                                                        |    362
   363       | int     kix, kx, comp ;                                                                          |    363
   364       |                                                                                                  |    364
   365       | // Set function pointers for callback                                                            |    365
 5770WDS V7R2M0  140418   IBM ILE C compiler      noxdb2.c                           DKSRV206    11-01-22 18:00:09 Page          11
   366       | //double (* getnumberval)(PUCHAR s)  =  useLocale ? num2float   : num2floatLocale;               |    366
   367     1 | double (* getnumberval)(PUCHAR s)  =  num2float ;                                                |    367
   368     2 | BOOL   (* isNumberNode)(PNOXNODE n) =  useLocale ? isNumberNodeLoose : isNumberNodeStrict;       |    368
   369       |                                                                                                  |    369
   370       | // if (pNode == NULL || pNode->type != ARRAY) return;                                            |    370
   371       |                                                                                                  |    371
   372       | // Lets allow to sourt anuthing ( XML will work too then)                                        |    372
   373     3 | if (pNode == NULL) return;                                                                       |    373
   374       |                                                                                                  |    374
   375       | // Split the list into array elements                                                            |    375
   376       | // handle the following syntax:                                                                  |    376
   377       | //    key1:ASC,key2:DESC,key3,key:desc                                                           |    377
   378     5 | for(kix=0 ; kix < 256 ; kix ++) {                                                                |    378
   379       |  UCHAR key [256];                                                                                |    379
   380       |  UCHAR descStr  [256];                                                                           |    380
   381     6 |  if (*subword(key, fields, kix , ",") == '\0') break;                                            |    381
   382     8 |  subword(keys[kix], key, 0 , ":");                                                               |    382
   383     9 |  subword(descStr  , key, 1 , ":");                                                               |    383
   384    10 |  descending[kix] = amemiBeginsWith(descStr , "desc");                                            |    384
   385       | }                                                                                                |    385
   386       |                                                                                                  |    386
   387    11 | do {                                                                                             |    387
   388    12 |  bubles = false;                                                                                 |    388
   389    13 |  pNode1  = pNode->pNodeChildHead;                                                                |    389
   390    14 |  if (pNode1 == NULL ) return;                                                                    |    390
   391    16 |  pNode2  = pNode1->pNodeSibling;                                                                 |    391
   392       |                                                                                                  |    392
   393    17 |  while (pNode2) {                                                                                |    393
   394    18 |   for(kx = 0; kx < kix ; kx++)  {                                                                |    394
   395       |    PUCHAR v1, v2;                                                                                |    395
   396    19 |    pCompNode1 = nox_GetNode  (pNode1 ,keys[kx]);                                                 |    396
   397    20 |    pCompNode2 = nox_GetNode  (pNode2 ,keys[kx]);                                                 |    397
   398    21 |    v1 = nodevalue(pCompNode1);                                                                   |    398
   399    22 |    v2 = nodevalue(pCompNode2);                                                                   |    399
   400       |                                                                                                  |    400
   401    23 |    if (isNumberNode(pCompNode1) && isNumberNode(pCompNode2)) {                                   |    401
   402    24 |     comp = doubleCmp (getnumberval(v1) , getnumberval (v2));                                     |    402
   403       |    } else {                                                                                      |    403
   404    25 |     comp = strcmp (v1, v2);                                                                      |    404
   405       |    }                                                                                             |    405
   406       |                                                                                                  |    406
   407    26 |    if (descending[kx]) {                                                                         |    407
   408    27 |     comp = - comp;                                                                               |    408
   409       |    }                                                                                             |    409
   410       |                                                                                                  |    410
   411    28 |    switch (comp) {                                                                               |    411
 5770WDS V7R2M0  140418   IBM ILE C compiler      noxdb2.c                           DKSRV206    11-01-22 18:00:09 Page          12
   412    29 |     case 0: break;                                                                               |    412
   413       |     case 1: {                                                                                    |    413
   414    30 |      bubles = true;                                                                              |    414
   415    31 |      nox_SwapNodes(&pNode1, &pNode2);                                                            |    415
   416    32 |      kx = kix; // done                                                                           |    416
   417    33 |      break;                                                                                      |    417
   418       |     }                                                                                            |    418
   419       |     case -1:{                                                                                    |    419
   420    34 |      kx = kix; // done                                                                           |    420
   421    35 |      break;                                                                                      |    421
   422       |     }                                                                                            |    422
   423       |    }                                                                                             |    423
   424       |   }                                                                                              |    424
   425       |   // Setup next;                                                                                 |    425
   426    36 |   pNode1 = pNode1->pNodeSibling;                                                                 |    426
   427    37 |   pNode2 = pNode2->pNodeSibling;                                                                 |    427
   428       |  }                                                                                               |    428
   429    38 | } while(bubles);                                                                                 |    429
   430       |                                                                                                  |    430
   431    39 | return pNode;                                                                                    |    431
   432       |}                                                                                                 |    432
   433       |#pragma convert(0)                                                                                |    433
   434       |                                                                                                  |    434
   435       |PNOXNODE nox_ArraySortVC(PNOXNODE pNode, PLVARCHAR fieldsP, USHORT optionsP)                      |    435
   436       |{                                                                                                 |    436
   437     1 | PNPMPARMLISTADDRP pParms = _NPMPARMLISTADDR();                                                   |    437
   438     2 | PUCHAR  fields = (pParms->OpDescList->NbrOfParms >= 2) ? plvc2str(fieldsP) : "";                 |    438
   439     3 | BOOL    useLocale =  (pParms->OpDescList->NbrOfParms >= 3) ? optionsP & 1: false;                |    439
   440       |                                                                                                  |    440
   441     4 | return nox_ArraySort(pNode, fields, useLocale);                                                  |    441
   442       |}                                                                                                 |    442
   443       |// ---------------------------------------------------------------------------                    |    443
   444       |void nox_FreeSiblings(PNOXNODE pNode)                                                             |    444
   445       |{                                                                                                 |    445
   446       | PNOXNODE pNodeNext;                                                                              |    446
   447       |                                                                                                  |    447
   448     1 | while (pNode) {                                                                                  |    448
   449     2 |  pNodeNext=pNode->pNodeSibling;                                                                  |    449
   450     3 |  nox_FreeChildren (pNode);                                                                       |    450
   451     4 |  nox_NodeFree(pNode);                                                                            |    451
   452     5 |  pNode=pNodeNext;                                                                                |    452
   453       | }                                                                                                |    453
   454       |}                                                                                                 |    454
   455       |// -------------------------------------------------------------                                  |    455
   456       |void nox_FreeChildren (PNOXNODE pNode)                                                            |    456
   457       |{                                                                                                 |    457
 5770WDS V7R2M0  140418   IBM ILE C compiler      noxdb2.c                           DKSRV206    11-01-22 18:00:09 Page          13
   458     1 | nox_FreeSiblings(pNode->pNodeChildHead);                                                         |    458
   459     2 | pNode->pNodeChildHead = NULL;                                                                    |    459
   460     3 | pNode->pNodeChildTail = NULL;                                                                    |    460
   461     4 | pNode->Count = 0;                                                                                |    461
   462       |}                                                                                                 |    462
   463       |// -------------------------------------------------------------                                  |    463
   464       |void nox_DumpNodeList (PNOXNODE pNodeTemp)                                                        |    464
   465       |{                                                                                                 |    465
   466       | PNOXNODE  pNodeNext;                                                                             |    466
   467       | PNOXATTR pAttrTemp;                                                                              |    467
   468       |                                                                                                  |    468
   469     1 | while (pNodeTemp) {                                                                              |    469
   470       |  PNOXNODE p;                                                                                     |    470
   471     2 |  PUCHAR in ="";                                                                                  |    471
   472     3 |  printf("\n");                                                                                   |    472
   473       |                                                                                                  |    473
   474     4 |  for (p=pNodeTemp; p && p->pNodeParent ; p=p->pNodeParent) {                                     |    474
   475     5 |   if (p->Name && * p->Name) {                                                                    |    475
   476     6 |    printf("%s%s (line:%d)" , in , p->Name , p->lineNo);                                          |    476
   477       |   } else {                                                                                       |    477
   478     7 |    printf("%s%i" , in , p->Handle);                                                              |    478
   479       |   }                                                                                              |    479
   480       |                                                                                                  |    480
   481     8 |   in = " in ";                                                                                   |    481
   482       |  }                                                                                               |    482
   483       |                                                                                                  |    483
   484     9 |  printf("\n   Value: %s" , pNodeTemp->Value == NULL ? "(null)" : pNodeTemp->Value);              |    484
   485       |                                                                                                  |    485
   486    10 |  for (pAttrTemp = pNodeTemp->pAttrList; pAttrTemp ; pAttrTemp = pAttrTemp->pAttrSibling){        |    486
   487       |   printf("\n   Attribute: %s = %s" ,                                                             |    487
   488       |    pAttrTemp->Name == NULL ? "" : pAttrTemp->Name,                                               |    488
   489    11 |    pAttrTemp->Value== NULL ? "" : pAttrTemp->Value);                                             |    489
   490       |  }                                                                                               |    490
   491    12 |  nox_DumpNodeList(pNodeTemp->pNodeChildHead);                                                    |    491
   492    13 |  pNodeTemp = pNodeTemp->pNodeSibling;                                                            |    492
   493       | }                                                                                                |    493
   494       |}                                                                                                 |    494
   495       |// -------------------------------------------------------------                                  |    495
   496       |static ULONG sumString (PUCHAR p)                                                                 |    496
   497       |{                                                                                                 |    497
   498     1 | ULONG sum = 0;                                                                                   |    498
   499     2 | if (p == NULL) return 0;                                                                         |    499
   500     4 | while (*p) {                                                                                     |    500
   501     5 |  sum += *(p++);                                                                                  |    501
   502       | }                                                                                                |    502
   503     6 | return sum;                                                                                      |    503
 5770WDS V7R2M0  140418   IBM ILE C compiler      noxdb2.c                           DKSRV206    11-01-22 18:00:09 Page          14
   504       |}                                                                                                 |    504
   505       |// -------------------------------------------------------------                                  |    505
   506       |ULONG nox_NodeCheckSum (PNOXNODE pNode)                                                           |    506
   507       |{                                                                                                 |    507
   508       | PNOXNODE  pNodeNext;                                                                             |    508
   509       | PNOXATTR pAttrTemp;                                                                              |    509
   510     1 | ULONG    sum =0;                                                                                 |    510
   511       |                                                                                                  |    511
   512     2 | while (pNode) {                                                                                  |    512
   513       |                                                                                                  |    513
   514     3 |  sum += sumString (pNode->Name);                                                                 |    514
   515     4 |  sum += sumString (pNode->Value);                                                                |    515
   516       |                                                                                                  |    516
   517     5 |  for (pAttrTemp = pNode->pAttrList; pAttrTemp ; pAttrTemp = pAttrTemp->pAttrSibling){            |    517
   518     6 |   sum += sumString (pAttrTemp->Name);                                                            |    518
   519     7 |   sum += sumString (pAttrTemp->Value);                                                           |    519
   520       |  }                                                                                               |    520
   521     8 |  sum += nox_NodeCheckSum (pNode->pNodeChildHead);                                                |    521
   522     9 |  pNode = pNode->pNodeSibling;                                                                    |    522
   523       | }                                                                                                |    523
   524    10 | return sum;                                                                                      |    524
   525       |}                                                                                                 |    525
   526       |// ---------------------------------------------------------------------------                    |    526
   527       |#pragma convert(1252)                                                                             |    527
   528       |void nox_WriteXmlStmfNodeList (FILE * f, iconv_t * pIconv ,PNOXNODE pNode)                        |    528
   529       |{                                                                                                 |    529
   530       | PNOXNODE  pNodeTemp, pNodeNext;                                                                  |    530
   531       | PNOXATTR pAttrTemp;                                                                              |    531
   532       | static int level = 0;                                                                            |    532
   533       | UCHAR    tab[256];                                                                               |    533
   534       | BOOL     shortform;                                                                              |    534
   535       |                                                                                                  |    535
   536       |#pragma convert(0)                                                                                |    536
   537     1 | PUCHAR  defaultNode = "row";                                                                     |    537
   538       |#pragma convert(1252)                                                                             |    538
   539       |                                                                                                  |    539
   540     2 | if ( pNode == NULL) return;                                                                      |    540
   541       |                                                                                                  |    541
   542       | //' Make indention                                                                               |    542
   543     4 | tab [0] = 0x0d;                                                                                  |    543
   544     5 | tab [1] = 0x0a;                                                                                  |    544
   545     6 | memset(tab+2, 0x20 ,level*2);                                                                    |    545
   546     7 | tab [2 + (level*2)] = '\0';                                                                      |    546
   547       |                                                                                                  |    547
   548     8 | level++;                                                                                         |    548
   549       |                                                                                                  |    549
 5770WDS V7R2M0  140418   IBM ILE C compiler      noxdb2.c                           DKSRV206    11-01-22 18:00:09 Page          15
   550     9 | while (pNode) {                                                                                  |    550
   551       |                                                                                                  |    551
   552    10 |  if (pNode->Comment) {                                                                           |    552
   553    11 |   if (!doTrim)  fputs ( tab,  f);                                                                |    553
   554    13 |   fputs ( "<!--",  f);                                                                           |    554
   555    14 |   iconvWrite(f,pIconv, pNode->Comment, FALSE);                                                   |    555
   556    15 |   fputs ( "-->",  f);                                                                            |    556
   557       |  }                                                                                               |    557
   558       |                                                                                                  |    558
   559    16 |  if (!doTrim)  fputs ( tab,  f);                                                                 |    559
   560    18 |  fputs ("<", f);                                                                                 |    560
   561    19 |  iconvWrite(f,pIconv, pNode->Name ? pNode->Name: defaultNode, FALSE);                            |    561
   562       |                                                                                                  |    562
   563    20 |  for (pAttrTemp = pNode->pAttrList; pAttrTemp ; pAttrTemp = pAttrTemp->pAttrSibling){            |    563
   564    21 |   if (pNode->newlineInAttrList) {                                                                |    564
   565    22 |    if (!doTrim)  fputs ( tab,  f);                                                               |    565
   566    24 |    fputs ("  ", f);                                                                              |    566
   567       |   } else {                                                                                       |    567
   568    25 |    fputc( 0x20 , f);                                                                             |    568
   569       |   }                                                                                              |    569
   570    26 |   iconvWrite( f,pIconv, pAttrTemp->Name, FALSE);                                                 |    570
   571    27 |   fputs("=\"" , f);                                                                              |    571
   572    28 |   iconvWrite( f,pIconv, pAttrTemp->Value, TRUE);                                                 |    572
   573    29 |   fputs("\"", f);                                                                                |    573
   574       |  }                                                                                               |    574
   575       |                                                                                                  |    575
   576    30 |  shortform = TRUE;                                                                               |    576
   577       |                                                                                                  |    577
   578    31 |  if (pNode->Value != NULL && pNode->Value[0] > '\0') {                                           |    578
   579    32 |   shortform = FALSE;                                                                             |    579
   580    33 |   fputs(">", f);                                                                                 |    580
   581    34 |   iconvWrite( f,pIconv, pNode->Value, TRUE);                                                     |    581
   582       |  }                                                                                               |    582
   583       |                                                                                                  |    583
   584    35 |  if (pNode->pNodeChildHead) {                                                                    |    584
   585    36 |   shortform = FALSE;                                                                             |    585
   586    37 |   if (pNode->Value != NULL && pNode->Value[0] > '\0') {                                          |    586
   587       |   // Already put - in the above                                                                  |    587
   588       |   } else {                                                                                       |    588
   589    38 |    fputs(">", f);                                                                                |    589
   590       |   }                                                                                              |    590
   591    39 |   nox_WriteXmlStmfNodeList (f, pIconv, pNode->pNodeChildHead);                                   |    591
   592       |  }                                                                                               |    592
   593       |                                                                                                  |    593
   594    40 |  if (shortform) {                                                                                |    594
   595    41 |   if (pNode->newlineInAttrList) {                                                                |    595
 5770WDS V7R2M0  140418   IBM ILE C compiler      noxdb2.c                           DKSRV206    11-01-22 18:00:09 Page          16
   596    42 |    if (!doTrim)  fputs ( tab,  f);                                                               |    596
   597       |   }                                                                                              |    597
   598    44 |   fputs("/>", f);                                                                                |    598
   599       |  } else {                                                                                        |    599
   600    45 |   if (pNode->pNodeChildHead) {                                                                   |    600
   601    46 |    if (!doTrim)  fputs ( tab,  f);                                                               |    601
   602       |   }                                                                                              |    602
   603    48 |   fputs("</" , f);                                                                               |    603
   604    49 |   iconvWrite( f,pIconv, pNode->Name ? pNode->Name : defaultNode , FALSE);                        |    604
   605    50 |   fputs(">", f);                                                                                 |    605
   606       |  }                                                                                               |    606
   607       |                                                                                                  |    607
   608    51 |  if (level == 1) {                                                                               |    608
   609    52 |   pNode = NULL;                                                                                  |    609
   610       |  } else {                                                                                        |    610
   611    53 |   pNode = pNode->pNodeSibling;                                                                   |    611
   612       |  }                                                                                               |    612
   613       | }                                                                                                |    613
   614       |                                                                                                  |    614
   615    54 | level --;                                                                                        |    615
   616       |}                                                                                                 |    616
   617       |#pragma convert(0)                                                                                |    617
   618       |// ---------------------------------------------------------------------------                    |    618
   619       |LONG nox_AsXmlTextMem (PNOXNODE pNode, PUCHAR buf)                                                |    619
   620       |{                                                                                                 |    620
   621       | PNOXNODE    pNodeTemp, pNodeNext;                                                                |    621
   622       | PNOXATTR   pAttrTemp;                                                                            |    622
   623       | static int level = 0;                                                                            |    623
   624       | BOOL       shortform;                                                                            |    624
   625     1 | PUCHAR     temp = buf;                                                                           |    625
   626       |                                                                                                  |    626
   627     2 | level++;                                                                                         |    627
   628       |                                                                                                  |    628
   629     3 | while (pNode) {                                                                                  |    629
   630       |                                                                                                  |    630
   631     4 |  temp +=  sprintf(temp , "<%s", pNode->Name ? pNode->Name : "row");                              |    631
   632     5 |  for (pAttrTemp = pNode->pAttrList; pAttrTemp ; pAttrTemp = pAttrTemp->pAttrSibling){            |    632
   633     6 |   temp +=  sprintf(temp , " %s=\"%s\"", pAttrTemp->Name, pAttrTemp->Value);                      |    633
   634       |  }                                                                                               |    634
   635       |                                                                                                  |    635
   636     7 |  shortform = TRUE;                                                                               |    636
   637       |                                                                                                  |    637
   638     8 |  if (pNode->Value != NULL && pNode->Value[0] > '\0') {                                           |    638
   639     9 |   shortform = FALSE;                                                                             |    639
   640    10 |   temp +=  sprintf(temp , ">%s", pNode->Value);                                                  |    640
   641       |  }                                                                                               |    641
 5770WDS V7R2M0  140418   IBM ILE C compiler      noxdb2.c                           DKSRV206    11-01-22 18:00:09 Page          17
   642       |                                                                                                  |    642
   643    11 |  if (pNode->pNodeChildHead) {                                                                    |    643
   644    12 |   shortform = FALSE;                                                                             |    644
   645    13 |   if (pNode->Value != NULL && pNode->Value[0] > '\0') {                                          |    645
   646       |    // Already put - in the above                                                                 |    646
   647       |   } else {                                                                                       |    647
   648    14 |    temp +=  sprintf(temp , ">");                                                                 |    648
   649       |   }                                                                                              |    649
   650    15 |   temp += nox_AsXmlTextMem (pNode->pNodeChildHead , temp);                                       |    650
   651       |  }                                                                                               |    651
   652       |                                                                                                  |    652
   653    16 |  if (shortform) {                                                                                |    653
   654    17 |   temp +=  sprintf(temp , "/>");                                                                 |    654
   655       |  } else {                                                                                        |    655
   656    18 |   temp +=  sprintf(temp , "</%s>", pNode->Name ? pNode->Name : "row");                           |    656
   657       |  }                                                                                               |    657
   658       |                                                                                                  |    658
   659    19 |  if (level == 1) {                                                                               |    659
   660    20 |   pNode = NULL;                                                                                  |    660
   661       |  } else {                                                                                        |    661
   662    21 |   pNode = pNode->pNodeSibling;                                                                   |    662
   663       |  }                                                                                               |    663
   664       | }                                                                                                |    664
   665       |                                                                                                  |    665
   666    22 | level --;                                                                                        |    666
   667    23 | return temp - buf;                                                                               |    667
   668       |                                                                                                  |    668
   669       |}                                                                                                 |    669
   670       |// ---------------------------------------------------------------------------                    |    670
   671       |VOID nox_AsXmlText (PLVARCHAR res , PNOXNODE pNode)                                               |    671
   672       |{                                                                                                 |    672
   673     1 | res->Length = nox_AsXmlTextMem (pNode , res->String);                                            |    673
   674       |}                                                                                                 |    674
   675       |// ---------------------------------------------------------------------------                    |    675
   676       |// Traverse up the tree and build the name  like: "root/tree/node"                                |    676
   677       |// ---------------------------------------------------------------------------                    |    677
   678       |VARCHAR nox_GetNodeNameAsPath (PNOXNODE pNode, UCHAR Delimiter)                                   |    678
   679       |{                                                                                                 |    679
   680       | PNOXNODE  p;                                                                                     |    680
   681       | VARCHAR  res;                                                                                    |    681
   682       | UCHAR    buf  [4096];                                                                            |    682
   683       | PUCHAR   pBuf, pBufEnd;                                                                          |    683
   684     1 | int len , i =0;                                                                                  |    684
   685       |                                                                                                  |    685
   686     2 | res.Length = 0;                                                                                  |    686
   687     3 | if ( pNode == NULL) return res;                                                                  |    687
 5770WDS V7R2M0  140418   IBM ILE C compiler      noxdb2.c                           DKSRV206    11-01-22 18:00:09 Page          18
   688     5 | pBuf = pBufEnd = buf + sizeof(buf) -1;                                                           |    688
   689       |                                                                                                  |    689
   690     6 | p = pNode;                                                                                       |    690
   691     7 | while (p) {                                                                                      |    691
   692       |                                                                                                  |    692
   693     8 |  if (p->Name  &&  *p->Name > ' ') {                                                              |    693
   694     9 |   if (i++) {                                                                                     |    694
   695    10 |    pBuf --;                                                                                      |    695
   696    11 |    *pBuf = Delimiter;                                                                            |    696
   697       |   }                                                                                              |    697
   698       |                                                                                                  |    698
   699    12 |   len = memSize(p->Name)  -1; // with out the zero term ;                                        |    699
   700    13 |   pBuf -= len ;                                                                                  |    700
   701    14 |   memcpy(pBuf,p->Name, len);                                                                     |    701
   702       |  }                                                                                               |    702
   703    15 |  p = p->pNodeParent;                                                                             |    703
   704       | }                                                                                                |    704
   705       |                                                                                                  |    705
   706    16 | res.Length = pBufEnd - pBuf;                                                                     |    706
   707    17 | substr(res.String , pBuf , res.Length );                                                         |    707
   708    18 | return res;                                                                                      |    708
   709       |}                                                                                                 |    709
   710       |/* --------------------------------------------------------------------------- */                 |    710
   711       |SHORT nox_GetNodeType (PNOXNODE pNode)                                                            |    711
   712       |{                                                                                                 |    712
   713     1 | return (pNode) ? pNode->type : 0;                                                                |    713
   714       |}                                                                                                 |    714
   715       |// ---------------------------------------------------------------------------                    |    715
   716       |void nox_NodeCloneAndReplace (PNOXNODE pDest , PNOXNODE pSource)                                  |    716
   717       |{                                                                                                 |    717
   718     1 | PNOXNODE  pNewNode = nox_NodeClone (pSource);                                                    |    718
   719     2 | nox_NodeMoveAndReplace (pDest, pNewNode);                                                        |    719
   720       |}                                                                                                 |    720
   721       |// ---------------------------------------------------------------------------                    |    721
   722       |//  This works great, have to go back and update the "cloneFormat" logic to do similar            |    722
   723       |// ---------------------------------------------------------------------------                    |    723
   724       |#pragma convert(1252)                                                                             |    724
   725       |void  nox_MergeList (PNOXNODE pDest, PNOXNODE pSource, PJWRITE pjWrite, PUCHAR name, PNOXNODE pPa\|    725
   725       |rent, MERGEOPTION merge)                                                                          |    725
   726       |{                                                                                                 |    726
   727       | PNOXNODE  p;                                                                                     |    727
   728       | UCHAR tempname[256];                                                                             |    728
   729       | PNOXNODE pDestNode , pEdt ;                                                                      |    729
   730     1 | int ix =0;                                                                                       |    730
   731       |                                                                                                  |    731
   732     2 | while (pSource) {                                                                                |    732
 5770WDS V7R2M0  140418   IBM ILE C compiler      noxdb2.c                           DKSRV206    11-01-22 18:00:09 Page          19
   733       |                                                                                                  |    733
   734     3 |  if (pParent && pParent->type == ARRAY) {                                                        |    734
   735     4 |   sprintf(tempname,"%s[%d]", name , ix++  );                                                     |    735
   736     5 |  } else if (pSource->Name && *pSource->Name){                                                    |    736
   737     6 |   sprintf(tempname,"%s/%s", name , pSource->Name);                                               |    737
   738       |  } else {                                                                                        |    738
   739     7 |   strcpy (tempname,name );                                                                       |    739
   740       |  }                                                                                               |    740
   741       |                                                                                                  |    741
   742     8 |  if (pSource->type == VALUE) {                                                                   |    742
   743     9 |   PUCHAR relName = tempname+1; // Remove first slash absolut and make it relative                |    743
   744       |   // printf("\n%s - %s : %d val:%s\n" , tempname , pSource->Name, pjWrite->level,pSource->Value);|    744
   745       |                                                                                                  |    745
   746    10 |   pDestNode = nox_GetNode  (pDest, relName);                                                     |    746
   747    11 |   if (pDestNode != NULL) {                                                                       |    747
   748    12 |    if (merge == MO_MERGE_REPLACE || merge == MO_MERGE_MATCH) {                                   |    748
   749    13 |     nox_NodeSet(pDestNode , pSource->Value);                                                     |    749
   750       |    }                                                                                             |    750
   751       |   } else {                                                                                       |    751
   752    14 |    if (merge == MO_MERGE_REPLACE || merge == MO_MERGE_NEW ) {                                    |    752
   753    15 |     pEdt = nox_SetValueByName  (pDest , relName, pSource->Value, pSource->type);                 |    753
   754    16 |     pEdt->isLiteral = pSource->isLiteral;                                                        |    754
   755       |    }                                                                                             |    755
   756       |   }                                                                                              |    756
   757       |  }                                                                                               |    757
   758       |                                                                                                  |    758
   759    17 |  if (pSource->pNodeChildHead) {                                                                  |    759
   760    18 |   pjWrite->level ++;                                                                             |    760
   761    19 |   nox_MergeList (pDest , pSource->pNodeChildHead,pjWrite, tempname , pSource, merge  );          |    761
   762    20 |   pjWrite->level --;                                                                             |    762
   763       |  }                                                                                               |    763
   764       |  // Merging only take the first occurent where the object object names has a match               |    764
   765       |  // pSource = (pjWrite->level == 0) ? NULL: pSource->pNodeSibling;                               |    765
   766    21 |  pSource = pSource->pNodeSibling;                                                                |    766
   767       | }                                                                                                |    767
   768       |}                                                                                                 |    768
   769       |#pragma convert(0)                                                                                |    769
   770       |/* --------------------------------------------------------------------------- */                 |    770
   771       |PNOXNODE  nox_InsertByName (PNOXNODE pDest , PUCHAR name , PNOXNODE pSource )                     |    771
   772       |{                                                                                                 |    772
   773       | PNOXNODE pNode;                                                                                  |    773
   774       |                                                                                                  |    774
   775     1 | if ( pSource->type == OBJECT || pSource->type == ARRAY ) {                                       |    775
   776     2 |  pNode  =  nox_NodeCopy (pDest, pSource , RL_LAST_CHILD);                                        |    776
   777     3 |  pNode->Name = memStrDup(name);                                                                  |    777
   778       | } else {                                                                                         |    778
 5770WDS V7R2M0  140418   IBM ILE C compiler      noxdb2.c                           DKSRV206    11-01-22 18:00:09 Page          20
   779     4 |  pNode  = nox_SetValueByName  (pDest , name , pSource->Value , pSource->type);                   |    779
   780     5 |  pNode->isLiteral = pSource->isLiteral;                                                          |    780
   781       | }                                                                                                |    781
   782     6 | return pNode;                                                                                    |    782
   783       |}                                                                                                 |    783
   784       |/* --------------------------------------------------------------------------- */                 |    784
   785       |PNOXNODE  nox_InsertByNameVC (PNOXNODE pDest , PLVARCHAR name , PNOXNODE pSource )                |    785
   786       |{                                                                                                 |    786
   787     1 | return nox_InsertByName (pDest , plvc2str(name), pSource );                                      |    787
   788       |}                                                                                                 |    788
   789       |/* --------------------------------------------------------------------------- */                 |    789
   790       |PNOXNODE  nox_CopyValue (PNOXNODE pDest , PUCHAR destName , PNOXNODE pSource , PUCHAR sourceName) |    790
   791       |{                                                                                                 |    791
   792       | PNOXNODE pRes;                                                                                   |    792
   793     1 | PNPMPARMLISTADDRP pParms = _NPMPARMLISTADDR();                                                   |    793
   794     2 | PUCHAR pSourceName = pParms->OpDescList->NbrOfParms >= 3 ? sourceName : "";                      |    794
   795       |                                                                                                  |    795
   796       |                                                                                                  |    796
   797     3 | pSource = nox_GetNode  (pSource  , pSourceName );                                                |    797
   798     4 | if (pSource == NULL) return NULL;                                                                |    798
   799       |                                                                                                  |    799
   800     6 | pDest = nox_GetOrCreateNode (pDest, destName);                                                   |    800
   801     7 | if (pDest  == NULL) return NULL;                                                                 |    801
   802       |                                                                                                  |    802
   803     9 | if ( pSource->type == OBJECT || pSource->type == ARRAY ) {                                       |    803
   804    10 |  nox_NodeCloneAndReplace (pDest  , pSource);                                                     |    804
   805       |                                                                                                  |    805
   806       | } else {                                                                                         |    806
   807    11 |  nox_NodeSet (pDest ,pSource->Value);                                                            |    807
   808    12 |  pDest->isLiteral = pSource->isLiteral;                                                          |    808
   809       | }                                                                                                |    809
   810       |                                                                                                  |    810
   811    13 | return pDest ;                                                                                   |    811
   812       |}                                                                                                 |    812
   813       |/* --------------------------------------------------------------------------- */                 |    813
   814       |PNOXNODE  nox_CopyValueVC (PNOXNODE pDest , PLVARCHAR destName , PNOXNODE pSource , PLVARCHAR sou\|    814
   814       |rceName)                                                                                          |    814
   815       |{                                                                                                 |    815
   816     1 | return nox_CopyValue (pDest , plvc2str(destName) , pSource , plvc2str(sourceName));              |    816
   817       |}                                                                                                 |    817
   818       |/* --------------------------------------------------------------------------- */                 |    818
   819       |static void  nox_MergeObj  (PNOXNODE pDest, PNOXNODE pSource, PJWRITE pjWrite, MERGEOPTION merge) |    819
   820       |{                                                                                                 |    820
   821       | PNOXNODE  p;                                                                                     |    821
   822       | UCHAR tempname[256];                                                                             |    822
   823       | PNOXNODE pDestNode , pEdt ;                                                                      |    823
 5770WDS V7R2M0  140418   IBM ILE C compiler      noxdb2.c                           DKSRV206    11-01-22 18:00:09 Page          21
   824     1 | int ix =0;                                                                                       |    824
   825       |                                                                                                  |    825
   826     2 | while (pSource) {                                                                                |    826
   827       |                                                                                                  |    827
   828     3 |  if (pSource->Name && *pSource->Name){                                                           |    828
   829     4 |   pDestNode = nox_GetNode  (pDest, pSource->Name);                                               |    829
   830     5 |   if (pDestNode) {                                                                               |    830
   831     6 |    if (merge == MO_MERGE_REPLACE) {                                                              |    831
   832     7 |     nox_NodeDelete (pDestNode);                                                                  |    832
   833     8 |     nox_InsertByName (pDest , pSource->Name , pSource );                                         |    833
   834       |    } else {                                                                                      |    834
   835     9 |     if (pSource->pNodeChildHead && pSource->type == OBJECT) {                                    |    835
   836    10 |      nox_MergeObj  (pDestNode ,  pSource->pNodeChildHead , pjWrite, merge);                      |    836
   837       |     }                                                                                            |    837
   838       |    }                                                                                             |    838
   839       |   } else {                                                                                       |    839
   840    11 |    nox_InsertByName (pDest , pSource->Name , pSource );                                          |    840
   841       |   }                                                                                              |    841
   842       |  } else {                                                                                        |    842
   843    12 |   if (pSource->pNodeChildHead ) {                                                                |    843
   844       |    // PNOXNODE pNewDest = pDest->pNodeChildHead ?  pDest->pNodeChildHead : pDest; // Handle root\|    844
   844       |s !! TODO !!                                                                                      |    844
   845    13 |    PNOXNODE pNewDest = pDest;                                                                    |    845
   846    14 |    nox_MergeObj  (pNewDest,  pSource->pNodeChildHead , pjWrite, merge);                          |    846
   847       |   }                                                                                              |    847
   848       |  }                                                                                               |    848
   849    15 |  pSource = pSource->pNodeSibling;                                                                |    849
   850       | }                                                                                                |    850
   851       |}                                                                                                 |    851
   852       |// ---------------------------------------------------------------------------                    |    852
   853       |void  nox_MergeObjects (PNOXNODE pDest, PNOXNODE pSource , MERGEOPTION merge)                     |    853
   854       |{                                                                                                 |    854
   855       | PNOXNODE  p;                                                                                     |    855
   856       | UCHAR tempname[256];                                                                             |    856
   857       | PNOXNODE pDestNode , pEdt ;                                                                      |    857
   858       | PNOXNODE pSourceNode;                                                                            |    858
   859     1 | int ix =0;                                                                                       |    859
   860       |                                                                                                  |    860
   861     2 | if (pDest ==NULL ||pSource == NULL) return;                                                      |    861
   862       |                                                                                                  |    862
   863     4 | pSourceNode =  pSource->pNodeChildHead;                                                          |    863
   864     5 | while (pSourceNode) {                                                                            |    864
   865       |                                                                                                  |    865
   866     6 |  pDestNode = nox_GetNode  (pDest, pSourceNode->Name);                                            |    866
   867     7 |  if (pDestNode) {                                                                                |    867
   868     8 |   if (merge == MO_MERGE_REPLACE) {                                                               |    868
 5770WDS V7R2M0  140418   IBM ILE C compiler      noxdb2.c                           DKSRV206    11-01-22 18:00:09 Page          22
   869     9 |    nox_NodeDelete (pDestNode);                                                                   |    869
   870    10 |    nox_InsertByName (pDest , pSourceNode->Name , pSourceNode );                                  |    870
   871       |   } else {                                                                                       |    871
   872    11 |    if (pSourceNode->type == OBJECT) {                                                            |    872
   873    12 |     nox_MergeObjects  (pDestNode ,  pSourceNode , merge);                                        |    873
   874       |    }                                                                                             |    874
   875       |   }                                                                                              |    875
   876       |  } else {                                                                                        |    876
   877    13 |   nox_InsertByName (pDest , pSourceNode->Name , pSourceNode );                                   |    877
   878       |  }                                                                                               |    878
   879    14 |  pSourceNode = pSourceNode->pNodeSibling;                                                        |    879
   880       | }                                                                                                |    880
   881       |}                                                                                                 |    881
   882       |// ---------------------------------------------------------------------------                    |    882
   883       |void  nox_LoadRecursiveList (PNOXNODE pNode, PNOXITERATOR pIter, BOOL first)                      |    883
   884       |{                                                                                                 |    884
   885     1 | while (pNode) {                                                                                  |    885
   886     2 |  if (pIter->length >= pIter->size) {                                                             |    886
   887     3 |   pIter->size += 256;                                                                            |    887
   888     4 |   pIter->list = realloc (pIter->list , sizeof(PNOXNODE) * pIter->size);                          |    888
   889       |  }                                                                                               |    889
   890     5 |  pIter->list [pIter->length] = pNode;                                                            |    890
   891     6 |  pIter->length++;                                                                                |    891
   892     7 |  nox_LoadRecursiveList (pNode->pNodeChildHead , pIter, FALSE);                                   |    892
   893     8 |  pNode = first ? NULL : pNode->pNodeSibling;                                                     |    893
   894       | }                                                                                                |    894
   895       |}                                                                                                 |    895
   896       |// ---------------------------------------------------------------------------                    |    896
   897       |// Delete nodes which are NULL                                                                    |    897
   898       |// ---------------------------------------------------------------------------                    |    898
   899       |void  nox_NodeSanitize(PNOXNODE pNode)                                                            |    899
   900       |{                                                                                                 |    900
   901     1 | while (pNode) {                                                                                  |    901
   902     2 |  PNOXNODE pNext = pNode->pNodeSibling;                                                           |    902
   903       |  if (pNode->Value != NULL && strcmp (pNode->Value , "null") == 0                                 |    903
   904     3 |  ||  pNode->Value == NULL && pNode->type == VALUE) {                                             |    904
   905     4 |   nox_NodeDelete(pNode);                                                                         |    905
   906       |  } else {                                                                                        |    906
   907     5 |   nox_NodeSanitize(pNode->pNodeChildHead);                                                       |    907
   908       |  }                                                                                               |    908
   909     6 |  pNode = pNext;                                                                                  |    909
   910       | }                                                                                                |    910
   911       |}                                                                                                 |    911
   912       |// ---------------------------------------------------------------------------                    |    912
   913       |void nox_Dump(PNOXNODE  pNode)                                                                    |    913
   914       |{                                                                                                 |    914
 5770WDS V7R2M0  140418   IBM ILE C compiler      noxdb2.c                           DKSRV206    11-01-22 18:00:09 Page          23
   915     1 | if (pNode == NULL) {                                                                             |    915
   916     2 |  return;                                                                                         |    916
   917       | }                                                                                                |    917
   918       |                                                                                                  |    918
   919     3 | printf("%s\n" , jxMessage) ;                                                                     |    919
   920     4 | nox_DumpNodeList(pNode);                                                                         |    920
   921     5 | printf("\n") ;                                                                                   |    921
   922       |}                                                                                                 |    922
   923       |// ---------------------------------------------------------------------------                    |    923
   924       |// Detect if XML or json and if has UTF-8 BOM code                                                |    924
   925       |// ---------------------------------------------------------------------------                    |    925
   926       |void  detectEncoding(PNOXCOM pJxCom)                                                              |    926
   927       |{                                                                                                 |    927
   928     1 | PUCHAR p = pJxCom->StreamBuf;                                                                    |    928
   929       |                                                                                                  |    929
   930       | // Skip bom ?                                                                                    |    930
   931     2 | if (p [0] == 0xef && p[1] == 0xbb && p[2] == 0xbf) { // utf8 -BOM code                           |    931
   932     3 |  p += 3; // Skip bom code;                                                                       |    932
   933       | }                                                                                                |    933
   934       |                                                                                                  |    934
   935       | // skip blanks                                                                                   |    935
   936     4 | for (; *p <= BLANK && *p != '\0'; p++);                                                          |    936
   937       |                                                                                                  |    937
   938     6 | pJxCom->isJson = (*p != LT);                                                                     |    938
   939     7 | pJxCom->StreamBuf = p;                                                                           |    939
   940       |}                                                                                                 |    940
   941       |// ---------------------------------------------------------------------------                    |    941
   942       |/* Old implementation                                                                             |    942
   943       |PUCHAR detectEncoding(PNOXCOM pJxCom, PUCHAR pIn)                                                 |    943
   944       |{                                                                                                 |    944
   945       | UCHAR  e2aTbl [256];                                                                             |    945
   946       | UCHAR  buf [128];                                                                                |    946
   947       | PUCHAR p, outbuf;                                                                                |    947
   948       | int i;                                                                                           |    948
   949       | BOOL done = FALSE;                                                                               |    949
   950       | BOOL isXml = FALSE;                                                                              |    950
   951       | BOOL isAscii = FALSE;                                                                            |    951
   952       |                                                                                                  |    952
   953       | // need temp version since it is modified                                                        |    953
   954       | substr ( buf, pIn , 128);                                                                        |    954
   955       |                                                                                                  |    955
   956       | if (buf [0] == 0xef && buf[1] == 0xbb && buf [2] == 0xbf) { // utf8                              |    956
   957       |   InputCcsid = 1208;                                                                             |    957
   958       |   isAscii = TRUE;                                                                                |    958
   959       |   p = buf + 3;                                                                                   |    959
   960       |   outbuf = pIn + 3;                                                                              |    960
 5770WDS V7R2M0  140418   IBM ILE C compiler      noxdb2.c                           DKSRV206    11-01-22 18:00:09 Page          24
   961       | } else {                                                                                         |    961
   962       |   p = buf;                                                                                       |    962
   963       |   outbuf = pIn;                                                                                  |    963
   964       | }                                                                                                |    964
   965       |                                                                                                  |    965
   966       | for (i=0; ! done; i++, p++) {                                                                    |    966
   967       |  switch(*p) {                                                                                    |    967
   968       |   case  '['  :                                                                                   |    968
   969       |   case  '{'  :                                                                                   |    969
   970       |   case  '\"' :                                                                                   |    970
   971       |   case  '\'' :                                                                                   |    971
   972       |    pJxCom->isJson = TRUE;                                                                        |    972
   973       |    done = TRUE;                                                                                  |    973
   974       |    break;                                                                                        |    974
   975       |                                                                                                  |    975
   976       |   case  '<' :                                                                                    |    976
   977       |    pJxCom->isJson = FALSE;                                                                       |    977
   978       |    isXml = TRUE;                                                                                 |    978
   979       |    done = TRUE;                                                                                  |    979
   980       |    break;                                                                                        |    980
   981       |                                                                                                  |    981
   982       |  #pragma convert(1252)                                                                           |    982
   983       |   case  '['  :                                                                                   |    983
   984       |   case  '{'  :                                                                                   |    984
   985       |   case  '\"' :                                                                                   |    985
   986       |   case  '\'' :                                                                                   |    986
   987       |    pJxCom->isJson = TRUE;                                                                        |    987
   988       |    isAscii = TRUE;                                                                               |    988
   989       |    done = TRUE;                                                                                  |    989
   990       |    break;                                                                                        |    990
   991       |                                                                                                  |    991
   992       |   case  '<' :                                                                                    |    992
   993       |    pJxCom->isJson = FALSE;                                                                       |    993
   994       |    isAscii = TRUE;                                                                               |    994
   995       |    isXml = TRUE;                                                                                 |    995
   996       |    done = TRUE;                                                                                  |    996
   997       |    break;                                                                                        |    997
   998       |                                                                                                  |    998
   999       |  #pragma convert(0)                                                                              |    999
  1000       |   case  '\0' :                                                                                   |   1000
  1001       |    InputCcsid = 0; // Empty string; build from scratch XML                                       |   1001
  1002       |    return;                                                                                       |   1002
  1003       |                                                                                                  |   1003
  1004       |   default:                                                                                       |   1004
  1005       |    // For other codepages than 277                                                               |   1005
  1006       |    if (*p == BRABEG || *p == CurBeg || *p == Quot || *p == Apos                                  |   1006
 5770WDS V7R2M0  140418   IBM ILE C compiler      noxdb2.c                           DKSRV206    11-01-22 18:00:09 Page          25
  1007       |    ||  isdigit(*p)                                                                               |   1007
  1008       |    ||  memBeginsWith(p , "true" )                                                                |   1008
  1009       |    ||  memBeginsWith(p , "false")                                                                |   1009
  1010       |    ||  memBeginsWith(p , "null" )) {                                                             |   1010
  1011       |      pJxCom->isJson = TRUE;                                                                      |   1011
  1012       |      done = TRUE;                                                                                |   1012
  1013       |      break;                                                                                      |   1013
  1014       |    }                                                                                             |   1014
  1015       |  }                                                                                               |   1015
  1016       | }                                                                                                |   1016
  1017       |                                                                                                  |   1017
  1018       | // Bump back to rigt after "<" or what made it stop                                              |   1018
  1019       | p--;                                                                                             |   1019
  1020       | if (p && pJxCom->isJson) {                                                                       |   1020
  1021       |  / *  .... Avoid to use the ccsid from the file - this can be anything ....                      |   1021
  1022       |  if (InputCcsid == 0 && pJxCom->File && lstat(pJxCom->FileName, &statbuf) == 0) {                |   1022
  1023       |    InputCcsid = statbuf.st_ccsid;                                                                |   1023
  1024       |  } else if (isAscii && InputCcsid == 0) {                                                        |   1024
  1025       |    InputCcsid = 1208;                                                                            |   1025
  1026       |  } .... * /                                                                                      |   1026
  1027       |  // Assume 1208 for any ascii JSON and set with EBCDIC ccsid on the file                         |   1027
  1028       |  if (isAscii && InputCcsid < 900) {                                                              |   1028
  1029       |    InputCcsid = 1208;                                                                            |   1029
  1030       |  }                                                                                               |   1030
  1031       | } else if (p && isXml && isAscii) {                                                              |   1031
  1032       |  if ( InputCcsid == 0) {                                                                         |   1032
  1033       |   // InputCcsid = 1252;  // Default to basic windows ascii                                       |   1033
  1034       |   InputCcsid = 1208;  // Default to UTF-8                                                        |   1034
  1035       |  }                                                                                               |   1035
  1036       |                                                                                                  |   1036
  1037       |  if (*(p+1) == 0x00) { // UNICODE litle endian                                                   |   1037
  1038       |   pJxCom->LittleEndian  = TRUE;                                                                  |   1038
  1039       |   InputCcsid = 1200;                                                                             |   1039
  1040       |  }                                                                                               |   1040
  1041       |  else if (p > buf && *(p-1) == 0x00) { // UNICODE big endian                                     |   1041
  1042       |   pJxCom->LittleEndian  = FALSE;                                                                 |   1042
  1043       |   // InputCcsid = 13488;                                                                         |   1043
  1044       |   InputCcsid = 1200;                                                                             |   1044
  1045       |  }                                                                                               |   1045
  1046       |  else if (*(p+1) == 0x3f) { // ? in ascii                                                        |   1046
  1047       |   #pragma convert(1252)                                                                          |   1047
  1048       |   p = strchr(p+2 , 0x3f);  // ? in ascii                                                         |   1048
  1049       |   if (*p) *p = '\0';                                                                             |   1049
  1050       |                                                                                                  |   1050
  1051       |   if (strstr  ( buf ,  "-8859-1")) {  // Short for ISO-8859-1                                    |   1051
  1052       |    InputCcsid = 819;                                                                             |   1052
 5770WDS V7R2M0  140418   IBM ILE C compiler      noxdb2.c                           DKSRV206    11-01-22 18:00:09 Page          26
  1053       |   }                                                                                              |   1053
  1054       |   else if (strstr  ( buf ,  "-8")) {  // Short for UTF-8                                         |   1054
  1055       |    InputCcsid = 1208;                                                                            |   1055
  1056       |   }                                                                                              |   1056
  1057       |   else if (strstr  ( buf ,  "-1252")) {  // Short for windows-1252                               |   1057
  1058       |    InputCcsid = 1252;                                                                            |   1058
  1059       |   }                                                                                              |   1059
  1060       |   #pragma convert(0)                                                                             |   1060
  1061       |  }                                                                                               |   1061
  1062       | } else if (strlen(buf) == 0) {                                                                   |   1062
  1063       |  InputCcsid = 0; // Empty string; build from scratch XML                                         |   1063
  1064       | } else {                                                                                         |   1064
  1065       |  nox_SetMessage( "Unsupported /unknown charset or encoding for file %s ", pJxCom->FileName);     |   1065
  1066       |  pJxCom->State = XML_EXIT_ERROR;                                                                 |   1066
  1067       |  return outbuf;                                                                                  |   1067
  1068       | }                                                                                                |   1068
  1069       |                                                                                                  |   1069
  1070       | return outbuf;                                                                                   |   1070
  1071       |}                                                                                                 |   1071
  1072       |*/                                                                                                |   1072
  1073       |// ---------------------------------------------------------------------------                    |   1073
  1074       |static PNOXNODE  SelectParser (PNOXCOM pJxCom)                                                    |   1074
  1075       |{                                                                                                 |   1075
  1076       | PNOXNODE pRoot;                                                                                  |   1076
  1077     1 | CheckBufSize(pJxCom);                                                                            |   1077
  1078     2 | pJxCom->pNodeRoot = pRoot = NewNode (NULL, NULL, OBJECT);                                        |   1078
  1079     3 | pJxCom->pFileBuf = NULL;                                                                         |   1079
  1080     4 | pJxCom->State = XML_FIND_START_TOKEN;                                                            |   1080
  1081     5 | pJxCom->LineCount = 1;                                                                           |   1081
  1082     6 | pJxCom->pNodeWorkRoot = pJxCom->pNodeRoot;                                                       |   1082
  1083     7 | pJxCom->Comment = memAlloc(COMMENT_SIZE);                                                        |   1083
  1084     8 | * pJxCom->Comment = '\0';                                                                        |   1084
  1085       |                                                                                                  |   1085
  1086     9 | detectEncoding (pJxCom);                                                                         |   1086
  1087       |                                                                                                  |   1087
  1088    10 | if (pJxCom->isJson) {                                                                            |   1088
  1089    11 |  jxError = nox_ParseJson (pJxCom);                                                               |   1089
  1090       | } else {                                                                                         |   1090
  1091    12 |  jxError = nox_ParseXml (pJxCom);                                                                |   1091
  1092       | }                                                                                                |   1092
  1093       |                                                                                                  |   1093
  1094       | // Clean up                                                                                      |   1094
  1095    13 | memFree(&pJxCom->Comment);                                                                       |   1095
  1096    14 | memFree(&pJxCom);                                                                                |   1096
  1097       |                                                                                                  |   1097
  1098    15 | return pRoot;                                                                                    |   1098
 5770WDS V7R2M0  140418   IBM ILE C compiler      noxdb2.c                           DKSRV206    11-01-22 18:00:09 Page          27
  1099       |}                                                                                                 |   1099
  1100       |// ---------------------------------------------------------------------------                    |   1100
  1101       |// This works, however                                                                            |   1101
  1102       |// it is dangling for clean up since the subnotes are moved to another tree                       |   1102
  1103       |// ---------------------------------------------------------------------------                    |   1103
  1104       |void nox_NodeAppendChild(PNOXNODE pRoot, PNOXNODE pNewChild)                                      |   1104
  1105       |{                                                                                                 |   1105
  1106     1 | if (pRoot == NULL) return;                                                                       |   1106
  1107     3 | if (pNewChild == NULL) return;                                                                   |   1107
  1108       |                                                                                                  |   1108
  1109     5 | pNewChild->pNodeParent = pRoot;                                                                  |   1109
  1110       |                                                                                                  |   1110
  1111     6 | if (pRoot->pNodeChildHead == NULL) {                                                             |   1111
  1112     7 |  pNewChild->pNodeParent->pNodeChildHead = pNewChild;                                             |   1112
  1113       | } else {                                                                                         |   1113
  1114     8 |  pNewChild->Seq = pNewChild->pNodeParent->pNodeChildTail->Seq + 1; // Increment Sibling number   |   1114
  1115     9 |  pNewChild->pNodeParent->pNodeChildTail->pNodeSibling = pNewChild;                               |   1115
  1116       | }                                                                                                |   1116
  1117    10 | pNewChild->pNodeParent->pNodeChildTail = pNewChild;                                              |   1117
  1118       |}                                                                                                 |   1118
  1119       |// ---------------------------------------------------------------------------                    |   1119
  1120       |static PNOXNODE previousSibling(PNOXNODE p)                                                       |   1120
  1121       |{                                                                                                 |   1121
  1122       | PNOXNODE t;                                                                                      |   1122
  1123     1 | if (p->pNodeParent == NULL) return NULL; // I am the root                                        |   1123
  1124     3 | t = p->pNodeParent->pNodeChildHead;                                                              |   1124
  1125     4 | while (t) {                                                                                      |   1125
  1126     5 |  if (t->pNodeSibling == p) return(t);                                                            |   1126
  1127     7 |  t = t->pNodeSibling;                                                                            |   1127
  1128       | }                                                                                                |   1128
  1129     8 | return ( NULL);                                                                                  |   1129
  1130       |}                                                                                                 |   1130
  1131       |                                                                                                  |   1131
  1132       |// ---------------------------------------------------------------------------                    |   1132
  1133       |static PNOXNODE DupNode(PNOXNODE pSource)                                                         |   1133
  1134       |{                                                                                                 |   1134
  1135       | PNOXATTR pAttrTemp;                                                                              |   1135
  1136       | PNOXNODE  pNode;                                                                                 |   1136
  1137       |                                                                                                  |   1137
  1138       | // A copy of null is null                                                                        |   1138
  1139     1 | if (pSource == NULL) return NULL;                                                                |   1139
  1140       |                                                                                                  |   1140
  1141       | // Dupling a nodex which is a string simply kicks in the parser                                  |   1141
  1142     3 | if (pSource->signature != NODESIG) {                                                             |   1142
  1143     4 |  pNode = nox_ParseString((PUCHAR) pSource);                                                      |   1143
  1144     5 |  return pNode;                                                                                   |   1144
 5770WDS V7R2M0  140418   IBM ILE C compiler      noxdb2.c                           DKSRV206    11-01-22 18:00:09 Page          28
  1145       | }                                                                                                |   1145
  1146       |                                                                                                  |   1146
  1147     6 | pNode = (PNOXNODE) memAlloc (sizeof(*pNode));                                                    |   1147
  1148     7 | memcpy  (pNode , pSource, sizeof(*pNode));                                                       |   1148
  1149       |                                                                                                  |   1149
  1150     8 | pNode->pAttrList  = NULL;                                                                        |   1150
  1151     9 | pNode->pNodeParent = pNode->pNodeChildHead = pNode->pNodeChildTail = pNode->pNodeSibling = NULL; |   1151
  1152    10 | pNode->Name  = memStrDup(pSource->Name);                                                         |   1152
  1153    11 | pNode->Value = memStrDup(pSource->Value);                                                        |   1153
  1154       |                                                                                                  |   1154
  1155    12 | for (pAttrTemp = pSource->pAttrList; pAttrTemp ; pAttrTemp = pAttrTemp->pAttrSibling){           |   1155
  1156    13 |  PNOXATTR  pPrev, pAttr = (PNOXATTR) memAlloc (sizeof(*pAttr));                                  |   1156
  1157    14 |  memset (pAttr , 0, sizeof(*pAttr));                                                             |   1157
  1158    15 |  pAttr->signature  = ATTRSIG;                                                                    |   1158
  1159    16 |  pAttr->Name  = memStrDup( pAttrTemp->Name);                                                     |   1159
  1160    17 |  pAttr->Value = memStrDup(pAttrTemp->Value);                                                     |   1160
  1161    18 |  if ( pNode->pAttrList ==NULL) {                                                                 |   1161
  1162    19 |   pNode->pAttrList = pAttr;                                                                      |   1162
  1163       |  } else {                                                                                        |   1163
  1164    20 |   pPrev->pAttrSibling = pAttr;                                                                   |   1164
  1165       |  }                                                                                               |   1165
  1166    21 |  pPrev =pAttr;                                                                                   |   1166
  1167       | }                                                                                                |   1167
  1168       |                                                                                                  |   1168
  1169    22 | return (pNode);                                                                                  |   1169
  1170       |}                                                                                                 |   1170
  1171       |// ---------------------------------------------------------------------------                    |   1171
  1172       |void nox_NodeAddChildTail( PNOXNODE pRoot, PNOXNODE pChild)                                       |   1172
  1173       |{                                                                                                 |   1173
  1174     1 | if (pChild == NULL || pRoot == NULL) return;                                                     |   1174
  1175       |                                                                                                  |   1175
  1176     3 | pChild->pNodeParent = pRoot;                                                                     |   1176
  1177       |                                                                                                  |   1177
  1178     4 | if (pChild->pNodeParent->type == ARRAY) {                                                        |   1178
  1179     5 |  pChild->pNodeParent->Count ++;                                                                  |   1179
  1180       | }                                                                                                |   1180
  1181       |                                                                                                  |   1181
  1182     6 | if (pChild->pNodeParent->pNodeChildHead == NULL) {                                               |   1182
  1183     7 |  pChild->pNodeParent->pNodeChildHead = pChild;                                                   |   1183
  1184     8 |  pChild->pNodeParent->pNodeChildTail = pChild;                                                   |   1184
  1185       | } else {                                                                                         |   1185
  1186       |  // TODO !! Why is the tail some times NULL?                                                     |   1186
  1187       |  // AND: found the "unlink" error, so may we can remove it now...                                |   1187
  1188       |  // This "if" can be remove when this bug i found.                                               |   1188
  1189     9 |  if (pChild->pNodeParent->pNodeChildTail) {                                                      |   1189
  1190    10 |   pChild->Seq = pChild->pNodeParent->pNodeChildTail->Seq + 1; // Increment Sibling number        |   1190
 5770WDS V7R2M0  140418   IBM ILE C compiler      noxdb2.c                           DKSRV206    11-01-22 18:00:09 Page          29
  1191    11 |   pChild->pNodeParent->pNodeChildTail->pNodeSibling = pChild;                                    |   1191
  1192       |  }                                                                                               |   1192
  1193    12 |  pChild->pNodeParent->pNodeChildTail = pChild;                                                   |   1193
  1194       | }                                                                                                |   1194
  1195       |}                                                                                                 |   1195
  1196       |// ---------------------------------------------------------------------------                    |   1196
  1197       |// unlink a node from the tree and returns it as a new root                                       |   1197
  1198       |// It has no parent nor any siblings. It can only have children                                   |   1198
  1199       |// ---------------------------------------------------------------------------                    |   1199
  1200       |PNOXNODE nox_NodeUnlink  (PNOXNODE  pNode)                                                        |   1200
  1201       |{                                                                                                 |   1201
  1202       | PNOXNODE pNewRoot, pPrevNode, pParent;                                                           |   1202
  1203       |                                                                                                  |   1203
  1204     1 | if (pNode == NULL) return NULL;                                                                  |   1204
  1205       |                                                                                                  |   1205
  1206     3 | pParent = pNode->pNodeParent;                                                                    |   1206
  1207       |                                                                                                  |   1207
  1208       | // if I am a root node, then look no further                                                     |   1208
  1209     4 | if (pParent == NULL) return pNode;                                                               |   1209
  1210       |                                                                                                  |   1210
  1211     6 | pPrevNode  = previousSibling(pNode);                                                             |   1211
  1212     7 | if (pPrevNode) {                                                                                 |   1212
  1213     8 |  pPrevNode->pNodeSibling = pNode->pNodeSibling;                                                  |   1213
  1214       | } else {                                                                                         |   1214
  1215     9 |  pParent->pNodeChildHead = pNode->pNodeSibling;                                                  |   1215
  1216       | }                                                                                                |   1216
  1217    10 | if (pParent->pNodeChildTail == pNode) {                                                          |   1217
  1218    11 |  pParent->pNodeChildTail = pPrevNode;                                                            |   1218
  1219       | }                                                                                                |   1219
  1220       |                                                                                                  |   1220
  1221       | // json arrays has the "length" counter synconized                                               |   1221
  1222    12 | if (pParent->type == ARRAY) {                                                                    |   1222
  1223    13 |  pParent->Count --;                                                                              |   1223
  1224       | }                                                                                                |   1224
  1225       |                                                                                                  |   1225
  1226       | // Now i am alone:                                                                               |   1226
  1227    14 | pNode->pNodeSibling = null;                                                                      |   1227
  1228    15 | pNode->pNodeParent  = null;                                                                      |   1228
  1229       |                                                                                                  |   1229
  1230    16 | return pNode;                                                                                    |   1230
  1231       |}                                                                                                 |   1231
  1232       |// ---------------------------------------------------------------------------                    |   1232
  1233       |void nox_SwapNodes (PNOXNODE * ppNode1, PNOXNODE * ppNode2)                                       |   1233
  1234       |{                                                                                                 |   1234
  1235     1 | PNOXNODE pNode1 = *ppNode1  , pNode2 =  * ppNode2;                                               |   1235
  1236     3 | PNOXNODE pTemp1, pTemp2, pPrevNode, pParent = NULL;                                              |   1236
 5770WDS V7R2M0  140418   IBM ILE C compiler      noxdb2.c                           DKSRV206    11-01-22 18:00:09 Page          30
  1237       |                                                                                                  |   1237
  1238     4 | if (pNode1 == NULL || pNode2 == NULL) return;                                                    |   1238
  1239       |                                                                                                  |   1239
  1240       |                                                                                                  |   1240
  1241     6 | pParent = pNode1->pNodeParent;                                                                   |   1241
  1242     7 | pPrevNode  = previousSibling(pNode1);                                                            |   1242
  1243     8 | if (pPrevNode) {                                                                                 |   1243
  1244     9 |  pPrevNode->pNodeSibling = pNode2;                                                               |   1244
  1245    10 | } else if (pParent) {                                                                            |   1245
  1246    11 |  pParent->pNodeChildHead = pNode2;                                                               |   1246
  1247       | }                                                                                                |   1247
  1248       |                                                                                                  |   1248
  1249    12 | pNode1->pNodeSibling = pNode2->pNodeSibling;                                                     |   1249
  1250    13 | pNode2->pNodeSibling = pNode1;                                                                   |   1250
  1251       |                                                                                                  |   1251
  1252    14 | if (pParent && pParent->pNodeChildTail == pNode2) {                                              |   1252
  1253    15 |  pParent->pNodeChildTail = pNode1;                                                               |   1253
  1254       | }                                                                                                |   1254
  1255    16 | *ppNode1 = pNode2;                                                                               |   1255
  1256    17 | *ppNode2 = pNode1;                                                                               |   1256
  1257       |}                                                                                                 |   1257
  1258       |// ---------------------------------------------------------------------------                    |   1258
  1259       |PNOXNODE nox_NodeMoveInto (PNOXNODE  pDest, PUCHAR name , PNOXNODE pSource)                       |   1259
  1260       |{                                                                                                 |   1260
  1261       |                                                                                                  |   1261
  1262       | PNOXNODE  pTempNode;                                                                             |   1262
  1263       |                                                                                                  |   1263
  1264       | if (pDest == pSource                                                                             |   1264
  1265     1 | ||  pDest == NULL) {                                                                             |   1265
  1266     2 |  return pDest;                                                                                   |   1266
  1267       | }                                                                                                |   1267
  1268       |                                                                                                  |   1268
  1269       | // If no destination given, then it is actually a replace og the                                 |   1269
  1270       | // destimnation node - with respect to the memmory locaitons                                     |   1270
  1271     3 | if (*name == '\0') {                                                                             |   1271
  1272     4 |  nox_NodeMoveAndReplace (pDest , pSource);                                                       |   1272
  1273     5 |  return pDest;                                                                                   |   1273
  1274       | }                                                                                                |   1274
  1275       |                                                                                                  |   1275
  1276     6 | pSource = nox_NodeUnlink(pSource); // Now I am my own root                                       |   1276
  1277     7 | nox_NodeRename(pSource , name);                                                                  |   1277
  1278       |                                                                                                  |   1278
  1279     8 | pTempNode  = nox_GetNode  (pDest, name );                                                        |   1279
  1280     9 | if (pTempNode == NULL) {                                                                         |   1280
  1281       | // if (pSource->type == VALUE) {                                                                 |   1281
  1282       | //    nox_NodeSet (pDest , pSource->Value);                                                      |   1282
 5770WDS V7R2M0  140418   IBM ILE C compiler      noxdb2.c                           DKSRV206    11-01-22 18:00:09 Page          31
  1283       | //    nox_NodeDelete (pSource);                                                                  |   1283
  1284       | //    return pDest;                                                                              |   1284
  1285       | // }                                                                                             |   1285
  1286    10 |  nox_NodeAddChildTail (pDest, pSource);                                                          |   1286
  1287       |                                                                                                  |   1287
  1288       |  // Since we have a name - we must be an object                                                  |   1288
  1289       |  // required if we were a value i.e. produce by                                                  |   1289
  1290       |  // locateOrCreate / getorCreate or we were a value by ie. setStr                                |   1290
  1291    11 |  if (pDest->type != ARRAY ) {                                                                    |   1291
  1292    12 |   pDest->type = OBJECT;                                                                          |   1292
  1293       |  }                                                                                               |   1293
  1294    13 |  freeNodeValue(pDest);                                                                           |   1294
  1295       |                                                                                                  |   1295
  1296       | } else {                                                                                         |   1296
  1297       |  // replace, by adding a new with same name and the remove the original. Will keep the same posi\|   1297
  1297       |tion                                                                                              |   1297
  1298    14 |  nox_NodeAddSiblingAfter(pTempNode, pSource);                                                    |   1298
  1299    15 |  nox_NodeDelete (pTempNode);                                                                     |   1299
  1300       | }                                                                                                |   1300
  1301       |                                                                                                  |   1301
  1302    16 | return pSource;                                                                                  |   1302
  1303       |                                                                                                  |   1303
  1304       |}                                                                                                 |   1304
  1305       |// ---------------------------------------------------------------------------                    |   1305
  1306       |PNOXNODE nox_NodeMoveIntoVC (PNOXNODE  pDest, PLVARCHAR  name , PNOXNODE pSource)                 |   1306
  1307       |{                                                                                                 |   1307
  1308     1 | return nox_NodeMoveInto (pDest, plvc2str (name) ,  pSource);                                     |   1308
  1309       |}                                                                                                 |   1309
  1310       |// ---------------------------------------------------------------------------                    |   1310
  1311       |void nox_NodeMoveAndReplace (PNOXNODE  pDest, PNOXNODE pSource)                                   |   1311
  1312       |{                                                                                                 |   1312
  1313       | if (pDest == pSource                                                                             |   1313
  1314     1 | ||  pDest == NULL) {                                                                             |   1314
  1315     2 |  return;                                                                                         |   1315
  1316       | }                                                                                                |   1316
  1317       |                                                                                                  |   1317
  1318     3 | pSource = nox_NodeUnlink(pSource);      // Now I am my own root                                  |   1318
  1319     4 | nox_NodeRename(pSource , pDest->Name);  // I need the same name of the node i gonna replace      |   1319
  1320       |                                                                                                  |   1320
  1321       | // replace, by adding a new with same name and the remove the original. Will keep the same posit\|   1321
  1321       |ion                                                                                               |   1321
  1322     5 | nox_NodeAddSiblingAfter(pDest, pSource);                                                         |   1322
  1323     6 | nox_NodeDelete (pDest);                                                                          |   1323
  1324       |}                                                                                                 |   1324
  1325       |// ---------------------------------------------------------------------------                    |   1325
  1326       |void nox_NodeAddChildHead( PNOXNODE pRoot, PNOXNODE pChild)                                       |   1326
 5770WDS V7R2M0  140418   IBM ILE C compiler      noxdb2.c                           DKSRV206    11-01-22 18:00:09 Page          32
  1327       |{                                                                                                 |   1327
  1328     1 | pChild->pNodeParent = pRoot;                                                                     |   1328
  1329       |                                                                                                  |   1329
  1330     2 | if (pChild->pNodeParent->type == ARRAY) {                                                        |   1330
  1331     3 |  pChild->pNodeParent->Count ++;                                                                  |   1331
  1332       | }                                                                                                |   1332
  1333       |                                                                                                  |   1333
  1334     4 | if (pChild->pNodeParent->pNodeChildHead == NULL) {                                               |   1334
  1335     5 |  pChild->pNodeParent->pNodeChildHead = pChild;                                                   |   1335
  1336     6 |  pChild->pNodeParent->pNodeChildTail = pChild;                                                   |   1336
  1337       | } else {                                                                                         |   1337
  1338       |  PNOXNODE pTemp;                                                                                 |   1338
  1339     7 |  pTemp = pChild->pNodeParent->pNodeChildHead;                                                    |   1339
  1340     8 |  pChild->pNodeParent->pNodeChildHead = pChild;                                                   |   1340
  1341     9 |  pChild->pNodeSibling = pTemp;                                                                   |   1341
  1342       |//    pChild->Seq = pChild->pNodeParent->pNodeChildTail->Seq + 1; // Increment Sibling number to \|   1342
  1342       |do ... renumber                                                                                   |   1342
  1343       | }                                                                                                |   1343
  1344       |}                                                                                                 |   1344
  1345       |// ---------------------------------------------------------------------------                    |   1345
  1346       |void nox_NodeAddSiblingBefore( PNOXNODE pRef, PNOXNODE pSibling)                                  |   1346
  1347       |{                                                                                                 |   1347
  1348     1 | PNOXNODE pPrev = previousSibling(pRef);                                                          |   1348
  1349       |                                                                                                  |   1349
  1350     2 | if (pPrev == NULL) {                                                                             |   1350
  1351     3 |  nox_NodeAddChildHead( pRef->pNodeParent, pSibling);                                             |   1351
  1352     4 |  return;                                                                                         |   1352
  1353       | }                                                                                                |   1353
  1354     5 | pSibling->pNodeParent  = pRef->pNodeParent;                                                      |   1354
  1355     6 | pSibling->pNodeSibling = pRef;                                                                   |   1355
  1356     7 | pPrev->pNodeSibling    = pSibling;                                                               |   1356
  1357       |}                                                                                                 |   1357
  1358       |// ---------------------------------------------------------------------------                    |   1358
  1359       |void nox_NodeAddSiblingAfter( PNOXNODE pRef, PNOXNODE pSibling)                                   |   1359
  1360       |{                                                                                                 |   1360
  1361     1 | if (pRef->pNodeSibling == NULL) {                                                                |   1361
  1362     2 |  nox_NodeAddChildTail ( pRef->pNodeParent, pSibling);                                            |   1362
  1363     3 |  return;                                                                                         |   1363
  1364       | }                                                                                                |   1364
  1365     4 | pSibling->pNodeParent  = pRef->pNodeParent;                                                      |   1365
  1366     5 | pSibling->pNodeSibling = pRef->pNodeSibling;                                                     |   1366
  1367     6 | pRef->pNodeSibling     = pSibling;                                                               |   1367
  1368       |}                                                                                                 |   1368
  1369       |// ---------------------------------------------------------------------------                    |   1369
  1370       |void AddNode(PNOXNODE pDest, PNOXNODE pSource, REFLOC refloc)                                     |   1370
  1371       |{                                                                                                 |   1371
 5770WDS V7R2M0  140418   IBM ILE C compiler      noxdb2.c                           DKSRV206    11-01-22 18:00:09 Page          33
  1372     1 | if (pDest   == NULL) return;                                                                     |   1372
  1373       |                                                                                                  |   1373
  1374     3 | switch ( refloc) {                                                                               |   1374
  1375       |  case RL_LAST_CHILD:                                                                             |   1375
  1376     4 |   nox_NodeAddChildTail (pDest, pSource);                                                         |   1376
  1377     5 |   break;                                                                                         |   1377
  1378       |  case RL_FIRST_CHILD:                                                                            |   1378
  1379     6 |   nox_NodeAddChildHead (pDest, pSource);                                                         |   1379
  1380     7 |   break;                                                                                         |   1380
  1381       |  case RL_BEFORE_SIBLING:                                                                         |   1381
  1382     8 |   nox_NodeAddSiblingBefore(pDest, pSource);                                                      |   1382
  1383     9 |   break;                                                                                         |   1383
  1384       |  case RL_AFTER_SIBLING:                                                                          |   1384
  1385    10 |   nox_NodeAddSiblingAfter(pDest, pSource);                                                       |   1385
  1386    11 |   break;                                                                                         |   1386
  1387       | }                                                                                                |   1387
  1388       |}                                                                                                 |   1388
  1389       |// ---------------------------------------------------------------------------                    |   1389
  1390       |PNOXNODE nox_NodeClone  (PNOXNODE pSource)                                                        |   1390
  1391       |{                                                                                                 |   1391
  1392       | PNOXNODE  pNewNode, pNext;                                                                       |   1392
  1393       |                                                                                                  |   1393
  1394     1 | if (pSource == NULL) return NULL;                                                                |   1394
  1395       |                                                                                                  |   1395
  1396     3 | pNewNode = DupNode(pSource);                                                                     |   1396
  1397       |                                                                                                  |   1397
  1398     4 | pNext = pSource->pNodeChildHead;                                                                 |   1398
  1399     5 | while (pNext) {                                                                                  |   1399
  1400     6 |  PNOXNODE  pNewChild = nox_NodeClone (pNext);                                                    |   1400
  1401     7 |  nox_NodeAddChildTail (pNewNode , pNewChild);                                                    |   1401
  1402     8 |  pNext=pNext->pNodeSibling;                                                                      |   1402
  1403       | }                                                                                                |   1403
  1404     9 | return pNewNode;                                                                                 |   1404
  1405       |}                                                                                                 |   1405
  1406       |// ---------------------------------------------------------------------------                    |   1406
  1407       |PNOXNODE nox_NodeCopy (PNOXNODE pDest, PNOXNODE pSource, REFLOC refloc)                           |   1407
  1408       |{                                                                                                 |   1408
  1409       | PNOXNODE  pNewNode, pNode;                                                                       |   1409
  1410       |                                                                                                  |   1410
  1411     1 | if (pDest   == NULL) return;                                                                     |   1411
  1412     3 | if (pSource == NULL) return;                                                                     |   1412
  1413       |                                                                                                  |   1413
  1414     5 | pNewNode = nox_NodeClone  (pSource);                                                             |   1414
  1415     6 | AddNode(pDest, pNewNode, refloc);                                                                |   1415
  1416     7 | return pNewNode;                                                                                 |   1416
  1417       |                                                                                                  |   1417
 5770WDS V7R2M0  140418   IBM ILE C compiler      noxdb2.c                           DKSRV206    11-01-22 18:00:09 Page          34
  1418       |}                                                                                                 |   1418
  1419       |// ---------------------------------------------------------------------------                    |   1419
  1420       |PNOXNODE NewNode  (PUCHAR Name , PUCHAR Value, NODETYPE type)                                     |   1420
  1421       |{                                                                                                 |   1421
  1422       | PNOXNODE  pNode;                                                                                 |   1422
  1423       |                                                                                                  |   1423
  1424     1 | pNode = (PNOXNODE) memAlloc (sizeof(*pNode));                                                    |   1424
  1425     2 | memset (pNode , 0, sizeof(*pNode));                                                              |   1425
  1426     3 | pNode->signature  = NODESIG;                                                                     |   1426
  1427       |                                                                                                  |   1427
  1428       | // TODO !! Need use only the type in the future                                                  |   1428
  1429     4 | if (type == LITERAL) {                                                                           |   1429
  1430     5 |  pNode->type      = VALUE;                                                                       |   1430
  1431     6 |  pNode->isLiteral = TRUE;                                                                        |   1431
  1432       | } else {                                                                                         |   1432
  1433     7 |  pNode->type = type;                                                                             |   1433
  1434     8 |  pNode->isLiteral = FALSE;                                                                       |   1434
  1435       | }                                                                                                |   1435
  1436     9 | pNode->Name   = memStrDup(Name);                                                                 |   1436
  1437    10 | pNode->Value  = memStrDup(Value);                                                                |   1437
  1438    11 | return pNode;                                                                                    |   1438
  1439       |}                                                                                                 |   1439
  1440       |// ---------------------------------------------------------------------------                    |   1440
  1441       |PNOXNODE nox_NodeAdd (PNOXNODE pDest, REFLOC refloc, PUCHAR Name , PUCHAR Value, NODETYPE type)   |   1441
  1442       |{                                                                                                 |   1442
  1443     1 |    PNOXNODE  pNewNode  = NewNode  (Name , Value, type);                                          |   1443
  1444     2 | AddNode(pDest, pNewNode, refloc);                                                                |   1444
  1445     3 | return pNewNode;                                                                                 |   1445
  1446       |}                                                                                                 |   1446
  1447       |PNOXNODE nox_NodeAddVC (PNOXNODE pDest, REFLOC refloc, PLVARCHAR Name , PLVARCHAR Value, NODETYPE\|   1447
  1447       | typeP)                                                                                           |   1447
  1448       |{                                                                                                 |   1448
  1449     1 | PNPMPARMLISTADDRP pParms = _NPMPARMLISTADDR();                                                   |   1449
  1450     2 | NODETYPE type =  pParms->OpDescList->NbrOfParms >= 5 ? typeP : VALUE;                            |   1450
  1451     3 | return  nox_NodeAdd  (pDest, refloc , plvc2str(Name) , plvc2str(Value), type);                   |   1451
  1452       |}                                                                                                 |   1452
  1453       |// ---------------------------------------------------------------------------                    |   1453
  1454       |PNOXNODE nox_NewObject ()                                                                         |   1454
  1455       |{                                                                                                 |   1455
  1456     1 | PNOXNODE  pNode = (PNOXNODE) memAllocClear (sizeof(NOXNODE));                                    |   1456
  1457     2 | pNode->signature  = NODESIG;                                                                     |   1457
  1458     3 | pNode->type       = OBJECT;                                                                      |   1458
  1459     4 | return pNode;                                                                                    |   1459
  1460       |}                                                                                                 |   1460
  1461       |// ---------------------------------------------------------------------------                    |   1461
  1462       |PNOXNODE nox_NewArray ()                                                                          |   1462
 5770WDS V7R2M0  140418   IBM ILE C compiler      noxdb2.c                           DKSRV206    11-01-22 18:00:09 Page          35
  1463       |{                                                                                                 |   1463
  1464     1 | PNOXNODE  pNode = (PNOXNODE) memAllocClear (sizeof(NOXNODE));                                    |   1464
  1465     2 | pNode->signature  = NODESIG;                                                                     |   1465
  1466     3 | pNode->type       = ARRAY;                                                                       |   1466
  1467     4 | return pNode;                                                                                    |   1467
  1468       |}                                                                                                 |   1468
  1469       |// ---------------------------------------------------------------------------                    |   1469
  1470       |void nox_NodeSet (PNOXNODE pNode , PUCHAR Value)                                                  |   1470
  1471       |{                                                                                                 |   1471
  1472     1 | if (pNode == NULL) return;                                                                       |   1472
  1473       |                                                                                                  |   1473
  1474       | // Remake me as a value node...                                                                  |   1474
  1475     3 | if (pNode->type != VALUE ) {                                                                     |   1475
  1476     4 |  nox_FreeChildren (pNode);                                                                       |   1476
  1477     5 |  pNode->type = VALUE;                                                                            |   1477
  1478       | }                                                                                                |   1478
  1479     6 | freeNodeValue(pNode);                                                                            |   1479
  1480       |                                                                                                  |   1480
  1481     7 | if (Value) {                                                                                     |   1481
  1482     8 |  pNode->Value = memStrDup(Value);                                                                |   1482
  1483       | }                                                                                                |   1483
  1484       |}                                                                                                 |   1484
  1485       |// ---------------------------------------------------------------------------                    |   1485
  1486       |void nox_NodeSetVC (PNOXNODE pNode , PLVARCHAR Value)                                             |   1486
  1487       |{                                                                                                 |   1487
  1488     1 | nox_NodeSet (pNode , plvc2str(Value));                                                           |   1488
  1489       |}                                                                                                 |   1489
  1490       |// ---------------------------------------------------------------------------                    |   1490
  1491       |void nox_NodeSetAsPointer (PNOXNODE pNode , PUCHAR Value)                                         |   1491
  1492       |{                                                                                                 |   1492
  1493     1 | if (pNode == NULL) return;                                                                       |   1493
  1494       |                                                                                                  |   1494
  1495       | // Remake me as a pointer node node...                                                           |   1495
  1496     3 | freeNodeValue(pNode);     // If i was a value - - drop it                                        |   1496
  1497     4 | nox_FreeChildren (pNode);  // Ensure we are only a value                                         |   1497
  1498     5 | pNode->Value     = Value;                                                                        |   1498
  1499     6 | pNode->type      = POINTER_VALUE;                                                                |   1499
  1500     7 | pNode->isLiteral = true; // no escaping and no conversion                                        |   1500
  1501       |}                                                                                                 |   1501
  1502       |// ---------------------------------------------------------------------------                    |   1502
  1503       |void nox_NodeDelete(PNOXNODE pNode)                                                               |   1503
  1504       |{                                                                                                 |   1504
  1505       | PNOXNODE  pTemp;                                                                                 |   1505
  1506       |                                                                                                  |   1506
  1507     1 | if (pNode == NULL) return;                                                                       |   1507
  1508       |                                                                                                  |   1508
 5770WDS V7R2M0  140418   IBM ILE C compiler      noxdb2.c                           DKSRV206    11-01-22 18:00:09 Page          36
  1509     3 | nox_NodeUnlink (pNode);                                                                          |   1509
  1510     4 | nox_FreeChildren (pNode);                                                                        |   1510
  1511     5 | nox_NodeFree(pNode);                                                                             |   1511
  1512       |}                                                                                                 |   1512
  1513       |void nox_Delete(PNOXNODE * pNode)                                                                 |   1513
  1514       |{                                                                                                 |   1514
  1515     1 | nox_NodeDelete(* pNode);                                                                         |   1515
  1516     2 | *pNode = NULL;                                                                                   |   1516
  1517       |}                                                                                                 |   1517
  1518       |// ---------------------------------------------------------------------------                    |   1518
  1519       |// delim was originally only 5.                                                                   |   1519
  1520       |// ---------------------------------------------------------------------------                    |   1520
  1521       |/*                                                                                                |   1521
  1522       |void nox_SetDelimiters(PNOXDELIM pDelim)                                                          |   1522
  1523       |{                                                                                                 |   1523
  1524       | PUCHAR delim = (PUCHAR) pDelim;                                                                  |   1524
  1525       |                                                                                                  |   1525
  1526       | // delim was originally only 5.                                                                  |   1526
  1527       | memcpy(delimiters , pDelim , 5);                                                                 |   1527
  1528       | Slash       = delim [0];                                                                         |   1528
  1529       | BackSlash   = delim [1];                                                                         |   1529
  1530       | MASTERSPACE = delim [2];                                                                         |   1530
  1531       | BRABEG      = delim [3];                                                                         |   1531
  1532       | BRAEND      = delim [4];                                                                         |   1532
  1533       |}                                                                                                 |   1533
  1534       |*/                                                                                                |   1534
  1535       |// ---------------------------------------------------------------------------                    |   1535
  1536       |// New wrapper  - Missing in old "SetDelimiters" - now the string is NULL                         |   1536
  1537       |// terminated to we can just build more on as we go                                               |   1537
  1538       |// ---------------------------------------------------------------------------                    |   1538
  1539       |/*                                                                                                |   1539
  1540       |void nox_SetDelimiters2(PNOXDELIM pDelim)                                                         |   1540
  1541       |{                                                                                                 |   1541
  1542       | int i;                                                                                           |   1542
  1543       | PUCHAR p = (PUCHAR) pDelim;                                                                      |   1543
  1544       | for (i=0; i< sizeof(delimiters) && *p   ; i++,p++) {                                             |   1544
  1545       |   UCHAR c = delimiters [i] = *p;                                                                 |   1545
  1546       |   switch (i) {                                                                                   |   1546
  1547       |    case 0 : Slash       = c; break;                                                              |   1547
  1548       |    case 1 : BackSlash   = c; break;                                                              |   1548
  1549       |    case 2 : MASTERSPACE = c; break;                                                              |   1549
  1550       |    case 3 : BRABEG      = c; break;                                                              |   1550
  1551       |    case 4 : BRAEND      = c; break;                                                              |   1551
  1552       |    case 5 : Blank       = c; break;                                                              |   1552
  1553       |    case 6 : Dot         = c; break;                                                              |   1553
  1554       |    case 7 : CurBeg      = c; break;                                                              |   1554
 5770WDS V7R2M0  140418   IBM ILE C compiler      noxdb2.c                           DKSRV206    11-01-22 18:00:09 Page          37
  1555       |    case 8 : CurEnd      = c; break;                                                              |   1555
  1556       |    case 9 : Apos        = c; break;                                                              |   1556
  1557       |    case 10: Quot        = c; break;                                                              |   1557
  1558       |   }                                                                                              |   1558
  1559       | }                                                                                                |   1559
  1560       |}                                                                                                 |   1560
  1561       |*/                                                                                                |   1561
  1562       |// ---------------------------------------------------------------------------                    |   1562
  1563       |/*                                                                                                |   1563
  1564       |PNOXDELIM nox_GetDelimiters(void)                                                                 |   1564
  1565       |{                                                                                                 |   1565
  1566       | return   (PNOXDELIM)   &delimiters;                                                              |   1566
  1567       |}                                                                                                 |   1567
  1568       |*/                                                                                                |   1568
  1569       |// ---------------------------------------------------------------------------                    |   1569
  1570       |PNOXNODE nox_ParseString(PUCHAR Buf)                                                              |   1570
  1571       |{                                                                                                 |   1571
  1572       | PNOXNODE pRoot;                                                                                  |   1572
  1573       | PNOXCOM  pJxCom;                                                                                 |   1573
  1574       |                                                                                                  |   1574
  1575       | #ifdef MEMDEBUG                                                                                  |   1575
  1576       |  UCHAR  tempStr[100];                                                                            |   1576
  1577       |  substr(tempStr , Buf , 100);                                                                    |   1577
  1578       | #endif                                                                                           |   1578
  1579       |                                                                                                  |   1579
  1580       | // Asume OK                                                                                      |   1580
  1581     1 | jxError = false;                                                                                 |   1581
  1582       |                                                                                                  |   1582
  1583     2 | if (Buf == NULL || *Buf == '\0' ) {                                                              |   1583
  1584     3 |  return NULL;                                                                                    |   1584
  1585       | }                                                                                                |   1585
  1586       | // Is it already a object graph, then return it                                                  |   1586
  1587     4 | if (*Buf == NODESIG) {                                                                           |   1587
  1588     5 |  return (PNOXNODE) Buf;                                                                          |   1588
  1589       | }                                                                                                |   1589
  1590       |                                                                                                  |   1590
  1591     6 | jxMessage[0] = '\0';                                                                             |   1591
  1592       |                                                                                                  |   1592
  1593     7 | pJxCom = memAllocClear (sizeof(NOXCOM));                                                         |   1593
  1594       |                                                                                                  |   1594
  1595     8 | pJxCom->StreamBuf =  Buf;                                                                        |   1595
  1596     9 | pRoot = SelectParser (pJxCom);                                                                   |   1596
  1597       |                                                                                                  |   1597
  1598       | // DEBUGGER TODO !!!                                                                             |   1598
  1599       | #ifdef MEMDEBUG                                                                                  |   1599
  1600       |  printf("\n\nParse String: %p - %-90.90s\n " , pRoot  , tempStr);                                |   1600
 5770WDS V7R2M0  140418   IBM ILE C compiler      noxdb2.c                           DKSRV206    11-01-22 18:00:09 Page          38
  1601       |  memStat();                                                                                      |   1601
  1602       | #endif                                                                                           |   1602
  1603       |                                                                                                  |   1603
  1604    10 | return (pRoot);                                                                                  |   1604
  1605       |}                                                                                                 |   1605
  1606       |// ---------------------------------------------------------------------------                    |   1606
  1607       |PNOXNODE nox_ParseStringVC(PLVARCHAR buf)                                                         |   1607
  1608       |{                                                                                                 |   1608
  1609     1 | return nox_ParseString ( plvc2str (buf));                                                        |   1609
  1610       |}                                                                                                 |   1610
  1611       |// ---------------------------------------------------------------------------                    |   1611
  1612       |PNOXNODE nox_ParseFile(PUCHAR FileName)                                                           |   1612
  1613       |{                                                                                                 |   1613
  1614       |                                                                                                  |   1614
  1615       | PUCHAR  streamBuf;                                                                               |   1615
  1616       | PNOXNODE pRoot;                                                                                  |   1616
  1617       | PUCHAR  pFirstChar;                                                                              |   1617
  1618       | LONG    fileSize;                                                                                |   1618
  1619       | LONG    len ;                                                                                    |   1619
  1620       | FILE  * f;                                                                                       |   1620
  1621       | struct  stat statbuf;                                                                            |   1621
  1622       |                                                                                                  |   1622
  1623     1 | jxMessage[0] = '\0';                                                                             |   1623
  1624       |                                                                                                  |   1624
  1625     2 | f  = fopen(strTrim(FileName), "rb");                                                             |   1625
  1626     3 | if (f  == NULL) {                                                                                |   1626
  1627     4 |  nox_SetMessage( "File %s not open: %s", FileName, strerror(errno));                             |   1627
  1628     5 |  jxError = true;                                                                                 |   1628
  1629     6 |  return NULL;                                                                                    |   1629
  1630       | }                                                                                                |   1630
  1631       |                                                                                                  |   1631
  1632       | // Get the default input ccsid from the file system ( It might be wrong because it is set to def\|   1632
  1632       |ault)                                                                                             |   1632
  1633     7 | fstat(fileno(f), &statbuf);                                                                      |   1633
  1634       |                                                                                                  |   1634
  1635       | // Locate end to find the size of the file                                                       |   1635
  1636     8 | fseek( f , 0L, SEEK_END);                                                                        |   1636
  1637     9 | fileSize = ftell( f );                                                                           |   1637
  1638    10 | fseek( f , 0L, SEEK_SET);                                                                        |   1638
  1639       |                                                                                                  |   1639
  1640       | // read it all                                                                                   |   1640
  1641    11 | streamBuf = memAlloc (fileSize+1);                                                               |   1641
  1642    12 | len = fread(streamBuf, 1 , fileSize  , f );                                                      |   1642
  1643    13 | fclose(f);                                                                                       |   1643
  1644       |                                                                                                  |   1644
  1645    14 | if (len != fileSize) {                                                                           |   1645
 5770WDS V7R2M0  140418   IBM ILE C compiler      noxdb2.c                           DKSRV206    11-01-22 18:00:09 Page          39
  1646    15 |  nox_SetMessage( "File %s was not read", FileName);                                              |   1646
  1647    16 |  jxError = true;                                                                                 |   1647
  1648    17 |  memFree (&streamBuf);                                                                           |   1648
  1649    18 |  return NULL;                                                                                    |   1649
  1650       | }                                                                                                |   1650
  1651       |                                                                                                  |   1651
  1652       | // make it a string                                                                              |   1652
  1653    19 | streamBuf[len] = '\0';                                                                           |   1653
  1654    20 | pRoot = nox_ParseString(streamBuf);                                                              |   1654
  1655    21 | memFree (&streamBuf);                                                                            |   1655
  1656       |                                                                                                  |   1656
  1657    22 | return (pRoot);                                                                                  |   1657
  1658       |}                                                                                                 |   1658
  1659       |/* --------------------------------------------------------------------------- *\                 |   1659
  1660       |  Following routines are for manipulatin with the Xml-Tree inscance                               |   1660
  1661       |\* --------------------------------------------------------------------------- */                 |   1661
  1662       |PNOXNODE nox_GetNodeParent(PNOXNODE pNode)                                                        |   1662
  1663       |{                                                                                                 |   1663
  1664     1 | if (pNode == NULL) return NULL;                                                                  |   1664
  1665     3 | return(pNode->pNodeParent);                                                                      |   1665
  1666       |}                                                                                                 |   1666
  1667       |/* ---------------------------------------------------------------------------                    |   1667
  1668       |  go to the top to find the root                                                                  |   1668
  1669       |  --------------------------------------------------------------------------- */                  |   1669
  1670       |PNOXNODE  nox_GetRoot (PNOXNODE pNode)                                                            |   1670
  1671       |{                                                                                                 |   1671
  1672     1 | int i = 0;                                                                                       |   1672
  1673     2 | if (pNode == NULL) return NULL;                                                                  |   1673
  1674     4 | for(;i<1000;i++) { // avoid loop if self reference - just return any top level                   |   1674
  1675     5 |  if (pNode->signature != NODESIG) return NULL;                                                   |   1675
  1676     7 |  if (pNode->pNodeParent == NULL)  break;                                                         |   1676
  1677     9 |  pNode = pNode->pNodeParent;                                                                     |   1677
  1678       | }                                                                                                |   1678
  1679    10 | return ( pNode);                                                                                 |   1679
  1680       |}                                                                                                 |   1680
  1681       |/* --------------------------------------------------------------------------- */                 |   1681
  1682       |#pragma convert(1252)                                                                             |   1682
  1683       |PNOXNODE nox_lookupByXpath (PNOXNODE pRootNode, PUCHAR * ppName)                                  |   1683
  1684       |{                                                                                                 |   1684
  1685     1 | PUCHAR  Name = * ppName;                                                                         |   1685
  1686     2 | PUCHAR  pEnd = findchr(Name , "=<>" , 3);                                                        |   1686
  1687       | PUCHAR  compVal;                                                                                 |   1687
  1688       | UCHAR   keyName[256];                                                                            |   1688
  1689       | int     nameLen, compLen;                                                                        |   1689
  1690     3 | int     comp =0;                                                                                 |   1690
  1691       |                                                                                                  |   1691
 5770WDS V7R2M0  140418   IBM ILE C compiler      noxdb2.c                           DKSRV206    11-01-22 18:00:09 Page          40
  1692     4 | switch(*pEnd) {                                                                                  |   1692
  1693     5 |  case '=' :  comp = 0 ; break;                                                                   |   1693
  1694     7 |  case '<' :  comp = -1; break;                                                                   |   1694
  1695     9 |  case '>' :  comp = 1 ; break;                                                                   |   1695
  1696       | }                                                                                                |   1696
  1697       |                                                                                                  |   1697
  1698    11 | compVal = pEnd +1;                                                                               |   1698
  1699    12 | for(;*(pEnd-1) == ' '; pEnd--);       // quick trim                                              |   1699
  1700    14 | nameLen = pEnd  - Name;                                                                          |   1700
  1701    15 | substr(keyName , Name , nameLen);                                                                |   1701
  1702       |                                                                                                  |   1702
  1703    16 | for(;*compVal == ' '; compVal++); // Skip blanks                                                 |   1703
  1704    18 | pEnd = strchr (compVal , BRAEND);                                                                |   1704
  1705    19 | if (pEnd == NULL) return NULL;                                                                   |   1705
  1706    21 | compLen = pEnd - compVal;                                                                        |   1706
  1707    22 | *ppName =  *ppName + (pEnd - Name);                                                              |   1707
  1708       |                                                                                                  |   1708
  1709    23 | if (*keyName == MASTERSPACE) {                                                                   |   1709
  1710       |                                                                                                  |   1710
  1711       |  // Find by atribute value                                                                       |   1711
  1712    24 |  PNOXNODE pNodeTemp = pRootNode;                                                                 |   1712
  1713    25 |  substr(keyName , Name+1 , nameLen-1);                                                           |   1713
  1714       |                                                                                                  |   1714
  1715    26 |  while (pNodeTemp && pNodeTemp->signature == NODESIG) {                                          |   1715
  1716    27 |   PNOXATTR pAtr = nox_AttributeLookup  (pNodeTemp, keyName);                                     |   1716
  1717    28 |   if (pAtr && pAtr->Value) {                                                                     |   1717
  1718       |    // Does the value match                                                                       |   1718
  1719       |    if (memicmp(compVal , pAtr->Value, compLen) == comp                                           |   1719
  1720    29 |    &&  pAtr->Value[compLen] == '\0') {                                                           |   1720
  1721    30 |     return pNodeTemp;                                                                            |   1721
  1722       |    }                                                                                             |   1722
  1723       |   }                                                                                              |   1723
  1724    31 |   pNodeTemp=pNodeTemp->pNodeSibling;                                                             |   1724
  1725       |  }                                                                                               |   1725
  1726       |                                                                                                  |   1726
  1727       | } else {                                                                                         |   1727
  1728       |  // Find by value                                                                                |   1728
  1729    32 |  PNOXNODE pNodeTemp = pRootNode == NULL? NULL:pRootNode->pNodeChildHead;                         |   1729
  1730    33 |  while (pNodeTemp && pNodeTemp->signature == NODESIG) {                                          |   1730
  1731    34 |   PNOXNODE pNode = nox_GetNode  (pNodeTemp, keyName);                                            |   1731
  1732    35 |   if (pNode && pNode->Value) {                                                                   |   1732
  1733       |                                                                                                  |   1733
  1734       |    // Does the value match                                                                       |   1734
  1735       |    if (memicmp(compVal , pNode->Value, compLen) == comp                                          |   1735
  1736    36 |    &&  pNode->Value[compLen] == '\0') {                                                          |   1736
  1737    37 |     return pNodeTemp;                                                                            |   1737
 5770WDS V7R2M0  140418   IBM ILE C compiler      noxdb2.c                           DKSRV206    11-01-22 18:00:09 Page          41
  1738       |    }                                                                                             |   1738
  1739       |   }                                                                                              |   1739
  1740    38 |   pNodeTemp=pNodeTemp->pNodeSibling;                                                             |   1740
  1741       |  }                                                                                               |   1741
  1742       | }                                                                                                |   1742
  1743    39 | return NULL;                                                                                     |   1743
  1744       |                                                                                                  |   1744
  1745       |}                                                                                                 |   1745
  1746       |#pragma convert(0)                                                                                |   1746
  1747       |/* --------------------------------------------------------------------------- */                 |   1747
  1748       |PUCHAR nox_NodeName (PNOXNODE pNode,BOOL SkipNameSpace)                                           |   1748
  1749       |{                                                                                                 |   1749
  1750       | PUCHAR p;                                                                                        |   1750
  1751       |                                                                                                  |   1751
  1752     1 | if (pNode == NULL ) return NULL;                                                                 |   1752
  1753     3 | p = pNode->Name;                                                                                 |   1753
  1754     4 | if (p == NULL) return NULL;                                                                      |   1754
  1755       |                                                                                                  |   1755
  1756     6 | if (SkipNameSpace) {                                                                             |   1756
  1757       |  PUCHAR temp;                                                                                    |   1757
  1758     7 |  temp  = strchr(p , ':');                                                                        |   1758
  1759     8 |  if (temp) {                                                                                     |   1759
  1760     9 |   return  temp + 1 ; // Just after the :                                                         |   1760
  1761       |  }                                                                                               |   1761
  1762       | }                                                                                                |   1762
  1763    10 | return p;                                                                                        |   1763
  1764       |}                                                                                                 |   1764
  1765       |/* --------------------------------------------------------------------------- */                 |   1765
  1766       |nox_NodeNameVC (PLVARCHAR name, PNOXNODE pNode,BOOL SkipNameSpace)                                |   1766
  1767       |{                                                                                                 |   1767
  1768     1 | str2plvc(name , nox_NodeName (pNode,SkipNameSpace));                                             |   1768
  1769       |}                                                                                                 |   1769
  1770       |                                                                                                  |   1770
  1771       |/* --------------------------------------------------------------------------- */                 |   1771
  1772       |PNOXNODE  nox_FindNodeAtIndex(PNOXNODE pNode , PUCHAR Key , int index , BOOL SkipNameSpace)       |   1772
  1773       |{                                                                                                 |   1773
  1774     1 | int i =0;                                                                                        |   1774
  1775       | PUCHAR CurName;                                                                                  |   1775
  1776       |                                                                                                  |   1776
  1777     2 | while (pNode) {                                                                                  |   1777
  1778       |                                                                                                  |   1778
  1779     3 |  CurName = nox_NodeName (pNode, SkipNameSpace);                                                  |   1779
  1780     4 |  if (CurName && stricmp(Key , CurName) == 0) {                                                   |   1780
  1781     5 |   if (index == i) return (pNode); // Found :)                                                    |   1781
  1782     7 |   i++;                                                                                           |   1782
  1783       |  }                                                                                               |   1783
 5770WDS V7R2M0  140418   IBM ILE C compiler      noxdb2.c                           DKSRV206    11-01-22 18:00:09 Page          42
  1784     8 |  pNode=pNode->pNodeSibling;                                                                      |   1784
  1785       | }                                                                                                |   1785
  1786     9 | return NULL;                                                                                     |   1786
  1787       |}                                                                                                 |   1787
  1788       |/* --------------------------------------------------------------------------- */                 |   1788
  1789       |/**********'' OLD                                                                                 |   1789
  1790       |void nox_GetKeyFromName (PUCHAR tempKey , PBOOL SkipNameSpace , PUCHAR KeyName , PUCHAR SearchNam\|   1790
  1790       |e)                                                                                                |   1790
  1791       |{                                                                                                 |   1791
  1792       |  int l=0;                                                                                        |   1792
  1793       |                                                                                                  |   1793
  1794       |  for (;  *KeyName != Slash && KeyName >= SearchName ; KeyName--, l++);                           |   1794
  1795       |  KeyName++;                                                                                      |   1795
  1796       |  *SkipNameSpace = (* KeyName  == '*');                                                           |   1796
  1797       |  if (*SkipNameSpace) {                                                                           |   1797
  1798       |   KeyName+= 2; // Skip the *:                                                                    |   1798
  1799       |   l-= 2; // Skip the *:                                                                          |   1799
  1800       |  } else {                                                                                        |   1800
  1801       |   *SkipNameSpace = (memchr(KeyName , ':' , l) == NULL);                                          |   1801
  1802       |  }                                                                                               |   1802
  1803       |  substr(tempKey , KeyName, l);                                                                   |   1803
  1804       |}                                                                                                 |   1804
  1805       |*/                                                                                                |   1805
  1806       |void nox_GetKeyFromName (PUCHAR tempKey , PBOOL SkipNameSpace , PUCHAR prevKey)                   |   1806
  1807       |{                                                                                                 |   1807
  1808     1 | *SkipNameSpace = (strchr(prevKey, COLON) == NULL);                                               |   1808
  1809     2 | strcpy (tempKey , prevKey);                                                                      |   1809
  1810       |}                                                                                                 |   1810
  1811       |/* ---------------------------------------------------------------------------                    |   1811
  1812       |  Find node by name, by parsing a name string and traverse the tree                               |   1812
  1813       |  The Node can be the casted to the xml root                                                      |   1813
  1814       |  --------------------------------------------------------------------------- */                  |   1814
  1815       |static BOOL isNextDelimiter(UCHAR c)                                                              |   1815
  1816       |{                                                                                                 |   1816
  1817     1 | return c == BACKSLASH || c  == SLASH || c == DOT;                                                |   1817
  1818       |}                                                                                                 |   1818
  1819       |/* ---------------------------------------------------------------------------                    |   1819
  1820       |  name contains [UBOUND]                                                                          |   1820
  1821       |  --------------------------------------------------------------------------- */                  |   1821
  1822       |#pragma convert(1252)                                                                             |   1822
  1823       |BOOL nox_isUbound (PUCHAR name)                                                                   |   1823
  1824       |{                                                                                                 |   1824
  1825     1 | return (memicmp(name  , "[UBOUND]" , 8) == 0);                                                   |   1825
  1826       |}                                                                                                 |   1826
  1827       |#pragma convert(0)                                                                                |   1827
  1828       |/* ---------------------------------------------------------------------------                    |   1828
 5770WDS V7R2M0  140418   IBM ILE C compiler      noxdb2.c                           DKSRV206    11-01-22 18:00:09 Page          43
  1829       |  Set the counter                                                                                 |   1829
  1830       |  --------------------------------------------------------------------------- */                  |   1830
  1831       |PNOXNODE nox_CountChildren(PNOXNODE pNode)                                                        |   1831
  1832       |{                                                                                                 |   1832
  1833       | PNOXNODE p;                                                                                      |   1833
  1834       |                                                                                                  |   1834
  1835       | // Arrays are already counted                                                                    |   1835
  1836     1 | if (pNode->type == ARRAY) {                                                                      |   1836
  1837     2 |  return pNode;   // Already counted                                                              |   1837
  1838       | }                                                                                                |   1838
  1839       |                                                                                                  |   1839
  1840       | // Now count each child                                                                          |   1840
  1841     3 | pNode->Count = 0;                                                                                |   1841
  1842     4 | p=pNode->pNodeChildHead;                                                                         |   1842
  1843     5 | while (p) {                                                                                      |   1843
  1844     6 |  pNode->Count ++;                                                                                |   1844
  1845     7 |  p=p->pNodeSibling;                                                                              |   1845
  1846       | }                                                                                                |   1846
  1847       |}                                                                                                 |   1847
  1848       |/* ---------------------------------------------------------------------------                    |   1848
  1849       |  Return the node ; With counter flag or not                                                      |   1849
  1850       |  --------------------------------------------------------------------------- */                  |   1850
  1851       |static PNOXNODE nox_ReturnNode (PNOXNODE pNode, BOOL asCounter)                                   |   1851
  1852       |{                                                                                                 |   1852
  1853     1 | if (pNode) pNode->doCount = asCounter;                                                           |   1853
  1854     3 | nox_traceNode("GetNode return", pNode);                                                          |   1854
  1855     4 | return pNode;                                                                                    |   1855
  1856       |}                                                                                                 |   1856
  1857       |/* ---------------------------------------------------------------------------                    |   1857
  1858       |  Return the node with name match                                                                 |   1858
  1859       |  --------------------------------------------------------------------------- */                  |   1859
  1860       |static PNOXNODE nox_lookUpSiblingByName(PNOXNODE pNode , PUCHAR keyName)                          |   1860
  1861       |{                                                                                                 |   1861
  1862       | PUCHAR curName;                                                                                  |   1862
  1863       | BOOL   SkipNameSpace;                                                                            |   1863
  1864       |                                                                                                  |   1864
  1865     1 | SkipNameSpace = (strchr(keyName , COLON) == NULL);                                               |   1865
  1866       |                                                                                                  |   1866
  1867       | // Locate name match                                                                             |   1867
  1868     2 | while (pNode) {                                                                                  |   1868
  1869     3 |  curName = nox_NodeName (pNode,SkipNameSpace);                                                   |   1869
  1870       |                                                                                                  |   1870
  1871     4 |  if (curName == NULL ) {                                                                         |   1871
  1872     5 |   pNode=pNode->pNodeSibling;                                                                     |   1872
  1873     6 |   continue;                                                                                      |   1873
  1874       |  }                                                                                               |   1874
 5770WDS V7R2M0  140418   IBM ILE C compiler      noxdb2.c                           DKSRV206    11-01-22 18:00:09 Page          44
  1875       |                                                                                                  |   1875
  1876       |  // Name Match ? Go one step deeper                                                              |   1876
  1877     7 |  if (stricmp(keyName, curName) == 0) {  // Found                                                 |   1877
  1878     8 |   return pNode;  // This level found, setup for itterarion                                       |   1878
  1879       |  }                                                                                               |   1879
  1880       |  // No ! try next                                                                                |   1880
  1881     9 |  pNode=pNode->pNodeSibling;                                                                      |   1881
  1882       | }                                                                                                |   1882
  1883       |                                                                                                  |   1883
  1884    10 | return NULL;                                                                                     |   1884
  1885       |}                                                                                                 |   1885
  1886       |/* ---------------------------------------------------------------------------                    |   1886
  1887       |  count nodes with same name                                                                      |   1887
  1888       |  --------------------------------------------------------------------------- */                  |   1888
  1889       |static PNOXNODE nox_CalculateUbound(PNOXNODE pNode , PUCHAR key , BOOL SkipNameSpace)             |   1889
  1890       |{                                                                                                 |   1890
  1891       |                                                                                                  |   1891
  1892     1 | PNOXNODE pNodeTemp = pNode;                                                                      |   1892
  1893       |                                                                                                  |   1893
  1894       | // JSON has an array type                                                                        |   1894
  1895     2 | if (pNode == NULL) return NULL;                                                                  |   1895
  1896       |                                                                                                  |   1896
  1897       | // JSON can count faster:                                                                        |   1897
  1898     4 | if (pNode->type == ARRAY || pNode->type == OBJECT) {                                             |   1898
  1899     5 |  nox_CountChildren(pNode);                                                                       |   1899
  1900     6 |  return nox_ReturnNode (pNode, true ); // Done !! return the current node with the counter updat\|   1900
  1900       |ed                                                                                                |   1900
  1901       | }                                                                                                |   1901
  1902       |                                                                                                  |   1902
  1903     7 | pNode->Count = 0;                                                                                |   1903
  1904       |                                                                                                  |   1904
  1905     8 | while (pNodeTemp) {                                                                              |   1905
  1906       |  // Skip namespace ? - when namespace is a *:                                                    |   1906
  1907     9 |  PUCHAR CurName = nox_NodeName (pNodeTemp, SkipNameSpace);                                       |   1907
  1908    10 |  if (CurName && stricmp(key , CurName) == 0) {                                                   |   1908
  1909    11 |   pNode->Count ++;                                                                               |   1909
  1910       |  }                                                                                               |   1910
  1911    12 |  pNodeTemp=pNodeTemp->pNodeSibling;                                                              |   1911
  1912       | }                                                                                                |   1912
  1913    13 | return nox_ReturnNode (pNode, true ); // Done !! return the current node with the counter updated|   1913
  1914       |}                                                                                                 |   1914
  1915       |/* ---------------------------------------------------------------------------                    |   1915
  1916       |  Use index subscription to locate the node                                                       |   1916
  1917       |  --------------------------------------------------------------------------- */                  |   1917
  1918       |static PNOXNODE nox_lookupByIndex(PNOXNODE pNode , PUCHAR tempKey , int Index, BOOL SkipNameSpace)|   1918
  1919       |{                                                                                                 |   1919
 5770WDS V7R2M0  140418   IBM ILE C compiler      noxdb2.c                           DKSRV206    11-01-22 18:00:09 Page          45
  1920     1 | if (pNode == NULL) return NULL;                                                                  |   1920
  1921       |                                                                                                  |   1921
  1922       | // JSON only can do fast array and object lookup                                                 |   1922
  1923     3 | if (pNode->type == ARRAY || pNode->type == OBJECT) {                                             |   1923
  1924       |  int i;                                                                                          |   1924
  1925     4 |  pNode = pNode->pNodeChildHead;                                                                  |   1925
  1926     5 |  for (i=0 ; i < Index ; i++) {                                                                   |   1926
  1927     6 |   if (pNode == NULL) return NULL;                                                                |   1927
  1928     8 |   pNode=pNode->pNodeSibling;                                                                     |   1928
  1929       |  }                                                                                               |   1929
  1930     9 |  return pNode;                                                                                   |   1930
  1931    10 | } else if (pNode->type == VALUE) {                                                               |   1931
  1932    11 |  return NULL; // Indexing values makes no sense - This is only for JSON; JSON sets the pNode->ty\|   1932
  1932       |pe                                                                                                |   1932
  1933       | } else {                                                                                         |   1933
  1934    12 |  return nox_FindNodeAtIndex(pNode , tempKey , Index , SkipNameSpace);                            |   1934
  1935       | }                                                                                                |   1935
  1936       |}                                                                                                 |   1936
  1937       |/* ---------------------------------------------------------------------------                    |   1937
  1938       |  Get the numeric portion between two memory locations                                            |   1938
  1939       |  This has to be conservative: if not every characters                                            |   1939
  1940       |  is numeric we return -1 for not fully numeric                                                   |   1940
  1941       |  --------------------------------------------------------------------------- */                  |   1941
  1942       |#pragma convert(1252)                                                                             |   1942
  1943       |int nox_getNumericKey (PUCHAR pStr, PUCHAR pEnd)                                                  |   1943
  1944       |{                                                                                                 |   1944
  1945     1 | int index = 0;                                                                                   |   1945
  1946       |                                                                                                  |   1946
  1947     2 | while(pStr < pEnd ) {                                                                            |   1947
  1948     3 |  if (*pStr  >= '0' && *pStr  <= '9') {                                                           |   1948
  1949     4 |   index = 10 * index + (*pStr - '0');                                                            |   1949
  1950       |  } else {    // Not numeric => Stop the loop                                                     |   1950
  1951     5 |   return -1;                                                                                     |   1951
  1952       |  }                                                                                               |   1952
  1953     6 |  pStr++;                                                                                         |   1953
  1954       | }                                                                                                |   1954
  1955     7 | return index;                                                                                    |   1955
  1956       |}                                                                                                 |   1956
  1957       |#pragma convert(0)                                                                                |   1957
  1958       |/* ---------------------------------------------------------------------------                    |   1958
  1959       |  Find node by name, by parsing a name string and traverse the tree                               |   1959
  1960       |  --------------------------------------------------------------------------- */                  |   1960
  1961       |PNOXNODE nox_GetNode  (PNOXNODE pNode, PUCHAR Name)                                               |   1961
  1962       |{                                                                                                 |   1962
  1963     1 | PUCHAR  pStart   = Name;                                                                         |   1963
  1964     2 | PNOXNODE pNodeTemp = NULL;                                                                       |   1964
 5770WDS V7R2M0  140418   IBM ILE C compiler      noxdb2.c                           DKSRV206    11-01-22 18:00:09 Page          46
  1965     3 | BOOL    Found = FALSE;                                                                           |   1965
  1966     4 | int     Len=0, l , i, StartIx;                                                                   |   1966
  1967       | LONG    index;                                                                                   |   1967
  1968     5 | PUCHAR  p, pName, pEnd = "";                                                                     |   1968
  1969       | PNOXNODE refNode;                                                                                |   1969
  1970       | UCHAR   refName [256];                                                                           |   1970
  1971       |                                                                                                  |   1971
  1972       | if (pNode == NULL                                                                                |   1972
  1973     6 | ||  pNode->signature != NODESIG) {                                                               |   1973
  1974     7 |  return NULL;                                                                                    |   1974
  1975       | }                                                                                                |   1975
  1976       |                                                                                                  |   1976
  1977       | // You can change the "debug" in a debugsession to dump the source node                          |   1977
  1978     8 | nox_traceNode ( "GetNode " , pNode);                                                             |   1978
  1979       |                                                                                                  |   1979
  1980       | // Only "/" in the name ... that is my self                                                      |   1980
  1981     9 | if (Name == NULL || *Name == '\0'  ) {                                                           |   1981
  1982    10 |  return nox_ReturnNode (pNode, false); // Done !! Just want the root                             |   1982
  1983       | }                                                                                                |   1983
  1984       | // Ubound on the root node                                                                       |   1984
  1985    11 | if (nox_isUbound(Name)) {                                                                        |   1985
  1986    12 |  nox_CountChildren(pNode);                                                                       |   1986
  1987    13 |  return nox_ReturnNode (pNode, true ); // Done !! return the current node with the counter updat\|   1987
  1987       |ed                                                                                                |   1987
  1988       | }                                                                                                |   1988
  1989       |                                                                                                  |   1989
  1990    14 | if (isNextDelimiter(*Name)) {                                                                    |   1990
  1991    15 |  pNode = nox_GetRoot(pNode);                                                                     |   1991
  1992    16 |  Name++; // Skip root                                                                            |   1992
  1993       |  // dont do this - list will break since it will use the firs child on the list .. see later:    |   1993
  1994       |  // if (*Name == '\0') return nox_ReturnNode (pNode, false);; // Done                            |   1994
  1995       | }                                                                                                |   1995
  1996       |                                                                                                  |   1996
  1997       |                                                                                                  |   1997
  1998       | // By default we are searching for Nodeents in objects hench Start with the                      |   1998
  1999       | // First child and match; if OK the take the next level etc                                      |   1999
  2000       | // However - the level can be restored to the object for ie [UBOUND] or index lookup like: [123] |   2000
  2001    17 | if (*Name != BRABEG) {                                                                           |   2001
  2002    18 |  pNode = pNode->pNodeChildHead;                                                                  |   2002
  2003       |  // .. but we can do it here: baically: "/" gives the first child to the root                    |   2003
  2004    19 |  if (*Name == '\0') return nox_ReturnNode (pNode, false);; // Done                               |   2004
  2005       | }                                                                                                |   2005
  2006       |                                                                                                  |   2006
  2007       | // Setup for iteration                                                                           |   2007
  2008    22 | *refName = '\0';                                                                                 |   2008
  2009    23 | refNode = pNode;                                                                                 |   2009
 5770WDS V7R2M0  140418   IBM ILE C compiler      noxdb2.c                           DKSRV206    11-01-22 18:00:09 Page          47
  2010    24 | pName = Name;                                                                                    |   2010
  2011       |                                                                                                  |   2011
  2012    25 | for (;;) {                                                                                       |   2012
  2013       |                                                                                                  |   2013
  2014       |  // No node or dead node                                                                         |   2014
  2015       |  if (pNode == NULL                                                                               |   2015
  2016    26 |  ||  pNode->signature != NODESIG) {                                                              |   2016
  2017    27 |   return NULL;                                                                                   |   2017
  2018       |  }                                                                                               |   2018
  2019       |                                                                                                  |   2019
  2020       |  // Find delimiter, find the end of this token                                                   |   2020
  2021    28 |  if (*pEnd == BRABEG) {                                                                          |   2021
  2022    29 |   pEnd = strchr ( pName , BRAEND);                                                               |   2022
  2023       |  } else {                                                                                        |   2023
  2024    30 |   pEnd = findchr(pName , delimiters , sizeof(DELIMITERS)-1); // Not the zerotermination included |   2024
  2025       |  }                                                                                               |   2025
  2026       |                                                                                                  |   2026
  2027       |  // No Bytes remaining => End of name = rest of string                                           |   2027
  2028    31 |  if ( pEnd == NULL ) {                                                                           |   2028
  2029    32 |   pEnd = pName + strlen(pName);                                                                  |   2029
  2030       |  }                                                                                               |   2030
  2031       |                                                                                                  |   2031
  2032       |  // Break at empty arrays: []  otherwise the "set value will find the array root !!              |   2032
  2033       |  // Empty arrays does not exists but is rather an indications of a new array element has to be a\|   2033
  2033       |ppended                                                                                           |   2033
  2034    33 |  else if (pEnd[0] == BRABEG && pEnd[1] == BRAEND) {                                              |   2034
  2035    34 |   return NULL;                                                                                   |   2035
  2036       |  }                                                                                               |   2036
  2037       |                                                                                                  |   2037
  2038    35 |  Len = pEnd - pName;                                                                             |   2038
  2039       |                                                                                                  |   2039
  2040       |  // Check for anonymous object and array in the root  TODO this need to be allowed               |   2040
  2041    36 |  if (*pName == BRABEG && Len == 0) {                                                             |   2041
  2042    37 |   pName ++;                                                                                      |   2042
  2043    38 |   continue;                                                                                      |   2043
  2044       |  }                                                                                               |   2044
  2045       |                                                                                                  |   2045
  2046       |  // Check for special names: Subscriptions and Ubound like yy/xx[UBOUND]                         |   2046
  2047       |  // Note: This uses the refrecene name "refName" which is the last "real name" from the parser   |   2047
  2048    39 |  if ( pName > pStart && *(pName-1)  == BRABEG) {                                                 |   2048
  2049       |   UCHAR  tempKey [256];                                                                          |   2049
  2050       |   BOOL   SkipNameSpace;                                                                          |   2050
  2051    40 |   nox_GetKeyFromName (tempKey , &SkipNameSpace , refName);                                       |   2051
  2052       |                                                                                                  |   2052
  2053       |   #pragma convert(1252)                                                                          |   2053
  2054    41 |   if (memicmp (pName , UBOUND , 6) == 0) {                                                       |   2054
 5770WDS V7R2M0  140418   IBM ILE C compiler      noxdb2.c                           DKSRV206    11-01-22 18:00:09 Page          48
  2055    42 |    return nox_CalculateUbound(refNode, tempKey, SkipNameSpace);                                  |   2055
  2056       |   }                                                                                              |   2056
  2057       |   #pragma convert(0)                                                                             |   2057
  2058       |                                                                                                  |   2058
  2059       |   // .. If the name is numeric, it is a subscription                                             |   2059
  2060    43 |   index = nox_getNumericKey (pName , pEnd);                                                      |   2060
  2061       |                                                                                                  |   2061
  2062       |   // When a subscription is found, then locate the occurens                                      |   2062
  2063    44 |   if (index >= 0) {                                                                              |   2063
  2064    45 |    pNode = nox_lookupByIndex(refNode , tempKey, index, SkipNameSpace);                           |   2064
  2065       |   } else {                                                                                       |   2065
  2066       |    // X-path Nodeent search:                                                                     |   2066
  2067    46 |    pNode = nox_lookupByXpath(refNode , &pName);                                                  |   2067
  2068    47 |    pEnd = pName +1;                                                                              |   2068
  2069       |   }                                                                                              |   2069
  2070    48 |   if (pNode == NULL) return NULL;                                                                |   2070
  2071       |                                                                                                  |   2071
  2072       |  } else {                                                                                        |   2072
  2073       |   // "Normal" nodes with "normal" names. Store the name for furthere references "refName"        |   2073
  2074    50 |   substr(refName, pName, Len);                                                                   |   2074
  2075    51 |   pNode = nox_lookUpSiblingByName(pNode , refName);                                              |   2075
  2076       |  }                                                                                               |   2076
  2077       |                                                                                                  |   2077
  2078       |  // Current node will be our reference node for subsequent iterations                            |   2078
  2079    52 |  refNode = pNode;                                                                                |   2079
  2080       |                                                                                                  |   2080
  2081       |  // Skip trailing "]" and blanks                                                                 |   2081
  2082    53 |  for (; *pEnd == BRAEND || *pEnd == BLANK ; pEnd++);    // the ']'                               |   2082
  2083       |                                                                                                  |   2083
  2084       |  // This level found. Iterate on next name                                                       |   2084
  2085    55 |  if (*pEnd > '\0') { // Otherwise past end of string                                             |   2085
  2086    56 |   if (*pEnd != BRABEG) {                                                                         |   2086
  2087       |    // Found but empty or dead                                                                    |   2087
  2088       |    if (pNode == NULL                                                                             |   2088
  2089    57 |    ||  pNode->signature != NODESIG) {                                                            |   2089
  2090    58 |     return NULL;                                                                                 |   2090
  2091       |    }                                                                                             |   2091
  2092       |                                                                                                  |   2092
  2093    59 |    pNode = pNode->pNodeChildHead;                                                                |   2093
  2094       |   }                                                                                              |   2094
  2095    60 |   pName = pEnd +1 ; // Skip the '.' or '/' and set up next iteration                             |   2095
  2096       |                                                                                                  |   2096
  2097       |  } else {                                                                                        |   2097
  2098    61 |   return nox_ReturnNode (pNode, false ); // Done !! return the current node with the counter upd\|   2098
  2098       |ated                                                                                              |   2098
  2099       |  }                                                                                               |   2099
 5770WDS V7R2M0  140418   IBM ILE C compiler      noxdb2.c                           DKSRV206    11-01-22 18:00:09 Page          49
  2100       | }                                                                                                |   2100
  2101       |}                                                                                                 |   2101
  2102       |/* ---------------------------------------------------------------------------                    |   2102
  2103       |  Find node by name, by parsing a name string and traverse the tree                               |   2103
  2104       |  --------------------------------------------------------------------------- */                  |   2104
  2105       |PNOXNODE nox_GetNodeVC  (PNOXNODE pNode, PLVARCHAR pName)                                         |   2105
  2106       |{                                                                                                 |   2106
  2107     1 | return nox_GetNode (pNode , plvc2str(pName));                                                    |   2107
  2108       |}                                                                                                 |   2108
  2109       |/* ------------------------------------------------------------- */                               |   2109
  2110       |LGL nox_Has  (PNOXNODE pNode, PUCHAR Name)                                                        |   2110
  2111       |{                                                                                                 |   2111
  2112     1 | PNOXNODE p = nox_GetNode  (pNode, Name);                                                         |   2112
  2113     2 | if (p == NULL) return OFF;                                                                       |   2113
  2114     4 | if (p->type == VALUE) {                                                                          |   2114
  2115     5 |  if (p->Value == NULL) return OFF;                                                               |   2115
  2116     7 |  if (p->isLiteral && memBeginsWith(p->Value, "null")) return OFF;                                |   2116
  2117       | }                                                                                                |   2117
  2118     9 | return (ON );                                                                                    |   2118
  2119       |}                                                                                                 |   2119
  2120       |LGL nox_HasVC  (PNOXNODE pNode, PLVARCHAR  pName)                                                 |   2120
  2121       |{                                                                                                 |   2121
  2122     1 | return nox_Has  (pNode, plvc2str(pName));                                                        |   2122
  2123       |}                                                                                                 |   2123
  2124       |/* ------------------------------------------------------------- */                               |   2124
  2125       |LGL nox_IsTrue  (PNOXNODE pNode, PUCHAR Name)                                                     |   2125
  2126       |{                                                                                                 |   2126
  2127     1 | PNOXNODE p = nox_GetNode  (pNode, Name);                                                         |   2127
  2128     2 | if (p == NULL) return OFF;                                                                       |   2128
  2129     4 | if (p->type == VALUE) {                                                                          |   2129
  2130     5 |  if (p->Value == NULL)  return OFF;                                                              |   2130
  2131     7 |  if (p->Value[0] == 0 ) return OFF;                                                              |   2131
  2132     9 |  if (p->Value[0] == '0' && p->Value[1] == 0 )  return OFF;                                       |   2132
  2133    11 |  if (p->isLiteral && memBeginsWith(p->Value, "false")) return OFF;                               |   2133
  2134       | }                                                                                                |   2134
  2135    13 | return (ON );                                                                                    |   2135
  2136       |}                                                                                                 |   2136
  2137       |LGL nox_IsTrueVC  (PNOXNODE pNode, PLVARCHAR  pName)                                              |   2137
  2138       |{                                                                                                 |   2138
  2139     1 | return nox_IsTrue  (pNode, plvc2str(pName));                                                     |   2139
  2140       |}                                                                                                 |   2140
  2141       |/* ------------------------------------------------------------- */                               |   2141
  2142       |LGL nox_IsNull  (PNOXNODE pNode, PUCHAR Name)                                                     |   2142
  2143       |{                                                                                                 |   2143
  2144     1 | PNOXNODE p = nox_GetNode  (pNode, Name);                                                         |   2144
  2145     2 | if (p == NULL) return ON;                                                                        |   2145
 5770WDS V7R2M0  140418   IBM ILE C compiler      noxdb2.c                           DKSRV206    11-01-22 18:00:09 Page          50
  2146     4 | if (p->type == VALUE) {                                                                          |   2146
  2147     5 |  if (p->Value == NULL)  return ON;                                                               |   2147
  2148       | }                                                                                                |   2148
  2149     7 | return (OFF);                                                                                    |   2149
  2150       |}                                                                                                 |   2150
  2151       |LGL nox_IsNullVC  (PNOXNODE pNode, PLVARCHAR  pName)                                              |   2151
  2152       |{                                                                                                 |   2152
  2153     1 | return nox_IsNull  (pNode, plvc2str(pName));                                                     |   2153
  2154       |}                                                                                                 |   2154
  2155       |/* ------------------------------------------------------------- */                               |   2155
  2156       |LGL nox_isNode  (PNOXNODE pNode)                                                                  |   2156
  2157       |{                                                                                                 |   2157
  2158       | return (                                                                                         |   2158
  2159       |     (pNode == NULL)                                                                              |   2159
  2160       |  || (pNode->signature != NODESIG)                                                                |   2160
  2161       |  ? OFF : ON                                                                                      |   2161
  2162     1 | );                                                                                               |   2162
  2163       |}                                                                                                 |   2163
  2164       |/* -------------------------------------------------------------                                  |   2164
  2165       |  Find attribute to a Nodeent; traverse the chain                                                 |   2165
  2166       |  ------------------------------------------------------------- */                                |   2166
  2167       |PNOXATTR nox_AttributeLookup   (PNOXNODE pNode, PUCHAR Name)                                      |   2167
  2168       |{                                                                                                 |   2168
  2169       | PNOXATTR pAttr;                                                                                  |   2169
  2170       | SHORT    NameLen;                                                                                |   2170
  2171     1 | if (pNode == NULL) {                                                                             |   2171
  2172     2 |  return NULL;                                                                                    |   2172
  2173       | }                                                                                                |   2173
  2174       |                                                                                                  |   2174
  2175     3 | NameLen = strlen (Name);                                                                         |   2175
  2176     4 | for (; NameLen > 1 && Name[NameLen-1] <= ' '; NameLen--); // Trim Left lenght                    |   2176
  2177       |                                                                                                  |   2177
  2178     6 | pAttr = pNode->pAttrList;                                                                        |   2178
  2179       |                                                                                                  |   2179
  2180     7 | while (pAttr) {                                                                                  |   2180
  2181       |  if (memicmp (Name ,pAttr->Name , NameLen ) == 0                                                 |   2181
  2182     8 |  &&  pAttr->Name[NameLen] == '\0') {                                                             |   2182
  2183     9 |   return (pAttr);                                                                                |   2183
  2184       |  }                                                                                               |   2184
  2185    10 |  pAttr = pAttr->pAttrSibling;                                                                    |   2185
  2186       | }                                                                                                |   2186
  2187    11 | return (NULL);                                                                                   |   2187
  2188       |}                                                                                                 |   2188
  2189       |PNOXATTR nox_AttributeLookupVC   (PNOXNODE pNode, PLVARCHAR Name)                                 |   2189
  2190       |{                                                                                                 |   2190
  2191     1 | return nox_AttributeLookup   (pNode, plvc2str(Name));                                            |   2191
 5770WDS V7R2M0  140418   IBM ILE C compiler      noxdb2.c                           DKSRV206    11-01-22 18:00:09 Page          51
  2192       |}                                                                                                 |   2192
  2193       |/* -------------------------------------------------------------                                  |   2193
  2194       |  returns the value of the node                                                                   |   2194
  2195       |  ------------------------------------------------------------- */                                |   2195
  2196       |PNOXNODE nox_GetNodeByName  (PNOXNODE  pNode, PUCHAR Ctlstr , ... )                               |   2196
  2197       |{                                                                                                 |   2197
  2198       | va_list arg_ptr;                                                                                 |   2198
  2199       | UCHAR Name[1024];                                                                                |   2199
  2200       | SHORT l;                                                                                         |   2200
  2201       | PNOXNODE pNodeOut;                                                                               |   2201
  2202       |                                                                                                  |   2202
  2203       | // Build a temp string with the formated data                                                    |   2203
  2204     1 | va_start(arg_ptr, Ctlstr);                                                                       |   2204
  2205     2 | l = vsprintf(Name, Ctlstr, arg_ptr);                                                             |   2205
  2206     3 | va_end(arg_ptr);                                                                                 |   2206
  2207       |                                                                                                  |   2207
  2208     4 | pNodeOut = nox_GetNode(pNode, Name);                                                             |   2208
  2209     5 | return (pNodeOut);                                                                               |   2209
  2210       |}                                                                                                 |   2210
  2211       |/* -------------------------------------------------------------                                  |   2211
  2212       |  returns the value of the node                                                                   |   2212
  2213       |  ------------------------------------------------------------- */                                |   2213
  2214       |PUCHAR  nox_GetNodeValuePtr  (PNOXNODE pNode , PUCHAR DefaultValue)                               |   2214
  2215       |{                                                                                                 |   2215
  2216     1 | PNPMPARMLISTADDRP pParms = _NPMPARMLISTADDR();                                                   |   2216
  2217       | if (pNode == NULL                                                                                |   2217
  2218     2 | ||  pNode->Value == NULL){                                                                       |   2218
  2219     3 |  return (pParms->OpDescList->NbrOfParms >= 2 ? DefaultValue : NULL);                             |   2219
  2220       | } else {                                                                                         |   2220
  2221     4 |  return (pNode->Value);                                                                          |   2221
  2222       | }                                                                                                |   2222
  2223       |}                                                                                                 |   2223
  2224       |/* -------------------------------------------------------------                                  |   2224
  2225       |  returns the value of the node                                                                   |   2225
  2226       |  ------------------------------------------------------------- */                                |   2226
  2227       |PUCHAR  nox_GetNodeAttrValuePtr  (PNOXNODE pNode , PUCHAR AttrName, PUCHAR DefaultValue)          |   2227
  2228       |{                                                                                                 |   2228
  2229       | PNOXATTR pAttr;                                                                                  |   2229
  2230       |                                                                                                  |   2230
  2231     1 | pAttr = nox_AttributeLookup   (pNode, AttrName);                                                 |   2231
  2232       | if (pAttr == NULL                                                                                |   2232
  2233     2 | ||  pAttr->Value == NULL) {                                                                      |   2233
  2234     3 |  return ( DefaultValue);                                                                         |   2234
  2235       | } else {                                                                                         |   2235
  2236     4 |  return pAttr->Value;                                                                            |   2236
  2237       | }                                                                                                |   2237
 5770WDS V7R2M0  140418   IBM ILE C compiler      noxdb2.c                           DKSRV206    11-01-22 18:00:09 Page          52
  2238       |}                                                                                                 |   2238
  2239       |/* -------------------------------------------------------------                                  |   2239
  2240       |  Add a attribute to the end of the attribute list for an Nodeent                                 |   2240
  2241       |  ------------------------------------------------------------- */                                |   2241
  2242       |PNOXATTR nox_NodeAddAttributeValue  (PNOXNODE pNode , PUCHAR AttrName, PUCHAR Value)              |   2242
  2243       |{                                                                                                 |   2243
  2244       |                                                                                                  |   2244
  2245       | PNOXATTR pAttrTemp;                                                                              |   2245
  2246     1 | PNOXATTR * ppEnd = &pNode->pAttrList;                                                            |   2246
  2247       |                                                                                                  |   2247
  2248     2 | for (pAttrTemp = pNode->pAttrList; pAttrTemp ; pAttrTemp = pAttrTemp->pAttrSibling){             |   2248
  2249     3 |  ppEnd = &pAttrTemp->pAttrSibling;                                                               |   2249
  2250       | }                                                                                                |   2250
  2251       |                                                                                                  |   2251
  2252     4 | pAttrTemp =  memAlloc (sizeof(*pAttrTemp));                                                      |   2252
  2253     5 | memset (pAttrTemp , 0, sizeof(*pAttrTemp));                                                      |   2253
  2254     6 | pAttrTemp->signature  = ATTRSIG;                                                                 |   2254
  2255     7 | pAttrTemp->Name =  memStrDup(AttrName);                                                          |   2255
  2256     8 | pAttrTemp->Value = memStrDup(Value);                                                             |   2256
  2257     9 | *ppEnd = pAttrTemp;                                                                              |   2257
  2258    10 | return pAttrTemp;                                                                                |   2258
  2259       |}                                                                                                 |   2259
  2260       |/* -------------------------------------------------------------                                  |   2260
  2261       |  Update or add an attribue                                                                       |   2261
  2262       |  ------------------------------------------------------------- */                                |   2262
  2263       |VOID nox_SetNodeAttrValue  (PNOXNODE pNode , PUCHAR AttrName, PUCHAR Value)                       |   2263
  2264       |{                                                                                                 |   2264
  2265       | PNOXATTR pAttr;                                                                                  |   2265
  2266       |                                                                                                  |   2266
  2267     1 | pAttr = nox_AttributeLookup   (pNode, AttrName);                                                 |   2267
  2268     2 | if (pAttr == NULL) {                                                                             |   2268
  2269     3 |  nox_NodeAddAttributeValue( pNode , AttrName, Value);                                            |   2269
  2270     4 |  return;                                                                                         |   2270
  2271       | } else {                                                                                         |   2271
  2272     5 |  memFree(&pAttr->Value);                                                                         |   2272
  2273     6 |  pAttr->Value = memStrDup(Value);                                                                |   2273
  2274     7 |  return;                                                                                         |   2274
  2275       | }                                                                                                |   2275
  2276       |}                                                                                                 |   2276
  2277       |VOID nox_SetNodeAttrValueVC  (PNOXNODE pNode , PLVARCHAR AttrName, PLVARCHAR Value)               |   2277
  2278       |{                                                                                                 |   2278
  2279     1 | nox_SetNodeAttrValue  (pNode , plvc2str(AttrName) , plvc2str(Value));                            |   2279
  2280       |}                                                                                                 |   2280
  2281       |/* ---------------------------------------------------------------------------                    |   2281
  2282       |  Find node by path, by parsing a name string and traverse the tree                               |   2282
  2283       |  It can be relative by diging a Nodeent.                                                         |   2283
 5770WDS V7R2M0  140418   IBM ILE C compiler      noxdb2.c                           DKSRV206    11-01-22 18:00:09 Page          53
  2284       |  --------------------------------------------------------------------------- */                  |   2284
  2285       |PUCHAR nox_GetValuePtr (PNOXNODE pNodeRoot, PUCHAR Name, PUCHAR Default)                          |   2285
  2286       |{                                                                                                 |   2286
  2287     1 | PNPMPARMLISTADDRP pParms = _NPMPARMLISTADDR();                                                   |   2287
  2288       | // from "C" return null in number of parms                                                       |   2288
  2289       | PUCHAR  dft =  (pParms->OpDescList == NULL                                                       |   2289
  2290       |    ||  pParms->OpDescList->NbrOfParms == 0                                                       |   2290
  2291     2 |    ||  pParms->OpDescList->NbrOfParms >= 3) ? Default : "";                                      |   2291
  2292       |                                                                                                  |   2292
  2293       | PUCHAR    pNodeKey, pAtrKey;                                                                     |   2293
  2294       | PNOXATTR  pAtr;                                                                                  |   2294
  2295       | PNOXNODE   pNode;                                                                                |   2295
  2296       | static UCHAR temp [10];                                                                          |   2296
  2297       |                                                                                                  |   2297
  2298     3 | if (pNodeRoot == NULL) {                                                                         |   2298
  2299     4 |  return dft;                                                                                     |   2299
  2300       | }                                                                                                |   2300
  2301       |                                                                                                  |   2301
  2302     5 | pAtrKey = strchr(Name, MASTERSPACE);                                                             |   2302
  2303       |                                                                                                  |   2303
  2304     6 | if (pAtrKey) {                                                                                   |   2304
  2305     7 |  PUCHAR pExp = strchr(Name, BRABEG);                                                             |   2305
  2306     8 |  if  (pExp == null || pAtrKey  < pExp) {                                                         |   2306
  2307     9 |   *pAtrKey = '\0'; // Terminate the Nodeent                                                      |   2307
  2308    10 |   pAtrKey ++;     // atribute is the next                                                        |   2308
  2309       |  }                                                                                               |   2309
  2310       | }                                                                                                |   2310
  2311       |                                                                                                  |   2311
  2312    11 | pNode = nox_GetNode  (pNodeRoot , Name);                                                         |   2312
  2313    12 | if (pNode == NULL) return dft;                                                                   |   2313
  2314       |                                                                                                  |   2314
  2315    14 | if (pAtrKey) {                                                                                   |   2315
  2316    15 |  pAtr =  nox_AttributeLookup   (pNode, pAtrKey);                                                 |   2316
  2317    16 |  if (pAtr == NULL)        return dft;                                                            |   2317
  2318    18 |  if (pAtr->Value == NULL) return dft;                                                            |   2318
  2319    20 |  return pAtr->Value;                                                                             |   2319
  2320    21 | } else if (pNode->doCount) {                                                                     |   2320
  2321    22 |  sprintf(temp , "%ld" , pNode->Count);                                                           |   2321
  2322    23 |  return (temp);                                                                                  |   2322
  2323       | } else {                                                                                         |   2323
  2324    24 |  if ( pNode->Value == NULL && dft != NULL) return dft;  // Note - if value is a proc ptr - Value\|   2324
  2324       | compare to NULL                                                                                  |   2324
  2325    26 |  return pNode->Value;                                                                            |   2325
  2326       | }                                                                                                |   2326
  2327       |}                                                                                                 |   2327
  2328       |/* --------------------------------------------------------------------------- */                 |   2328
 5770WDS V7R2M0  140418   IBM ILE C compiler      noxdb2.c                           DKSRV206    11-01-22 18:00:09 Page          54
  2329       |static void nox_joinArray2vc (PLVARCHAR pRes , PNOXNODE pNode)                                    |   2329
  2330       |{                                                                                                 |   2330
  2331     1 | PNOXNODE p = pNode->pNodeChildHead;                                                              |   2331
  2332       | int len;                                                                                         |   2332
  2333     2 | pRes->Length = 0;                                                                                |   2333
  2334     3 | while (p) {                                                                                      |   2334
  2335     4 |  PUCHAR v = p->Value;                                                                            |   2335
  2336     5 |  if (v  && *v) {                                                                                 |   2336
  2337     6 |   plvccatstr(pRes , v);                                                                          |   2337
  2338       |  }                                                                                               |   2338
  2339     7 |  p = p->pNodeSibling;                                                                            |   2339
  2340       | }                                                                                                |   2340
  2341       |}                                                                                                 |   2341
  2342       |/* ---------------------------------------------------------------------------                    |   2342
  2343       |  Take the name after the last  @ - that is the attributename                                     |   2343
  2344       |  --------------------------------------------------------------------------- */                  |   2344
  2345       |PUCHAR nox_splitAtrFromName (PUCHAR name)                                                         |   2345
  2346       |{                                                                                                 |   2346
  2347     1 | int balance = 0;                                                                                 |   2347
  2348       | PUCHAR pEnd;                                                                                     |   2348
  2349       |                                                                                                  |   2349
  2350     2 | for (pEnd = name + strlen(name)-1 ; pEnd >= name; pEnd --) {                                     |   2350
  2351     3 |  if (*pEnd == MASTERSPACE && balance == 0) {                                                     |   2351
  2352     4 |   *pEnd  = '\0';     // Terminate the Node end giving the name to the node only                  |   2352
  2353     5 |   return (pEnd +1);  // atribute name is the next. Return that                                   |   2353
  2354       |  }                                                                                               |   2354
  2355     6 |  else if (*pEnd == BRABEG) {                                                                     |   2355
  2356     7 |   balance ++;                                                                                    |   2356
  2357       |  }                                                                                               |   2357
  2358     8 |  else if (*pEnd == BRAEND) {                                                                     |   2358
  2359     9 |   balance ++;                                                                                    |   2359
  2360       |  }                                                                                               |   2360
  2361       | }                                                                                                |   2361
  2362    10 | return NULL;                                                                                     |   2362
  2363       |}                                                                                                 |   2363
  2364       |/* ---------------------------------------------------------------------------                    |   2364
  2365       |  Find node by path name, by parsing a name string and traverse the tree                          |   2365
  2366       |  It can be relative by giging either a Nodeent or a XML-common pointer                           |   2366
  2367       |  --------------------------------------------------------------------------- */                  |   2367
  2368       |#pragma convert(1252)                                                                             |   2368
  2369       |void nox_CopyValueByNameVC (PLVARCHAR pRes, PNOXNODE pNodeRoot, PLVARCHAR pName, PLVARCHAR pDefau\|   2369
  2369       |lt, BOOL joinString)                                                                              |   2369
  2370       |{                                                                                                 |   2370
  2371       | PUCHAR    pNodeKey, pAtrKey;                                                                     |   2371
  2372       | PNOXATTR  pAtr;                                                                                  |   2372
  2373       | PNOXNODE  pNode;                                                                                 |   2373
 5770WDS V7R2M0  140418   IBM ILE C compiler      noxdb2.c                           DKSRV206    11-01-22 18:00:09 Page          55
  2374     1 | PUCHAR    Name = plvc2str(pName);                                                                |   2374
  2375       |                                                                                                  |   2375
  2376       | // Assume : Not found                                                                            |   2376
  2377     2 | plvccopy (pRes , pDefault);                                                                      |   2377
  2378       |                                                                                                  |   2378
  2379     3 | if (pNodeRoot == NULL) return;                                                                   |   2379
  2380       |                                                                                                  |   2380
  2381     5 | pAtrKey = nox_splitAtrFromName (Name);                                                           |   2381
  2382       |                                                                                                  |   2382
  2383     6 | pNode = nox_GetNode  (pNodeRoot , Name);                                                         |   2383
  2384     7 | if (pNode == NULL) return;                                                                       |   2384
  2385       |                                                                                                  |   2385
  2386     9 | if (pAtrKey) {                                                                                   |   2386
  2387    10 |  pAtr =  nox_AttributeLookup   (pNode, pAtrKey);                                                 |   2387
  2388    11 |  if (pAtr == NULL)        return;                                                                |   2388
  2389    13 |  if (pAtr->Value == NULL) return;                                                                |   2389
  2390    15 |  str2plvc(pRes , pAtr->Value);                                                                   |   2390
  2391       |                                                                                                  |   2391
  2392    16 | } else if (pNode->doCount) {                                                                     |   2392
  2393    17 |  vcprintf( pRes, "%ld" , pNode->Count);                                                          |   2393
  2394       |                                                                                                  |   2394
  2395    18 | } else if (joinString &&  pNode->type == ARRAY) {                                                |   2395
  2396    19 |  nox_joinArray2vc (pRes , pNode);                                                                |   2396
  2397    20 |  if (pRes->Length == 0) { // No data found when joining arrays as string - Now serialize it as u\|   2397
  2397       |sual                                                                                              |   2397
  2398    21 |   nox_AsJsonText (pRes, pNode);                                                                  |   2398
  2399       |  }                                                                                               |   2399
  2400       |                                                                                                  |   2400
  2401    22 | } else if (pNode->type == OBJECT ||  pNode->type == ARRAY ) {                                    |   2401
  2402    23 |  nox_AsJsonText (pRes, pNode );                                                                  |   2402
  2403       |                                                                                                  |   2403
  2404    24 | } else if (pNode->Value) {                                                                       |   2404
  2405    25 |  pRes->Length = memSize(pNode->Value) -1 ; // With out the zero termination                      |   2405
  2406    26 |   memcpy(pRes->String, pNode->Value, pRes->Length);                                              |   2406
  2407       | }                                                                                                |   2407
  2408       |}                                                                                                 |   2408
  2409       |#pragma convert(0)                                                                                |   2409
  2410       |/* ---------------------------------------------------------------------------                    |   2410
  2411       |   Obsolete- use MergeObjects, but still used by nox_SetByParseString !! TODO !!                  |   2411
  2412       |   --------------------------------------------------------------------------- */                 |   2412
  2413       |void nox_NodeMerge(PNOXNODE pDest, PNOXNODE pSource, SHORT replace)                               |   2413
  2414       |{                                                                                                 |   2414
  2415       |  JWRITE jWrite;                                                                                  |   2415
  2416       |  MERGEOPTION merge;                                                                              |   2416
  2417     1 |  switch (replace) {                                                                              |   2417
  2418     2 |     case true :  merge = MO_MERGE_REPLACE; break;                                                |   2418
 5770WDS V7R2M0  140418   IBM ILE C compiler      noxdb2.c                           DKSRV206    11-01-22 18:00:09 Page          56
  2419     4 |     case false:  merge = MO_MERGE_NEW    ; break;                                                |   2419
  2420     6 |     default   :  merge = replace;                                                                |   2420
  2421       |  }                                                                                               |   2421
  2422     7 |  memset(&jWrite , 0 , sizeof(jWrite));                                                           |   2422
  2423     8 |  if (pDest == NULL || pSource == NULL  || pSource->pNodeChildHead == NULL) return;               |   2423
  2424       |  // jx_MergeList(pDest, pSource->pNodeChildHead, &jWrite, "", pSource, merge);                   |   2424
  2425    10 |  nox_MergeObj (pDest, pSource, &jWrite, merge);                                                  |   2425
  2426       |}                                                                                                 |   2426
  2427       |/* ---------------------------------------------------------------------------                    |   2427
  2428       |  --------------------------------------------------------------------------- */                  |   2428
  2429       |#pragma convert(1252)                                                                             |   2429
  2430       |void  nox_SetByParseString (PNOXNODE pDest , PUCHAR pSourceStr , MERGEOPTION merge , BOOL move)   |   2430
  2431       |{                                                                                                 |   2431
  2432     1 | PNOXNODE pSource = NULL;                                                                         |   2432
  2433     2 | PUCHAR  firstNonBlank = pSourceStr;                                                              |   2433
  2434       |                                                                                                  |   2434
  2435       | // quick trim                                                                                    |   2435
  2436     3 | for (;*firstNonBlank == ' '; firstNonBlank++);                                                   |   2436
  2437       |                                                                                                  |   2437
  2438       | // TODO :  nox_ParseStringVC returns object for any string which is an error; now dont use       |   2438
  2439       | // the paser if it is not an OBJECT or ARRAY                                                     |   2439
  2440     5 | if ( *firstNonBlank == BRABEG ||  *firstNonBlank == CURBEG) {                                    |   2440
  2441     6 |  pSource = nox_ParseString( firstNonBlank);                                                      |   2441
  2442       | }                                                                                                |   2442
  2443       |                                                                                                  |   2443
  2444     7 | if (pSource) {                                                                                   |   2444
  2445       |  // TODO !!! Arrays dont work in NodeMerger.. This is a simple workarround                       |   2445
  2446     8 |  if (pSource->type == ARRAY) {                                                                   |   2446
  2447     9 |   nox_NodeMoveAndReplace (pDest, pSource);                                                       |   2447
  2448       |   // nox_NodeFree(pSource); Why delete what we just made .. NLI removed line                     |   2448
  2449    10 |   return;                                                                                        |   2449
  2450       |  }                                                                                               |   2450
  2451       |                                                                                                  |   2451
  2452    11 |  if (move) {                                                                                     |   2452
  2453    12 |   nox_NodeMoveAndReplace (pDest, pSource);                                                       |   2453
  2454       |   // nox_NodeFree(pSource); Why delete what we just made .. NLI removed line                     |   2454
  2455       |  } else {                                                                                        |   2455
  2456    13 |   nox_NodeMerge(pDest, pSource, merge  );                                                        |   2456
  2457       |  }                                                                                               |   2457
  2458       | } else {                                                                                         |   2458
  2459    14 |  nox_NodeSet (pDest  , pSourceStr);                                                              |   2459
  2460    15 |  pDest->type      = VALUE;                                                                       |   2460
  2461       |  pDest->isLiteral =  // isdigit (*pSourceStr)  !! No !! the "123 - John" is not a number         |   2461
  2462       |      strcmp(pSourceStr ,TRUESTR) == 0                                                            |   2462
  2463       |   || strcmp(pSourceStr ,FALSESTR) == 0                                                           |   2463
  2464    16 |   || strcmp(pSourceStr ,NULLSTR) == 0;                                                           |   2464
 5770WDS V7R2M0  140418   IBM ILE C compiler      noxdb2.c                           DKSRV206    11-01-22 18:00:09 Page          57
  2465       | }                                                                                                |   2465
  2466       |}                                                                                                 |   2466
  2467       |#pragma convert(0)                                                                                |   2467
  2468       |/* ---------------------------------------------------------------------------                    |   2468
  2469       |  Insert a node as tail in an array - as copy or move it into                                     |   2469
  2470       |  --------------------------------------------------------------------------- */                  |   2470
  2471       |#pragma convert(1252)                                                                             |   2471
  2472       |                                                                                                  |   2472
  2473       |PNOXNODE  nox_ArrayPush (PNOXNODE pDest, PNOXNODE pSource , BOOL16 copyP)                         |   2473
  2474       |{                                                                                                 |   2474
  2475       | PNOXNODE  pNewNode;                                                                              |   2475
  2476     1 | PNPMPARMLISTADDRP pParms = _NPMPARMLISTADDR();                                                   |   2476
  2477     2 | BOOL copy = (pParms->OpDescList->NbrOfParms >= 3) ? copyP : false;                               |   2477
  2478       |                                                                                                  |   2478
  2479     3 | if (pSource == NULL)  {                                                                          |   2479
  2480       | // TODO - rather have NULL as value, that literal null,                                          |   2480
  2481       | // But this requires to check the serialized .....                                               |   2481
  2482       | // pNewNode  = NewNode  (NULL  , NULL , VALUE);                                                  |   2482
  2483     4 |  pNewNode  = NewNode  (NULL  , NULLSTR , LITERAL);                                               |   2483
  2484     5 | } else if (pSource->signature != NODESIG) {                                                      |   2484
  2485     6 |  if (*(PUCHAR) pSource == BRABEG || *(PUCHAR) pSource == CURBEG ) {                              |   2485
  2486     7 |   pNewNode = nox_ParseString((PUCHAR) pSource);                                                  |   2486
  2487       |  } else {                                                                                        |   2487
  2488     8 |   pNewNode  = NewNode  (NULL  , (PUCHAR) pSource , VALUE);                                       |   2488
  2489       |  }                                                                                               |   2489
  2490     9 | } else if (copy) {                                                                               |   2490
  2491    10 |  pNewNode = nox_NodeClone (pSource);                                                             |   2491
  2492       | } else {                                                                                         |   2492
  2493    11 |  pNewNode = nox_NodeUnlink  (pSource);                                                           |   2493
  2494       | }                                                                                                |   2494
  2495       |                                                                                                  |   2495
  2496    12 | nox_NodeAddChildTail (pDest, pNewNode);                                                          |   2496
  2497       |                                                                                                  |   2497
  2498       |}                                                                                                 |   2498
  2499       |#pragma convert(0)                                                                                |   2499
  2500       |/* ---------------------------------------------------------------------------                    |   2500
  2501       |  Appends an array to the end of another array                                                    |   2501
  2502       |  --------------------------------------------------------------------------- */                  |   2502
  2503       |#pragma convert(1252)                                                                             |   2503
  2504       |PNOXNODE  nox_ArrayAppend  (PNOXNODE pDest, PNOXNODE pSource , BOOL16 copyP)                      |   2504
  2505       |{                                                                                                 |   2505
  2506       | PNOXNODE  pNewNode, pNode, pNext;                                                                |   2506
  2507     1 | PNPMPARMLISTADDRP pParms = _NPMPARMLISTADDR();                                                   |   2507
  2508     2 | BOOL copy = (pParms->OpDescList->NbrOfParms >= 3) ? copyP : false;                               |   2508
  2509       |                                                                                                  |   2509
  2510     3 | if (pSource == NULL)  {                                                                          |   2510
 5770WDS V7R2M0  140418   IBM ILE C compiler      noxdb2.c                           DKSRV206    11-01-22 18:00:09 Page          58
  2511       | // TODO - rather have NULL as value, that literal null,                                          |   2511
  2512       | // But this requires to check the serialized .....                                               |   2512
  2513       | // pNewNode  = NewNode  (NULL  , NULL , VALUE);                                                  |   2513
  2514     4 |  pNewNode  = NewNode  (NULL  , NULLSTR , LITERAL);                                               |   2514
  2515     5 | } else if (pSource->signature != NODESIG) {                                                      |   2515
  2516     6 |  if (*(PUCHAR) pSource == BRABEG || *(PUCHAR) pSource == CURBEG ) {                              |   2516
  2517     7 |   pNewNode = nox_ParseString((PUCHAR) pSource);                                                  |   2517
  2518       |  } else {                                                                                        |   2518
  2519     8 |   pNewNode  = NewNode  (NULL  , (PUCHAR) pSource , VALUE);                                       |   2519
  2520       |  }                                                                                               |   2520
  2521     9 | } else if (copy) {                                                                               |   2521
  2522    10 |  pNewNode = nox_NodeClone (pSource);                                                             |   2522
  2523       | } else {                                                                                         |   2523
  2524    11 |  pNewNode = nox_NodeUnlink  (pSource);                                                           |   2524
  2525       | }                                                                                                |   2525
  2526       |                                                                                                  |   2526
  2527       | // Arrays - need first child;                                                                    |   2527
  2528    12 | pNode = pNewNode->pNodeChildHead;                                                                |   2528
  2529    13 | while (pNode) {                                                                                  |   2529
  2530    14 |  pNext = pNode->pNodeSibling;                                                                    |   2530
  2531    15 |  nox_ArrayPush (pDest , pNode , false);                                                          |   2531
  2532    16 |  pNode = pNext;                                                                                  |   2532
  2533       | }                                                                                                |   2533
  2534       |                                                                                                  |   2534
  2535    17 | return pDest;                                                                                    |   2535
  2536       |}                                                                                                 |   2536
  2537       |#pragma convert(0)                                                                                |   2537
  2538       |/* ---------------------------------------------------------------------------                    |   2538
  2539       |  Slice from element to element in an array                                                       |   2539
  2540       |  --------------------------------------------------------------------------- */                  |   2540
  2541       |PNOXNODE  nox_ArraySlice   (PNOXNODE pSource , int from , int to, BOOL16 copyP)                   |   2541
  2542       |{                                                                                                 |   2542
  2543       | PNOXNODE  pNewNode, pNode, pNext, pOut;                                                          |   2543
  2544     1 | PNPMPARMLISTADDRP pParms = _NPMPARMLISTADDR();                                                   |   2544
  2545     2 | BOOL copy = (pParms->OpDescList->NbrOfParms >= 2) ? copyP : false;                               |   2545
  2546     3 | int i =0;                                                                                        |   2546
  2547     4 | BOOL  deleteAfter = false;                                                                       |   2547
  2548       |                                                                                                  |   2548
  2549     5 | if (pSource == NULL)  return null;                                                               |   2549
  2550       |                                                                                                  |   2550
  2551     7 | if (pSource->signature != NODESIG) {                                                             |   2551
  2552     8 |  if (*(PUCHAR) pSource == BRABEG || *(PUCHAR) pSource == CURBEG ) {                              |   2552
  2553     9 |   pSource = nox_ParseString((PUCHAR) pSource);                                                   |   2553
  2554       |  }                                                                                               |   2554
  2555    10 |  if (pSource == NULL)  return null;                                                              |   2555
  2556    12 |  deleteAfter = true;                                                                             |   2556
 5770WDS V7R2M0  140418   IBM ILE C compiler      noxdb2.c                           DKSRV206    11-01-22 18:00:09 Page          59
  2557    13 |  copy = false;                                                                                   |   2557
  2558       | }                                                                                                |   2558
  2559       |                                                                                                  |   2559
  2560    14 | pOut = nox_NewArray();                                                                           |   2560
  2561       |                                                                                                  |   2561
  2562       | // first locate first element;                                                                   |   2562
  2563    15 | pNode = pSource->pNodeChildHead;                                                                 |   2563
  2564    16 | for (i=0; pNode && i < from ; i++) {                                                             |   2564
  2565    17 |  pNode = pNode->pNodeSibling;                                                                    |   2565
  2566       | }                                                                                                |   2566
  2567       |                                                                                                  |   2567
  2568       | // now keep on pushing                                                                           |   2568
  2569    18 | for (; pNode && (i < to || to == -1); i++) {                                                     |   2569
  2570    19 |  pNext = pNode->pNodeSibling;                                                                    |   2570
  2571    20 |  nox_ArrayPush (pOut , pNode , copy);                                                            |   2571
  2572    21 |  pNode = pNext;                                                                                  |   2572
  2573       | }                                                                                                |   2573
  2574       |                                                                                                  |   2574
  2575    22 | if (deleteAfter) {                                                                               |   2575
  2576    23 |  nox_NodeDelete (pSource);                                                                       |   2576
  2577       | }                                                                                                |   2577
  2578       |                                                                                                  |   2578
  2579    24 | return pOut;                                                                                     |   2579
  2580       |}                                                                                                 |   2580
  2581       |/* ---------------------------------------------------------------------------                    |   2581
  2582       |  Find node by name, by parsing a name string and traverse the array list                         |   2582
  2583       |  --------------------------------------------------------------------------- */                  |   2583
  2584       |PNOXNODE  nox_lookupValue (PNOXNODE pNode, PUCHAR expr, BOOL16 ignorecaseP)                       |   2584
  2585       |{                                                                                                 |   2585
  2586       | PNOXNODE  pTemp;                                                                                 |   2586
  2587     1 | PNPMPARMLISTADDRP pParms = _NPMPARMLISTADDR();                                                   |   2587
  2588     2 | BOOL  ignorecase = (pParms->OpDescList->NbrOfParms >= 3) ? ignorecaseP : false;                  |   2588
  2589       |                                                                                                  |   2589
  2590       | // Dynamic set the compare function                                                              |   2590
  2591       | int (*pComp) (PUCHAR s1 , PUCHAR s2);                                                            |   2591
  2592     3 | pComp = ignorecase ? stricmp : strcmp ;                                                          |   2592
  2593       |                                                                                                  |   2593
  2594       | // Works for array and objects                                                                   |   2594
  2595     4 | if (pNode == NULL || ( pNode->type != ARRAY && pNode->type != OBJECT)) return NULL;              |   2595
  2596       |                                                                                                  |   2596
  2597     6 | pTemp = pNode->pNodeChildHead;                                                                   |   2597
  2598       |                                                                                                  |   2598
  2599       |                                                                                                  |   2599
  2600     7 | while (pTemp) {                                                                                  |   2600
  2601     8 |  if (pComp (pTemp->Value , expr) == 0) return pTemp; // found !!                                 |   2601
  2602    10 |  pTemp = pTemp->pNodeSibling;                                                                    |   2602
 5770WDS V7R2M0  140418   IBM ILE C compiler      noxdb2.c                           DKSRV206    11-01-22 18:00:09 Page          60
  2603       | }                                                                                                |   2603
  2604       |                                                                                                  |   2604
  2605    11 | return NULL;                                                                                     |   2605
  2606       |                                                                                                  |   2606
  2607       |}                                                                                                 |   2607
  2608       |PNOXNODE  nox_lookupValueVC (PNOXNODE pNode, PLVARCHAR expr, BOOL16 ignorecaseP)                  |   2608
  2609       |{                                                                                                 |   2609
  2610     1 | PNPMPARMLISTADDRP pParms = _NPMPARMLISTADDR();                                                   |   2610
  2611     2 | BOOL16  ignorecase = (pParms->OpDescList->NbrOfParms >= 3) ? ignorecaseP : false;                |   2611
  2612     3 | return nox_lookupValue (pNode, plvc2str(expr), ignorecaseP);                                     |   2612
  2613       |}                                                                                                 |   2613
  2614       |/* ---------------------------------------------------------------------------                    |   2614
  2615       |  Find node by name, by parsing a name string and traverse the array list                         |   2615
  2616       |  --------------------------------------------------------------------------- */                  |   2616
  2617       |LONG nox_getLength (PNOXNODE pNode)                                                               |   2617
  2618       |{                                                                                                 |   2618
  2619       | PNOXNODE  pTemp;                                                                                 |   2619
  2620     1 | LONG len = 0;                                                                                    |   2620
  2621       |                                                                                                  |   2621
  2622       | // Works for array and objects                                                                   |   2622
  2623     2 | if (pNode == NULL || (pNode->type != ARRAY && pNode->type != OBJECT)) return -1;                 |   2623
  2624       |                                                                                                  |   2624
  2625     4 | pTemp = pNode->pNodeChildHead;                                                                   |   2625
  2626     5 | while (pTemp) {                                                                                  |   2626
  2627     6 |  len ++;                                                                                         |   2627
  2628     7 |  pTemp = pTemp->pNodeSibling;                                                                    |   2628
  2629       | }                                                                                                |   2629
  2630       |                                                                                                  |   2630
  2631     8 | return len;                                                                                      |   2631
  2632       |                                                                                                  |   2632
  2633       |}                                                                                                 |   2633
  2634       |// -----------------------------------------------------------------------------------------      |   2634
  2635       |// Enshure that the complete path has a assoiceated node                                          |   2635
  2636       |// -----------------------------------------------------------------------------------------      |   2636
  2637       |PNOXNODE nox_CreateSubNodes  (PNOXNODE pNodeRoot , PUCHAR Path )                                  |   2637
  2638       |{                                                                                                 |   2638
  2639       |                                                                                                  |   2639
  2640       | UCHAR    tempName [256];                                                                         |   2640
  2641     1 | PUCHAR   pName = tempName;                                                                       |   2641
  2642       | PUCHAR   pEnd;                                                                                   |   2642
  2643       | PNOXNODE  pParentNode, pNodeTemp;                                                                |   2643
  2644     2 | BOOL     isNewArray = false;                                                                     |   2644
  2645       |                                                                                                  |   2645
  2646     3 | strcpy(tempName, Path);                                                                          |   2646
  2647       |                                                                                                  |   2647
  2648     4 | if  (pName[0] == BRABEG && pName[1] == BRAEND) {   // the empty array: []                        |   2648
 5770WDS V7R2M0  140418   IBM ILE C compiler      noxdb2.c                           DKSRV206    11-01-22 18:00:09 Page          61
  2649     5 |  pName += 2;                                                                                     |   2649
  2650     6 |  pNodeRoot->type = ARRAY;                                                                        |   2650
  2651     7 |  pParentNode = nox_NodeAdd (pNodeRoot, RL_LAST_CHILD, NULL , NULL, VALUE);                       |   2651
  2652     8 |  isNewArray = true;                                                                              |   2652
  2653     9 | } else if  (*pName == BRABEG) {                                                                  |   2653
  2654    10 |  pName ++ ;                                                                                      |   2654
  2655    11 |  pParentNode = pNodeRoot;                                                                        |   2655
  2656    12 | } else if (findchr(pName , delimiters , sizeof(DELIMITERS)-1) == pName) {                        |   2656
  2657    13 |  pName ++ ;                                                                                      |   2657
  2658    14 |  pParentNode = nox_GetRoot(pNodeRoot);                                                           |   2658
  2659       | } else {                                                                                         |   2659
  2660    15 |  pParentNode = pNodeRoot;                                                                        |   2660
  2661       | }                                                                                                |   2661
  2662       |                                                                                                  |   2662
  2663       |                                                                                                  |   2663
  2664    16 | do {                                                                                             |   2664
  2665    17 |  NODETYPE nodeType = VALUE;                                                                      |   2665
  2666       |  UCHAR arrix [64];                                                                               |   2666
  2667    18 |  pEnd = findchr(pName , delimiters , sizeof(DELIMITERS)-1);                                      |   2667
  2668    19 |  if (pEnd) {                                                                                     |   2668
  2669    20 |   if      (*pEnd == BRABEG && pEnd[1] == BRAEND) isNewArray = true;                              |   2669
  2670    22 |   else if (isNextDelimiter(*pEnd))               nodeType = OBJECT;                              |   2670
  2671    24 |   else if (*pEnd == BRABEG)                      nodeType = ARRAY;                               |   2671
  2672    26 |   else if (*pEnd == BRAEND) {                                                                    |   2672
  2673    27 |    int len = pEnd - pName;                                                                       |   2673
  2674    28 |    sprintf(arrix , "%c%*.*s%c" , BRABEG, len,len, pName , BRAEND);                               |   2674
  2675    29 |    pName = arrix;                                                                                |   2675
  2676       |   }                                                                                              |   2676
  2677    30 |   *pEnd = '\0'; // temp termination                                                              |   2677
  2678       |  }                                                                                               |   2678
  2679    31 |  if (*pName) {                                                                                   |   2679
  2680    32 |   pNodeTemp = nox_GetNode  (pParentNode , pName);                                                |   2680
  2681    33 |   if (pNodeTemp == NULL) {                                                                       |   2681
  2682    34 |    freeNodeValue (pParentNode); // Can not have values if we have childrens                      |   2682
  2683       |    // When i have children, then i must be an object or an array                                 |   2683
  2684    35 |    if (pParentNode->type != ARRAY) {                                                             |   2684
  2685    36 |     pParentNode->type = OBJECT;                                                                  |   2685
  2686       |    }                                                                                             |   2686
  2687    37 |    pNodeTemp = nox_NodeAdd (pParentNode, RL_LAST_CHILD, pName , NULL, isNewArray ? ARRAY : nodeT\|   2687
  2687       |ype);                                                                                             |   2687
  2688       |   }                                                                                              |   2688
  2689       |                                                                                                  |   2689
  2690       |   // The [] syntax  - Add the new entry to the array                                             |   2690
  2691    38 |   if (isNewArray) {                                                                              |   2691
  2692    39 |    freeNodeValue(pNodeTemp);     // Can not have values if we have childrens                     |   2692
  2693    40 |    pNodeTemp->type = ARRAY ;     // When i have childrne then i must be an object or array       |   2693
 5770WDS V7R2M0  140418   IBM ILE C compiler      noxdb2.c                           DKSRV206    11-01-22 18:00:09 Page          62
  2694    41 |    pNodeTemp = nox_NodeAdd (pNodeTemp, RL_LAST_CHILD, NULL , NULL, nodeType);                    |   2694
  2695    42 |    pName = pEnd + 2;                                                                             |   2695
  2696    43 |    if (isNextDelimiter(*pName))  pName++;                                                        |   2696
  2697    45 |    isNewArray = false; // Done with array chekking                                               |   2697
  2698       |   }                                                                                              |   2698
  2699       |   // Todo !! (Not that elegant) - we just eate one byte to much at the [ xx ] index,             |   2699
  2700       |   // so push the bracket back again                                                              |   2700
  2701       |   // else if (nodeType == ARRAY) {                                                               |   2701
  2702       |   //    pName = pEnd;                                                                            |   2702
  2703       |   //    *pName = BRABEG;                                                                         |   2703
  2704       |   // }                                                                                           |   2704
  2705       |   else {                                                                                         |   2705
  2706    46 |    pName = pEnd + 1;                                                                             |   2706
  2707       |   }                                                                                              |   2707
  2708    47 |   pParentNode = pNodeTemp;                                                                       |   2708
  2709       |  }                                                                                               |   2709
  2710    48 |  }  while (pEnd);                                                                                |   2710
  2711       |                                                                                                  |   2711
  2712    49 |  return pParentNode;                                                                             |   2712
  2713       |}                                                                                                 |   2713
  2714       |/* ---------------------------------------------------------------------------                    |   2714
  2715       |  Get the node. If not exists the produce all nodes required                                      |   2715
  2716       |  --------------------------------------------------------------------------- */                  |   2716
  2717       |PNOXNODE  nox_GetOrCreateNode (PNOXNODE pNodeRoot, PUCHAR Name)                                   |   2717
  2718       |{                                                                                                 |   2718
  2719       | PNOXNODE pDest;                                                                                  |   2719
  2720       |                                                                                                  |   2720
  2721     1 | pDest  = nox_GetNode  (pNodeRoot , Name);                                                        |   2721
  2722       |                                                                                                  |   2722
  2723       | // Not found? Build the Nodeents                                                                 |   2723
  2724     2 | if (pDest  == NULL) {                                                                            |   2724
  2725     3 |  pDest  = nox_CreateSubNodes (pNodeRoot , Name);                                                 |   2725
  2726       | }                                                                                                |   2726
  2727     4 | return pDest;                                                                                    |   2727
  2728       |}                                                                                                 |   2728
  2729       |/* ---------------------------------------------------------------------------                    |   2729
  2730       |  Get the node. If not exists the produce all nodes required                                      |   2730
  2731       |  --------------------------------------------------------------------------- */                  |   2731
  2732       |PNOXNODE  nox_GetOrCreateNodeVC (PNOXNODE pNodeRoot, PLVARCHAR pName)                             |   2732
  2733       |{                                                                                                 |   2733
  2734     1 | return nox_GetOrCreateNode (pNodeRoot, plvc2str(pName));                                         |   2734
  2735       |}                                                                                                 |   2735
  2736       |/* ---------------------------------------------------------------------------                    |   2736
  2737       |  Find node by path name, by parsing a name string and traverse the tree                          |   2737
  2738       |  It can be relative by giving either a Node and a name                                           |   2738
  2739       |  --------------------------------------------------------------------------- */                  |   2739
 5770WDS V7R2M0  140418   IBM ILE C compiler      noxdb2.c                           DKSRV206    11-01-22 18:00:09 Page          63
  2740       |PNOXNODE  nox_SetValueByName (PNOXNODE pNodeRoot, PUCHAR Name, PUCHAR Value, NODETYPE typePP)     |   2740
  2741       |{                                                                                                 |   2741
  2742     1 | PNPMPARMLISTADDRP pParms = _NPMPARMLISTADDR();                                                   |   2742
  2743       | PUCHAR        pNodeKey, pAtrKey;                                                                 |   2743
  2744       | PNOXATTR      pAtr;                                                                              |   2744
  2745       | PNOXNODE       pParentNode, pNodeTemp;                                                           |   2745
  2746     2 | NODETYPE      typeP = (pParms->OpDescList->NbrOfParms >= 4) ? typePP : UNKNOWN;                  |   2746
  2747     3 | NODETYPE      type  = typeP & 255;   // Strip the modifiers                                      |   2747
  2748     4 | MERGEOPTION   merge = typeP & (MO_MERGE_NEW + MO_MERGE_MATCH + MO_MERGE_REPLACE); // All mergeop\|   2748
  2748       |tions                                                                                             |   2748
  2749     5 | BOOL          move  = (typeP & NT_MOVE ) > 0;                                                    |   2749
  2750     6 | BOOL          debug = false;                                                                     |   2750
  2751       |                                                                                                  |   2751
  2752     7 | if (pNodeRoot == NULL) {                                                                         |   2752
  2753     8 |  return NULL;                                                                                    |   2753
  2754       | }                                                                                                |   2754
  2755       |                                                                                                  |   2755
  2756     9 | pAtrKey = strchr(Name, MASTERSPACE);                                                             |   2756
  2757       |                                                                                                  |   2757
  2758    10 | if (pAtrKey) {                                                                                   |   2758
  2759    11 |  PUCHAR pExp = strchr(Name, BRABEG);                                                             |   2759
  2760    12 |  if  (pExp == null || pAtrKey  < pExp) {                                                         |   2760
  2761    13 |   *pAtrKey = '\0'; // Terminate the Nodeent                                                      |   2761
  2762    14 |   pAtrKey ++;     // atribute is the next                                                        |   2762
  2763       |  }                                                                                               |   2763
  2764       | }                                                                                                |   2764
  2765       |                                                                                                  |   2765
  2766       | // Get the node or create it if it does not exists                                               |   2766
  2767    15 | pParentNode = nox_GetOrCreateNode (pNodeRoot, Name);                                             |   2767
  2768       |                                                                                                  |   2768
  2769    16 | if (pAtrKey) {                                                                                   |   2769
  2770    17 |  nox_SetNodeAttrValue  (pParentNode , pAtrKey, Value);                                           |   2770
  2771    18 |  return nox_traceNode("Attributes" ,pParentNode);                                                |   2771
  2772       | }                                                                                                |   2772
  2773       |                                                                                                  |   2773
  2774    19 | if (pParms->OpDescList->NbrOfParms >= 4) {                                                       |   2774
  2775    20 |  if ( type == PARSE_STRING) {                                                                    |   2775
  2776    21 |   nox_SetByParseString (pParentNode , Value, merge , move);                                      |   2776
  2777    22 |   return nox_traceNode("Parse String", pParentNode);                                             |   2777
  2778       |  }                                                                                               |   2778
  2779    23 |  if ( type == POINTER_VALUE) {                                                                   |   2779
  2780    24 |   nox_NodeSetAsPointer (pParentNode , Value);                                                    |   2780
  2781    25 |   return nox_traceNode("Pointer", pParentNode);                                                  |   2781
  2782       |  }                                                                                               |   2782
  2783       | }                                                                                                |   2783
  2784       |                                                                                                  |   2784
 5770WDS V7R2M0  140418   IBM ILE C compiler      noxdb2.c                           DKSRV206    11-01-22 18:00:09 Page          64
  2785       | // The value is an object / or an array already                                                  |   2785
  2786    26 | if (Value && *Value == NODESIG) {                                                                |   2786
  2787       |  // TODO!! Clean this up ... Node copy replace the node value                                    |   2787
  2788       |  // where NodeCloneAndReplace replace the node it self                                           |   2788
  2789       |  // if ( pParms->OpDescList->NbrOfParms >= 4 && (type == CLONE || type == CLONE_OLD)) {          |   2789
  2790       |  //    nox_NodeCopy (pParentNode , (PNOXNODE) Value, RL_LAST_CHILD);                             |   2790
  2791       |  //   return nox_traceNode("Node Copy " , pParentNode);                                          |   2791
  2792       |                                                                                                  |   2792
  2793    27 |  if (move) {                                                                                     |   2793
  2794    28 |   nox_NodeMoveAndReplace (pParentNode , (PNOXNODE) Value);                                       |   2794
  2795    29 |   return nox_traceNode("Node Move and Replace " , pParentNode);                                  |   2795
  2796       |  } else {                                                                                        |   2796
  2797    30 |   nox_NodeCloneAndReplace (pParentNode , (PNOXNODE) Value);                                      |   2797
  2798    31 |   return nox_traceNode("Node Clone and replace" , pParentNode);                                  |   2798
  2799       |  }                                                                                               |   2799
  2800       | }                                                                                                |   2800
  2801       |                                                                                                  |   2801
  2802    32 | nox_NodeSet (pParentNode , Value);                                                               |   2802
  2803    33 | if (pParms->OpDescList->NbrOfParms >= 4) {                                                       |   2803
  2804    34 |  if (type == LITERAL) {                                                                          |   2804
  2805    35 |   pParentNode->type      = VALUE;                                                                |   2805
  2806    36 |   pParentNode->isLiteral = TRUE;                                                                 |   2806
  2807       |  } else {                                                                                        |   2807
  2808    37 |   pParentNode->type = type;                                                                      |   2808
  2809    38 |   pParentNode->isLiteral = FALSE;                                                                |   2809
  2810       |  }                                                                                               |   2810
  2811       | }                                                                                                |   2811
  2812       |                                                                                                  |   2812
  2813    39 | return nox_traceNode("Set value" , pParentNode);                                                 |   2813
  2814       |}                                                                                                 |   2814
  2815       |/* -------------------------------------------------------------                                  |   2815
  2816       |  Set integer by name                                                                             |   2816
  2817       |  ------------------------------------------------------------- */                                |   2817
  2818       |PNOXNODE  nox_SetIntByName (PNOXNODE pNode, PUCHAR  Name, LONG Value)                             |   2818
  2819       |{                                                                                                 |   2819
  2820       | UCHAR  s [32];                                                                                   |   2820
  2821     1 | sprintf(s , "%ld" , Value);                                                                      |   2821
  2822     2 | return nox_SetValueByName(pNode , Name, stre2a(s,s), LITERAL );                                  |   2822
  2823       |}                                                                                                 |   2823
  2824       |PNOXNODE  nox_SetIntByNameVC (PNOXNODE pNode, PLVARCHAR  Name, LONG Value)                        |   2824
  2825       |{                                                                                                 |   2825
  2826       | UCHAR  s [32];                                                                                   |   2826
  2827     1 | sprintf(s , "%ld" , Value);                                                                      |   2827
  2828     2 | return nox_SetValueByName(pNode , plvc2str(Name) , stre2a(s,s), LITERAL );                       |   2828
  2829       |}                                                                                                 |   2829
  2830       |PNOXNODE  nox_SetDateByNameVC (PNOXNODE pNode, PLVARCHAR  Name, DATE Value)                       |   2830
 5770WDS V7R2M0  140418   IBM ILE C compiler      noxdb2.c                           DKSRV206    11-01-22 18:00:09 Page          65
  2831       |{                                                                                                 |   2831
  2832       | UCHAR  s [32];                                                                                   |   2832
  2833     1 | substr(s , (PUCHAR) &Value  , sizeof(DATE));                                                     |   2833
  2834     2 | return nox_SetValueByName(pNode , plvc2str(Name) , stre2a(s,s), VALUE );                         |   2834
  2835       |}                                                                                                 |   2835
  2836       |/* -------------------------------------------------------------                                  |   2836
  2837       |  Set decimal  by name                                                                            |   2837
  2838       |  ------------------------------------------------------------- */                                |   2838
  2839       |PNOXNODE  nox_SetDecByNameVC (PNOXNODE pNode, PLVARCHAR Name, FIXEDDEC Value)                     |   2839
  2840       |{                                                                                                 |   2840
  2841       | UCHAR  s [32];                                                                                   |   2841
  2842       | PUCHAR t;                                                                                        |   2842
  2843     1 | int len = sprintf(s , "%D(30,15)" , Value);                                                      |   2843
  2844     2 | PUCHAR p = s + len -1 ;                                                                          |   2844
  2845       | // int cutlen = 16; // remove last trailing zeroes. if none after the decimal point the also the\|   2845
  2845       | secimal point                                                                                    |   2845
  2846     3 | int cutlen = 14; // remove last trailing zeroes. Keep the last zero so it is still a decimal poi\|   2846
  2846       |nt                                                                                                |   2846
  2847       |                                                                                                  |   2847
  2848       | // %D is determined ny locale so we can have either  , or .                                      |   2848
  2849       | // we always need .                                                                              |   2849
  2850     4 | for(t=s; *t ; t++) {                                                                             |   2850
  2851     5 |  if (*t == ',') {                                                                                |   2851
  2852     6 |   *t = '.';                                                                                      |   2852
  2853     7 |   break;                                                                                         |   2853
  2854       |  }                                                                                               |   2854
  2855       | }                                                                                                |   2855
  2856       |                                                                                                  |   2856
  2857     8 | while ((*p == '0' || *p == '.') && cutlen --) {                                                  |   2857
  2858     9 |  *p = '\0';                                                                                      |   2858
  2859    10 |  p--;                                                                                            |   2859
  2860       | }                                                                                                |   2860
  2861       |                                                                                                  |   2861
  2862    11 | return nox_SetValueByName(pNode , plvc2str(Name) , stre2a(s,s), LITERAL );                       |   2862
  2863       |}                                                                                                 |   2863
  2864       |/* -------------------------------------------------------------                                  |   2864
  2865       |  Set BOOL by name                                                                                |   2865
  2866       |  ------------------------------------------------------------- */                                |   2866
  2867       |#pragma convert(1252)                                                                             |   2867
  2868       |PNOXNODE  nox_SetBoolByName (PNOXNODE pNode, PUCHAR pName, BOOL Value)                            |   2868
  2869       |{                                                                                                 |   2869
  2870     1 | return nox_SetValueByName(pNode , pName , Value ? FALSESTR:TRUESTR, LITERAL );                   |   2870
  2871       |}                                                                                                 |   2871
  2872       |PNOXNODE  nox_SetBoolByNameVC (PNOXNODE pNode, PLVARCHAR pName, LGL Value)                        |   2872
  2873       |{                                                                                                 |   2873
  2874     1 | return nox_SetValueByName(pNode , plvc2str(pName) , Value == OFF ? FALSESTR:TRUESTR, LITERAL );  |   2874
 5770WDS V7R2M0  140418   IBM ILE C compiler      noxdb2.c                           DKSRV206    11-01-22 18:00:09 Page          66
  2875       |}                                                                                                 |   2875
  2876       |#pragma convert(0)                                                                                |   2876
  2877       |/* -------------------------------------------------------------                                  |   2877
  2878       |  Set string value by name                                                                        |   2878
  2879       |  ------------------------------------------------------------- */                                |   2879
  2880       |PNOXNODE  nox_SetStrByName (PNOXNODE pNode, PUCHAR pName, PUCHAR pValue)                          |   2880
  2881       |{                                                                                                 |   2881
  2882     1 | return nox_SetValueByName(pNode , pName , pValue , VALUE );                                      |   2882
  2883       |}                                                                                                 |   2883
  2884       |PNOXNODE  nox_SetStrByNameVC (PNOXNODE pNode, PLVARCHAR pName, PLVARCHAR pValue)                  |   2884
  2885       |{                                                                                                 |   2885
  2886     1 | return nox_SetValueByName(pNode , plvc2str(pName) , plvc2str(pValue) ,VALUE);                    |   2886
  2887       |}                                                                                                 |   2887
  2888       |/* -------------------------------------------------------------                                  |   2888
  2889       |  Set evaluate by parser - set by name                                                            |   2889
  2890       |  ------------------------------------------------------------- */                                |   2890
  2891       |PNOXNODE  nox_SetEvalByNameVC (PNOXNODE pNode, PLVARCHAR Name, PLVARCHAR pValue)                  |   2891
  2892       |{                                                                                                 |   2892
  2893     1 | return nox_SetValueByName(pNode , plvc2str(Name) , plvc2str(pValue) , PARSE_STRING );            |   2893
  2894       |}                                                                                                 |   2894
  2895       |/* -------------------------------------------------------------                                  |   2895
 *=SEVERE==========>     CZM0099  Unexpected argument.
  2896       |  Set null values - set by name                                                                   |   2896
  2897       |  ------------------------------------------------------------- */                                |   2897
  2898       |PNOXNODE  nox_SetNullByName (PNOXNODE pNode, PUCHAR Name)                                         |   2898
  2899       |{                                                                                                 |   2899
  2900     1 |   return nox_SetValueByName(pNode , Name , NULL , LITERAL );                                     |   2900
  2901       |}                                                                                                 |   2901
  2902       |PNOXNODE  nox_SetNullByNameVC (PNOXNODE pNode, PLVARCHAR Name)                                    |   2902
  2903       |{                                                                                                 |   2903
  2904     1 |   return nox_SetNullByName(pNode , plvc2str(Name) , NULL , LITERAL );                            |   2904
  2905       |}                                                                                                 |   2905
  2906       |/* -------------------------------------------------------------                                  |   2906
  2907       |  Set pointer by name                                                                             |   2907
  2908       |  ------------------------------------------------------------- */                                |   2908
  2909       |PNOXNODE  nox_SetPtrByNameVC (PNOXNODE pNode, PLVARCHAR pName, PUCHAR Value, LGL isStringP)       |   2909
  2910       |{                                                                                                 |   2910
  2911     1 | PNPMPARMLISTADDRP pParms = _NPMPARMLISTADDR();                                                   |   2911
  2912     2 | BOOL isString  = (pParms->OpDescList->NbrOfParms >= 4 && isStringP == ON);                       |   2912
  2913     3 | PNOXNODE pRes = nox_SetValueByName(pNode , plvc2str(pName) , Value , POINTER_VALUE );            |   2913
  2914     4 | pRes->isLiteral = ! isString;                                                                    |   2914
  2915     5 | return pRes;                                                                                     |   2915
  2916       |}                                                                                                 |   2916
  2917       |// -------------------------------------------------------------                                  |   2917
  2918       |void nox_GetValueVC(PLVARCHAR pRes, PNOXNODE pNodeRoot, PLVARCHAR NameP, PLVARCHAR DefaultP)      |   2918
  2919       |{                                                                                                 |   2919
 5770WDS V7R2M0  140418   IBM ILE C compiler      noxdb2.c                           DKSRV206    11-01-22 18:00:09 Page          67
  2920     1 | PNPMPARMLISTADDRP pParms = _NPMPARMLISTADDR();                                                   |   2920
  2921     2 | PLVARCHAR  Name    = (pParms->OpDescList->NbrOfParms >= 3) ? NameP    : PLVARCHARNULL;           |   2921
  2922     3 | PLVARCHAR  Default = (pParms->OpDescList->NbrOfParms >= 4) ? DefaultP : PLVARCHARNULL;           |   2922
  2923     4 | nox_CopyValueByNameVC ( pRes , pNodeRoot, Name , Default , false) ;                              |   2923
  2924       |}                                                                                                 |   2924
  2925       |// -------------------------------------------------------------                                  |   2925
  2926       |void nox_GetStrJoinVC(PLVARCHAR pRes, PNOXNODE pNodeRoot, PLVARCHAR NameP, PLVARCHAR DefaultP)    |   2926
  2927       |{                                                                                                 |   2927
  2928     1 | PNPMPARMLISTADDRP pParms = _NPMPARMLISTADDR();                                                   |   2928
  2929     2 | PLVARCHAR  Name    = (pParms->OpDescList->NbrOfParms >= 3) ? NameP    : PLVARCHARNULL;           |   2929
  2930     3 | PLVARCHAR  Default = (pParms->OpDescList->NbrOfParms >= 4) ? DefaultP : PLVARCHARNULL;           |   2930
  2931     4 | nox_CopyValueByNameVC ( pRes , pNodeRoot, Name , Default , true ) ;                              |   2931
  2932       |}                                                                                                 |   2932
  2933       |// -------------------------------------------------------------                                  |   2933
  2934       |FIXEDDEC nox_GetValueNumVC (PNOXNODE pNode , PLVARCHAR NameP  , FIXEDDEC dftParm)                 |   2934
  2935       |{                                                                                                 |   2935
  2936     1 | PNPMPARMLISTADDRP pParms = _NPMPARMLISTADDR();                                                   |   2936
  2937     2 | PLVARCHAR  path  =  (pParms->OpDescList->NbrOfParms >= 2) ? NameP  : PLVARCHARNULL;              |   2937
  2938     3 | FIXEDDEC   dft   =  (pParms->OpDescList->NbrOfParms >= 3) ? dftParm : 0;                         |   2938
  2939       |                                                                                                  |   2939
  2940       | PUCHAR  value;                                                                                   |   2940
  2941       |                                                                                                  |   2941
  2942     4 | value = nox_GetValuePtr    (pNode , plvc2str(path) , NULL ) ;                                    |   2942
  2943     5 | if (value == NULL) {                                                                             |   2943
  2944     6 |  return  dft;                                                                                    |   2944
  2945       | }                                                                                                |   2945
  2946     7 | return nox_aNum(value);                                                                          |   2946
  2947       |}                                                                                                 |   2947
  2948       |// -------------------------------------------------------------                                  |   2948
  2949       |INT64 nox_GetValueIntVC (PNOXNODE pNode , PLVARCHAR NameP  , INT64 dftParm)                       |   2949
  2950       |{                                                                                                 |   2950
  2951     1 | PNPMPARMLISTADDRP pParms = _NPMPARMLISTADDR();                                                   |   2951
  2952     2 | PLVARCHAR  path  =  (pParms->OpDescList->NbrOfParms >= 2) ? NameP  : PLVARCHARNULL;              |   2952
  2953     3 | INT64      dft   =  (pParms->OpDescList->NbrOfParms >= 3) ? dftParm : 0;                         |   2953
  2954       | PUCHAR   value;                                                                                  |   2954
  2955       |                                                                                                  |   2955
  2956     4 | value = nox_GetValuePtr    (pNode , plvc2str(path) , NULL ) ;                                    |   2956
  2957     5 | if (value == NULL) {                                                                             |   2957
  2958     6 |  return  dft;                                                                                    |   2958
  2959       | }                                                                                                |   2959
  2960     7 | return nox_aNum(value);                                                                          |   2960
  2961       |}                                                                                                 |   2961
  2962       |// -------------------------------------------------------------                                  |   2962
  2963       |DATE nox_GetValueDateVC (PNOXNODE pNode , PLVARCHAR NameP  , DATE dftParm)                        |   2963
  2964       |{                                                                                                 |   2964
  2965     1 | PNPMPARMLISTADDRP pParms = _NPMPARMLISTADDR();                                                   |   2965
 5770WDS V7R2M0  140418   IBM ILE C compiler      noxdb2.c                           DKSRV206    11-01-22 18:00:09 Page          68
  2966     2 | PLVARCHAR  path  =  (pParms->OpDescList->NbrOfParms >= 2) ? NameP  : PLVARCHARNULL;              |   2966
  2967       | PUCHAR     value;                                                                                |   2967
  2968       | DATE       ret;                                                                                  |   2968
  2969       |                                                                                                  |   2969
  2970     3 | value = nox_GetValuePtr    (pNode , plvc2str(path) , NULL ) ;                                    |   2970
  2971     4 | if (value == NULL) {                                                                             |   2971
  2972     5 |  if (pParms->OpDescList->NbrOfParms >= 3) {                                                      |   2972
  2973     6 |   return  dftParm;                                                                               |   2973
  2974       |  }                                                                                               |   2974
  2975     7 |  memcpy (&ret , "0001-01-01", sizeof(DATE));                                                     |   2975
  2976       | } else {                                                                                         |   2976
  2977     8 |  mema2e ((PUCHAR) &ret , value , sizeof(DATE));                                                  |   2977
  2978       | }                                                                                                |   2978
  2979     9 | return ret;                                                                                      |   2979
  2980       |}                                                                                                 |   2980
  2981       |// -------------------------------------------------------------                                  |   2981
  2982       |void nox_GetNodeValueVC (PLVARCHAR pRes, PNOXNODE pNode , PLVARCHAR pDefaultValue)                |   2982
  2983       |{                                                                                                 |   2983
  2984     1 | PNPMPARMLISTADDRP pParms = _NPMPARMLISTADDR();                                                   |   2984
  2985     2 | PLVARCHAR dft = (pParms->OpDescList->NbrOfParms >= 3) ? pDefaultValue : PLVARCHARNULL;           |   2985
  2986       | PUCHAR value;                                                                                    |   2986
  2987       |                                                                                                  |   2987
  2988     3 | value =  nox_GetNodeValuePtr  (pNode , plvc2str(dft));                                           |   2988
  2989     4 | pRes->Length = memSize(value) -1 ; // without the zero term char                                 |   2989
  2990     5 | memcpy(pRes->String , value , pRes->Length);                                                     |   2990
  2991       |}                                                                                                 |   2991
  2992       |// -------------------------------------------------------------                                  |   2992
  2993       |FIXEDDEC nox_GetNodeValueNum (PNOXNODE pNode , FIXEDDEC DefaultValue)                             |   2993
  2994       |{                                                                                                 |   2994
  2995     1 | PNPMPARMLISTADDRP pParms = _NPMPARMLISTADDR();                                                   |   2995
  2996     2 | FIXEDDEC dft = (pParms->OpDescList->NbrOfParms >= 2) ? DefaultValue : 0;                         |   2996
  2997     3 | PUCHAR value =  nox_GetNodeValuePtr  (pNode , NULL  );                                           |   2997
  2998     4 | if (value == NULL) {                                                                             |   2998
  2999     5 |  return dft;                                                                                     |   2999
  3000       | } else {                                                                                         |   3000
  3001     6 |  return nox_aNum(value);                                                                         |   3001
  3002       | }                                                                                                |   3002
  3003       | }                                                                                                |   3003
  3004       |// -------------------------------------------------------------                                  |   3004
  3005       |PUCHAR  nox_GetNodeNamePtr (PNOXNODE pNode)                                                       |   3005
  3006       |{                                                                                                 |   3006
  3007     1 | return (pNode && pNode->Name) ? pNode->Name : "";                                                |   3007
  3008       |}                                                                                                 |   3008
  3009       |// -------------------------------------------------------------                                  |   3009
  3010       |void nox_GetNodeNameVC (PLVARCHAR pRes, PNOXNODE pNode)                                           |   3010
  3011       |{                                                                                                 |   3011
 5770WDS V7R2M0  140418   IBM ILE C compiler      noxdb2.c                           DKSRV206    11-01-22 18:00:09 Page          69
  3012     1 | pRes->Length = 0;                                                                                |   3012
  3013     2 | if (pNode && pNode->Name) {                                                                      |   3013
  3014     3 |  pRes->Length = memSize(pNode->Name) -1; // with out the zero term                               |   3014
  3015     4 |  memcpy(pRes->String , pNode->Name , pRes->Length);                                              |   3015
  3016       | }                                                                                                |   3016
  3017       |}                                                                                                 |   3017
  3018       |// -------------------------------------------------------------                                  |   3018
  3019       |void nox_GetNodeAttrValueVC (PLVARCHAR pRes, PNOXNODE pNode ,PLVARCHAR pAttrName, PLVARCHAR  pDef\|   3019
  3019       |aultValue)                                                                                        |   3019
  3020       |{                                                                                                 |   3020
  3021     1 | PNPMPARMLISTADDRP pParms = _NPMPARMLISTADDR();                                                   |   3021
  3022     2 | PLVARCHAR dft = (pParms->OpDescList->NbrOfParms >= 4) ? pDefaultValue : PLVARCHARNULL;           |   3022
  3023     3 | PUCHAR value =  nox_GetNodeAttrValuePtr  ( pNode , plvc2str(pAttrName),  plvc2str(dft)) ;        |   3023
  3024     4 | pRes->Length = memSize(value) -1; // with out the zero term                                      |   3024
  3025     5 | memcpy(pRes->String , value , pRes->Length);                                                     |   3025
  3026       |}                                                                                                 |   3026
  3027       |// -------------------------------------------------------------                                  |   3027
  3028       |FIXEDDEC nox_GetNodeAttrValueNumVC (PNOXNODE pNode , PLVARCHAR pAttrName, FIXEDDEC DefaultValue)  |   3028
  3029       |{                                                                                                 |   3029
  3030     1 | PNPMPARMLISTADDRP pParms = _NPMPARMLISTADDR();                                                   |   3030
  3031     2 | FIXEDDEC dft = (pParms->OpDescList->NbrOfParms >= 3) ? DefaultValue : 0;                         |   3031
  3032     3 | PNOXATTR pAttr = nox_AttributeLookup   (pNode, plvc2str(pAttrName));                             |   3032
  3033       |                                                                                                  |   3033
  3034       | if (pAttr == NULL                                                                                |   3034
  3035     4 | ||  pAttr->Value == NULL) {                                                                      |   3035
  3036     5 |  return ( dft );                                                                                 |   3036
  3037       | } else {                                                                                         |   3037
  3038     6 |  return nox_aNum(pAttr->Value);                                                                  |   3038
  3039       | }                                                                                                |   3039
  3040       |}                                                                                                 |   3040
  3041       |// -------------------------------------------------------------                                  |   3041
  3042       |PNOXNODE nox_GetNodeNext (PNOXNODE pNode)                                                         |   3042
  3043       |{                                                                                                 |   3043
  3044     1 | if (pNode == NULL) {                                                                             |   3044
  3045     2 |  return  NULL ;                                                                                  |   3045
  3046       | } else {                                                                                         |   3046
  3047     3 |  return  pNode->pNodeSibling ;                                                                   |   3047
  3048       | }                                                                                                |   3048
  3049       |}                                                                                                 |   3049
  3050       |// -------------------------------------------------------------                                  |   3050
  3051       |PNOXNODE nox_GetNodeChild  (PNOXNODE pNode)                                                       |   3051
  3052       |{                                                                                                 |   3052
  3053     1 | if (pNode == NULL) {                                                                             |   3053
  3054     2 |  return  NULL ;                                                                                  |   3054
  3055       | } else {                                                                                         |   3055
  3056     3 |  return  pNode->pNodeChildHead ;                                                                 |   3056
 5770WDS V7R2M0  140418   IBM ILE C compiler      noxdb2.c                           DKSRV206    11-01-22 18:00:09 Page          70
  3057       | }                                                                                                |   3057
  3058       |}                                                                                                 |   3058
  3059       |// -------------------------------------------------------------                                  |   3059
  3060       |PNOXNODE nox_GetNodeChildNo ( PNOXNODE pNode , int childNo)                                       |   3060
  3061       |{                                                                                                 |   3061
  3062     1 | PNOXNODE pChild =  nox_GetNodeChild (pNode);                                                     |   3062
  3063     2 | int i =0;                                                                                        |   3063
  3064     3 | while (i < childNo && pChild) {                                                                  |   3064
  3065     4 |  pChild  = nox_GetNodeNext(pChild);                                                              |   3065
  3066     5 |  i++;                                                                                            |   3066
  3067       | }                                                                                                |   3067
  3068     6 | return pChild;                                                                                   |   3068
  3069       |}                                                                                                 |   3069
  3070       |// -------------------------------------------------------------                                  |   3070
  3071       |PNOXATTR  nox_GetAttrFirst (PNOXNODE pNode)                                                       |   3071
  3072       |{                                                                                                 |   3072
  3073     1 | if (pNode == NULL) {                                                                             |   3073
  3074     2 |  return (NULL);                                                                                  |   3074
  3075       | } else {                                                                                         |   3075
  3076     3 |  return (pNode->pAttrList);                                                                      |   3076
  3077       | }                                                                                                |   3077
  3078       |}                                                                                                 |   3078
  3079       |// -------------------------------------------------------------                                  |   3079
  3080       |PNOXATTR  nox_GetAttrNext  (PNOXATTR pAttr)                                                       |   3080
  3081       |{                                                                                                 |   3081
  3082     1 | if (pAttr == NULL) {                                                                             |   3082
  3083     2 |  return (NULL);                                                                                  |   3083
  3084       | } else {                                                                                         |   3084
  3085     3 |  return (pAttr->pAttrSibling);                                                                   |   3085
  3086       | }                                                                                                |   3086
  3087       |}                                                                                                 |   3087
  3088       |// -------------------------------------------------------------                                  |   3088
  3089       |void nox_GetAttrNameVC (PLVARCHAR pRes, PNOXATTR pAttr)                                           |   3089
  3090       |{                                                                                                 |   3090
  3091     1 | pRes->Length = 0;                                                                                |   3091
  3092     2 | if (pAttr) {                                                                                     |   3092
  3093     3 |  pRes->Length = memSize(pAttr->Name)  -1; // with out the zero term ;                            |   3093
  3094     4 |  memcpy(pRes->String , pAttr->Name , pRes->Length);                                              |   3094
  3095       | }                                                                                                |   3095
  3096       |}                                                                                                 |   3096
  3097       |// -------------------------------------------------------------                                  |   3097
  3098       |PUCHAR  nox_GetAttrNamePtr (PNOXATTR pAttr)                                                       |   3098
  3099       |{                                                                                                 |   3099
  3100     1 | return (pAttr && pAttr->Name) ? pAttr->Name : null;                                              |   3100
  3101       |}                                                                                                 |   3101
  3102       |// -------------------------------------------------------------                                  |   3102
 5770WDS V7R2M0  140418   IBM ILE C compiler      noxdb2.c                           DKSRV206    11-01-22 18:00:09 Page          71
  3103       |PUCHAR  nox_GetAttrValuePtr (PNOXATTR pAttr)                                                      |   3103
  3104       |{                                                                                                 |   3104
  3105     1 | return (pAttr && pAttr->Value) ? pAttr->Value : null;                                            |   3105
  3106       |}                                                                                                 |   3106
  3107       |// -------------------------------------------------------------                                  |   3107
  3108       |FIXEDDEC nox_GetAttrValueNum  (PNOXATTR pAttr, FIXEDDEC dftParm)                                  |   3108
  3109       |{                                                                                                 |   3109
  3110     1 | PNPMPARMLISTADDRP pParms = _NPMPARMLISTADDR();                                                   |   3110
  3111     2 | FIXEDDEC dft = (pParms->OpDescList->NbrOfParms >= 2) ? dftParm  : 0;                             |   3111
  3112     3 | PUCHAR  value = nox_GetAttrValuePtr (pAttr);                                                     |   3112
  3113     4 | return  value ? nox_aNum(value)  : dft;                                                          |   3113
  3114       |}                                                                                                 |   3114
  3115       |// -------------------------------------------------------------                                  |   3115
  3116       |void nox_GetAttrValueVC (PLVARCHAR pRes, PNOXATTR pAttr, PLVARCHAR pDefaultValue)                 |   3116
  3117       |{                                                                                                 |   3117
  3118     1 | PNPMPARMLISTADDRP pParms = _NPMPARMLISTADDR();                                                   |   3118
  3119     2 | PLVARCHAR  dft = (pParms->OpDescList->NbrOfParms >= 3) ? pDefaultValue :  PLVARCHARNULL;;        |   3119
  3120       |                                                                                                  |   3120
  3121     4 | pRes->Length = 0;                                                                                |   3121
  3122     5 | if (pAttr &&  pAttr->Value ) {                                                                   |   3122
  3123     6 |  pRes->Length = memSize(pAttr->Value) -1; // with out the zero term                              |   3123
  3124     7 |  memcpy(pRes->String , pAttr->Value, pRes->Length);                                              |   3124
  3125       | }                                                                                                |   3125
  3126       |                                                                                                  |   3126
  3127     8 | if (pRes->Length ==0) {                                                                          |   3127
  3128     9 |  plvccopy (pRes , dft);                                                                          |   3128
  3129       | }                                                                                                |   3129
  3130       |}                                                                                                 |   3130
  3131       |// -------------------------------------------------------------                                  |   3131
  3132       |LGL  nox_Error (PNOXNODE  pNode)                                                                  |   3132
  3133       |{                                                                                                 |   3133
  3134     1 |    return ( jxError || pNode == NULL) ? ON : OFF;                                                |   3134
  3135       |}                                                                                                 |   3135
  3136       |// -------------------------------------------------------------                                  |   3136
  3137       |PUCHAR nox_ErrStr (PNOXNODE pJxNode)                                                              |   3137
  3138       |{                                                                                                 |   3138
  3139     1 | return jxMessage;                                                                                |   3139
  3140       |}                                                                                                 |   3140
  3141       |// -------------------------------------------------------------                                  |   3141
  3142       |VARCHAR1024 nox_MessageVC  (PNOXNODE pJxNode)                                                     |   3142
  3143       |{                                                                                                 |   3143
  3144       | VARCHAR1024 res;                                                                                 |   3144
  3145     1 | str2vc (&res ,  jxMessage);                                                                      |   3145
  3146     2 | return res;                                                                                      |   3146
  3147       |}                                                                                                 |   3147
  3148       |// -------------------------------------------------------------                                  |   3148
 5770WDS V7R2M0  140418   IBM ILE C compiler      noxdb2.c                           DKSRV206    11-01-22 18:00:09 Page          72
  3149       |VOID nox_SetApiErr (PNOXNODE pJxNode, PAPIERR pApiErr)                                            |   3149
  3150       |{                                                                                                 |   3150
  3151     1 | strcpy (pApiErr->msgid , "CPF9898");                                                             |   3151
  3152     2 | substr  (pApiErr->msgdta , jxMessage ,pApiErr->size - 25 );  // not inc. the header              |   3152
  3153     3 | pApiErr->avail  = strlen(pApiErr->msgdta);                                                       |   3153
  3154       |}                                                                                                 |   3154
  3155       |// -------------------------------------------------------------                                  |   3155
  3156       |#pragma convert(1252)                                                                             |   3156
  3157       |PNOXNODE nox_GetMessageObject (PUCHAR msgId , PUCHAR msgDta)                                      |   3157
  3158       |{                                                                                                 |   3158
  3159     1 | PNPMPARMLISTADDRP pParms = _NPMPARMLISTADDR();                                                   |   3159
  3160     2 | PNOXNODE pMsg = nox_NewObject();                                                                 |   3160
  3161     3 | nox_SetBoolByName (pMsg , "success" ,  false);                                                   |   3161
  3162     4 | if (pParms->OpDescList->NbrOfParms > 0)  {                                                       |   3162
  3163     5 |  nox_SetStrByName (pMsg , "msgId" ,  msgId);                                                     |   3163
  3164     6 |  nox_SetStrByName (pMsg , "msgDta",  msgDta);                                                    |   3164
  3165       |  // TODO - convert the msgid / msgData to text                                                   |   3165
  3166       | } else  {                                                                                        |   3166
  3167     7 |  nox_SetStrByName (pMsg , "msg",  jxMessage);                                                    |   3167
  3168       | }                                                                                                |   3168
  3169     8 | return pMsg;                                                                                     |   3169
  3170       |}                                                                                                 |   3170
  3171       |#pragma convert(0)                                                                                |   3171
  3172       |// -------------------------------------------------------------                                  |   3172
  3173       |#pragma convert(1252)                                                                             |   3173
  3174       |PNOXNODE nox_SuccessTrue ()                                                                       |   3174
  3175       |{                                                                                                 |   3175
  3176     1 | PNOXNODE pMsg = nox_NewObject();                                                                 |   3176
  3177     2 | nox_SetBoolByName (pMsg , "success" ,  true);                                                    |   3177
  3178     3 | return pMsg;                                                                                     |   3178
  3179       |}                                                                                                 |   3179
  3180       |#pragma convert(0)                                                                                |   3180
  3181       |// -------------------------------------------------------------                                  |   3181
  3182       |// Avoid closing an already closed XML                                                            |   3182
  3183       |// -------------------------------------------------------------                                  |   3183
  3184       |void nox_Close (PNOXNODE * ppNode)                                                                |   3184
  3185       |{                                                                                                 |   3185
  3186     1 | PNOXNODE  pRoot  =  nox_GetRoot (*ppNode);                                                       |   3186
  3187     2 | nox_NodeDelete (pRoot);                                                                          |   3187
  3188       |                                                                                                  |   3188
  3189     3 | *ppNode = NULL;                                                                                  |   3189
  3190       |}                                                                                                 |   3190
  3191       |// -------------------------------------------------------------                                  |   3191
  3192       |// remove all children from an object / array                                                     |   3192
  3193       |// -------------------------------------------------------------                                  |   3193
  3194       |void nox_Clear  (PNOXNODE pNode)                                                                  |   3194
 5770WDS V7R2M0  140418   IBM ILE C compiler      noxdb2.c                           DKSRV206    11-01-22 18:00:09 Page          73
  3195       |{                                                                                                 |   3195
  3196     1 | if (pNode != NULL) {                                                                             |   3196
  3197     2 |  nox_FreeChildren(pNode);                                                                        |   3197
  3198       | }                                                                                                |   3198
  3199       |}                                                                                                 |   3199
  3200       |// ------------------------------------------------------ -------                                |   3200
  3201       |void nox_Free  (PNOXNODE pNode)                                                                   |   3201
  3202       |{                                                                                                 |   3202
  3203     1 | nox_FreeSiblings(pNode);                                                                         |   3203
  3204       |}                                                                                                 |   3204
  3205       |//---------------------------------------------------------------------------                     |   3205
  3206       |BOOL nox_HasMore(PNOXNODE pNode)                                                                  |   3206
  3207       |{                                                                                                 |   3207
  3208     1 | return (pNode != NULL);                                                                          |   3208
  3209       |}                                                                                                 |   3209
  3210       |//---------------------------------------------------------------------------                     |   3210
  3211       |LGL nox_IsNode(PNOXNODE pNode)                                                                    |   3211
  3212       |{                                                                                                 |   3212
  3213     1 | return  (pNode->signature == NODESIG) ? ON : OFF;                                                |   3213
  3214       |}                                                                                                 |   3214
  3215       |//---------------------------------------------------------------------------                     |   3215
  3216       |LGL nox_MemLeak(VOID)                                                                             |   3216
  3217       |{                                                                                                 |   3217
  3218     1 | return  isOn(memLeak());                                                                         |   3218
  3219       |}                                                                                                 |   3219
  3220       |//---------------------------------------------------------------------------                     |   3220
  3221       |VOID nox_MemStat(VOID)                                                                            |   3221
  3222       |{                                                                                                 |   3222
  3223     1 | memStat();                                                                                       |   3223
  3224       |}                                                                                                 |   3224
  3225       |//---------------------------------------------------------------------------                     |   3225
  3226       |INT64 nox_MemUse(VOID)                                                                            |   3226
  3227       |{                                                                                                 |   3227
  3228     1 | return memUse();                                                                                 |   3228
  3229       |}                                                                                                 |   3229
  3230       |                                                                                                  |   3230
                                          * * * * *   E N D   O F   S O U R C E   * * * * *
 5770WDS V7R2M0  140418   IBM ILE C compiler      noxdb2.c                           DKSRV206    11-01-22 18:00:09 Page          74
                                               * * * * *   I N C L U D E S   * * * * *
 INCNBR  Include Name                     Last change        Actual Include Name
     1   stdio.h                          06-10-13 12:50:02  /QIBM/include/stdio.h
     2   ifs.h                            06-10-13 12:49:48  /QIBM/include/ifs.h
     3   wctype.h                         06-10-13 12:50:07  /QIBM/include/wctype.h
     4   qp0lstdi.h                       06-10-13 12:58:02  /QIBM/include/qp0lstdi.h
     5   sys/types.h                      06-10-13 13:01:08  /QIBM/include/sys/types.h
     6   string.h                         06-10-13 12:50:12  /QIBM/include/string.h
     7   qlg.h                            06-10-13 12:56:29  /QIBM/include/qlg.h
     8   qp0lscan.h                       06-10-13 13:01:53  /QIBM/include/qp0lscan.h
     9   stdlib.h                         06-10-13 12:49:25  /QIBM/include/stdlib.h
    10   mallocinfo.h                     06-10-13 12:50:01  /QIBM/include/mallocinfo.h
    11   p_stdlib.h                       06-10-13 12:50:10  /QIBM/include/p_stdlib.h
    12   stdarg.h                         06-10-13 12:50:09  /QIBM/include/stdarg.h
    13   ctype.h                          06-10-13 12:49:23  /QIBM/include/ctype.h
    14   p_ctype.h                        06-10-13 12:50:00  /QIBM/include/p_ctype.h
    15   leod.h                           06-10-13 12:50:11  /QIBM/include/leod.h
    16   letype.h                         06-10-13 12:49:46  /QIBM/include/letype.h
    17   pointer.h                        06-10-13 12:50:11  /QIBM/include/pointer.h
    18   decimal.h                        06-10-13 12:49:40  /QIBM/include/decimal.h
    19   wchar.h                          06-10-13 12:50:09  /QIBM/include/wchar.h
    20   wcstr.h                          06-10-13 12:50:00  /QIBM/include/wcstr.h
    21   errno.h                          06-10-13 12:50:02  /QIBM/include/errno.h
    22   sys/stat.h                       06-10-13 13:01:10  /QIBM/include/sys/stat.h
    23   sys/types.h                      06-10-13 13:01:08  /QIBM/include/sys/types.h
    24   ostypes.h                        06-12-18 23:20:34  /prj/noxDB2/ext/include/ostypes.h
    25   varchar.h                        21-11-18 23:22:55  /prj/noxDB2/ext/include/varchar.h
    26   xlate.h                          22-11-18 00:12:01  /prj/noxDB2/ext/include/xlate.h
    27   iconv.h                          06-10-13 12:49:21  /QIBM/include/iconv.h
    28   stddef.h                         06-10-13 12:50:05  /QIBM/include/stddef.h
    29   QTQICONV.h                       06-10-13 12:57:24  /QIBM/include/QTQICONV.h
    30   parms.h                          12-11-18 18:09:21  /prj/noxDB2/ext/include/parms.h
    31   strUtil.h                        22-01-19 13:07:41  /prj/noxDB2/ext/include/strUtil.h
    32   memUtil.h                        21-11-18 22:42:38  /prj/noxDB2/ext/include/memUtil.h
    33   streamer.h                       12-11-18 18:09:21  /prj/noxDB2/ext/include/streamer.h
    34   noxdb2.h                         08-04-20 23:25:13  /prj/noxDB2/include/noxdb2.h
    35   sqlcli.h                         04-02-14 17:01:23  /QIBM/include/sqlcli.h
    36   sql.h                            06-10-13 13:02:23  /QIBM/include/sql.h
    37   sqlsystm.h                       06-10-13 12:50:06  /QIBM/include/sqlsystm.h
    38   sqludf.h                         06-10-13 12:50:02  /QIBM/include/sqludf.h
    39   math.h                           06-10-13 12:50:00  /QIBM/include/math.h
    40   apierr.h                         12-11-18 18:09:21  /prj/noxDB2/ext/include/apierr.h
    41   e2aa2e.h                         21-11-18 19:08:01  /prj/noxDB2/ext/include/e2aa2e.h
                                       * * * * *   E N D   O F   I N C L U D E S   * * * * *
 5770WDS V7R2M0  140418   IBM ILE C compiler      noxdb2.c                           DKSRV206    11-01-22 18:00:09 Page          75
                                               * * * * *   M E S S A G E S   * * * * *
 MSG ID      SEV     TEXT
                     <SEQNBR>-<FILE NO>:<FILE LINE NO>
 CZM0099     30      Unexpected argument.
                      ( 2925-0:2904 )
                                       * * * * *   E N D   O F   M E S S A G E S   * * * * *
 5770WDS V7R2M0  140418   IBM ILE C compiler      noxdb2.c                           DKSRV206    11-01-22 18:00:09 Page          76
                                        * * * * *   M E S S A G E   S U M M A R Y   * * * * *
       Total      Informational(00)      Warning(10)      Error(20)      Severe Error(30)      Unrecoverable Error(40)
         1              0                    0               0                  1                        0
                                * * * * *   E N D   O F   M E S S A G E   S U M M A R Y   * * * * *
 Module NOXDB2 is not created because statement errors occurred.
                                    * * * * *   E N D   O F   C O M P I L A T I O N   * * * * *
